AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Memoru LIFF - Backend API and DynamoDB Tables

Globals:
  Function:
    Timeout: 30
    MemorySize: 256
    Runtime: python3.12
    Architectures:
      - arm64
    Environment:
      Variables:
        ENVIRONMENT: !Ref Environment
        USERS_TABLE: !Ref UsersTable
        CARDS_TABLE: !Ref CardsTable
        REVIEWS_TABLE: !Ref ReviewsTable
        LOG_LEVEL: !If [IsProd, INFO, DEBUG]

Parameters:
  Environment:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging
      - prod
    Description: Environment name

  KeycloakIssuer:
    Type: String
    Default: https://keycloak.example.com/realms/memoru
    Description: Keycloak OIDC Issuer URL

  LINEChannelAccessToken:
    Type: String
    Default: ''
    NoEcho: true
    Description: LINE Channel Access Token (stored in Secrets Manager)

  BedrockModelId:
    Type: String
    Default: anthropic.claude-3-haiku-20240307-v1:0
    Description: Amazon Bedrock model ID for AI card generation

Conditions:
  IsProd: !Equals [!Ref Environment, prod]

Resources:
  #============================================================
  # DynamoDB Tables
  #============================================================

  # Users Table
  UsersTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub memoru-users-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: line_user_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: line_user_id-index
          KeySchema:
            - AttributeName: line_user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      DeletionProtectionEnabled: !If [IsProd, true, false]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: memoru

  # Cards Table
  CardsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub memoru-cards-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: card_id
          AttributeType: S
        - AttributeName: next_review_at
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
        - AttributeName: card_id
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: user_id-due-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: next_review_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      DeletionProtectionEnabled: !If [IsProd, true, false]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: memoru

  # Reviews Table
  ReviewsTable:
    Type: AWS::DynamoDB::Table
    DeletionPolicy: Retain
    UpdateReplacePolicy: Retain
    Properties:
      TableName: !Sub memoru-reviews-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: card_id
          AttributeType: S
        - AttributeName: reviewed_at
          AttributeType: S
        - AttributeName: user_id
          AttributeType: S
      KeySchema:
        - AttributeName: card_id
          KeyType: HASH
        - AttributeName: reviewed_at
          KeyType: RANGE
      GlobalSecondaryIndexes:
        - IndexName: user_id-reviewed_at-index
          KeySchema:
            - AttributeName: user_id
              KeyType: HASH
            - AttributeName: reviewed_at
              KeyType: RANGE
          Projection:
            ProjectionType: ALL
      TimeToLiveSpecification:
        AttributeName: expires_at
        Enabled: true
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
      SSESpecification:
        SSEEnabled: true
        SSEType: KMS
      DeletionProtectionEnabled: !If [IsProd, true, false]
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: memoru

  #============================================================
  # API Gateway (HTTP API)
  #============================================================

  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName: !Ref Environment
      CorsConfiguration:
        AllowOrigins:
          - https://liff.line.me
          - https://liff.example.com
          - http://localhost:5173
          - http://localhost:3000
        AllowHeaders:
          - Content-Type
          - Authorization
          - X-Amz-Date
          - X-Api-Key
          - X-Amz-Security-Token
        AllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
        AllowCredentials: true
        MaxAge: 3600
      Auth:
        DefaultAuthorizer: JwtAuthorizer
        Authorizers:
          JwtAuthorizer:
            AuthorizationScopes:
              - openid
              - profile
            IdentitySource: $request.header.Authorization
            JwtConfiguration:
              issuer: !Ref KeycloakIssuer
              audience:
                - liff-client
      Tags:
        Environment: !Ref Environment
        Application: memoru

  #============================================================
  # Lambda Functions
  #============================================================

  # Main API Function
  ApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub memoru-api-${Environment}
      CodeUri: src/
      Handler: api.handler.handler
      Description: Main API handler for Memoru LIFF application
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CardsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ReviewsTable
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - bedrock:InvokeModel
              Resource: !Sub arn:aws:bedrock:${AWS::Region}::foundation-model/${BedrockModelId}
      Environment:
        Variables:
          KEYCLOAK_ISSUER: !Ref KeycloakIssuer
          BEDROCK_MODEL_ID: !Ref BedrockModelId
      Events:
        # User endpoints
        GetUser:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /users/me
            Method: GET
        UpdateUser:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /users/me/settings
            Method: PUT
        LinkLine:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /users/link-line
            Method: POST
        UnlinkLine:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /users/me/unlink-line
            Method: POST
        # Card endpoints
        ListCards:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /cards
            Method: GET
        CreateCard:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /cards
            Method: POST
        GetCard:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /cards/{cardId}
            Method: GET
        UpdateCard:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /cards/{cardId}
            Method: PUT
        DeleteCard:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /cards/{cardId}
            Method: DELETE
        # Review endpoints
        GetDueCards:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /cards/due
            Method: GET
        SubmitReview:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /reviews/{cardId}
            Method: POST
        GetReviewStats:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /reviews/stats
            Method: GET
        # AI Generation endpoint
        GenerateCards:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /cards/generate
            Method: POST
      Tags:
        Environment: !Ref Environment
        Application: memoru

  # LINE Webhook Function
  LineWebhookFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub memoru-line-webhook-${Environment}
      CodeUri: src/
      Handler: webhook.line_handler.handler
      Description: LINE Messaging API webhook handler
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CardsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref ReviewsTable
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:memoru-${Environment}-line-*
      Environment:
        Variables:
          LINE_CHANNEL_SECRET_ARN: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:memoru-${Environment}-line-credentials
      Events:
        LineWebhook:
          Type: HttpApi
          Properties:
            ApiId: !Ref HttpApi
            Path: /webhook/line
            Method: POST
            Auth:
              Authorizer: NONE
      Tags:
        Environment: !Ref Environment
        Application: memoru

  # Due Push Job Function (Scheduled)
  DuePushJobFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub memoru-due-push-${Environment}
      CodeUri: src/
      Handler: jobs.due_push_handler.handler
      Description: Scheduled job to send review reminders via LINE
      Timeout: 300
      Policies:
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref CardsTable
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - dynamodb:UpdateItem
              Resource: !GetAtt UsersTable.Arn
        - Version: '2012-10-17'
          Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:memoru-${Environment}-line-*
      Environment:
        Variables:
          LINE_CHANNEL_SECRET_ARN: !Sub arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:memoru-${Environment}-line-credentials
      Events:
        ScheduleRule:
          Type: Schedule
          Properties:
            Schedule: rate(5 minutes)
            Description: Check for users with due cards every 5 minutes (notification time check is done in Lambda)
            Enabled: !If [IsProd, true, false]
      Tags:
        Environment: !Ref Environment
        Application: memoru

  #============================================================
  # CloudWatch Logs - LogGroups with Retention
  #============================================================

  # API Function LogGroup
  ApiFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${ApiFunction}"
      RetentionInDays: !If [IsProd, 90, 14]

  # LINE Webhook Function LogGroup
  LineWebhookFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${LineWebhookFunction}"
      RetentionInDays: !If [IsProd, 90, 14]

  # Due Push Job Function LogGroup
  DuePushJobFunctionLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${DuePushJobFunction}"
      RetentionInDays: !If [IsProd, 90, 14]

  #============================================================
  # CloudWatch Monitoring (Production Only)
  #============================================================

  # SNS Topic for Alerts
  AlertSNSTopic:
    Type: AWS::SNS::Topic
    Condition: IsProd
    Properties:
      TopicName: !Sub memoru-${Environment}-alerts
      DisplayName: Memoru LIFF Alerts
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Application
          Value: memoru

  # Lambda Error Alarm
  LambdaErrorAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsProd
    Properties:
      AlarmName: !Sub memoru-${Environment}-lambda-errors
      AlarmDescription: Lambda function error rate exceeds threshold
      MetricName: Errors
      Namespace: AWS/Lambda
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 5
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: FunctionName
          Value: !Ref ApiFunction
      AlarmActions:
        - !Ref AlertSNSTopic
      TreatMissingData: notBreaching

  # API Gateway 5xx Error Alarm
  ApiGateway5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsProd
    Properties:
      AlarmName: !Sub memoru-${Environment}-api-5xx-errors
      AlarmDescription: API Gateway 5xx error rate exceeds threshold
      MetricName: 5xx
      Namespace: AWS/ApiGateway
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 2
      Threshold: 10
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: ApiId
          Value: !Ref HttpApi
      AlarmActions:
        - !Ref AlertSNSTopic
      TreatMissingData: notBreaching

  # DynamoDB Throttle Alarm
  DynamoDBThrottleAlarm:
    Type: AWS::CloudWatch::Alarm
    Condition: IsProd
    Properties:
      AlarmName: !Sub memoru-${Environment}-dynamodb-throttle
      AlarmDescription: DynamoDB throttling detected
      MetricName: ThrottledRequests
      Namespace: AWS/DynamoDB
      Statistic: Sum
      Period: 300
      EvaluationPeriods: 1
      Threshold: 1
      ComparisonOperator: GreaterThanThreshold
      Dimensions:
        - Name: TableName
          Value: !Ref CardsTable
      AlarmActions:
        - !Ref AlertSNSTopic
      TreatMissingData: notBreaching

  # CloudWatch Dashboard
  MonitoringDashboard:
    Type: AWS::CloudWatch::Dashboard
    Condition: IsProd
    Properties:
      DashboardName: !Sub memoru-${Environment}-dashboard
      DashboardBody: !Sub |
        {
          "widgets": [
            {
              "type": "metric",
              "x": 0,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Lambda Invocations & Errors",
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${ApiFunction}", {"color": "#2ca02c"}],
                  [".", "Errors", ".", ".", {"color": "#d62728"}],
                  [".", "Invocations", "FunctionName", "${LineWebhookFunction}", {"color": "#1f77b4"}],
                  [".", "Errors", ".", ".", {"color": "#ff7f0e"}]
                ],
                "region": "${AWS::Region}",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 0,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "Lambda Duration",
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${ApiFunction}", {"stat": "p50"}],
                  ["...", {"stat": "p90"}],
                  ["...", {"stat": "p99"}]
                ],
                "region": "${AWS::Region}",
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "API Gateway Requests",
                "metrics": [
                  ["AWS/ApiGateway", "Count", "ApiId", "${HttpApi}", {"color": "#2ca02c"}],
                  [".", "5xx", ".", ".", {"color": "#d62728"}],
                  [".", "4xx", ".", ".", {"color": "#ff7f0e"}]
                ],
                "region": "${AWS::Region}",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 12,
              "y": 6,
              "width": 12,
              "height": 6,
              "properties": {
                "title": "API Gateway Latency",
                "metrics": [
                  ["AWS/ApiGateway", "Latency", "ApiId", "${HttpApi}", {"stat": "p50"}],
                  ["...", {"stat": "p90"}],
                  ["...", {"stat": "p99"}]
                ],
                "region": "${AWS::Region}",
                "period": 300
              }
            },
            {
              "type": "metric",
              "x": 0,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "DynamoDB - Users Table",
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${UsersTable}"],
                  [".", "ConsumedWriteCapacityUnits", ".", "."]
                ],
                "region": "${AWS::Region}",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 8,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "DynamoDB - Cards Table",
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${CardsTable}"],
                  [".", "ConsumedWriteCapacityUnits", ".", "."]
                ],
                "region": "${AWS::Region}",
                "period": 300,
                "stat": "Sum"
              }
            },
            {
              "type": "metric",
              "x": 16,
              "y": 12,
              "width": 8,
              "height": 6,
              "properties": {
                "title": "DynamoDB - Reviews Table",
                "metrics": [
                  ["AWS/DynamoDB", "ConsumedReadCapacityUnits", "TableName", "${ReviewsTable}"],
                  [".", "ConsumedWriteCapacityUnits", ".", "."]
                ],
                "region": "${AWS::Region}",
                "period": 300,
                "stat": "Sum"
              }
            }
          ]
        }

Outputs:
  # DynamoDB Tables
  UsersTableName:
    Description: Users table name
    Value: !Ref UsersTable
    Export:
      Name: !Sub memoru-${Environment}-users-table

  UsersTableArn:
    Description: Users table ARN
    Value: !GetAtt UsersTable.Arn
    Export:
      Name: !Sub memoru-${Environment}-users-table-arn

  CardsTableName:
    Description: Cards table name
    Value: !Ref CardsTable
    Export:
      Name: !Sub memoru-${Environment}-cards-table

  CardsTableArn:
    Description: Cards table ARN
    Value: !GetAtt CardsTable.Arn
    Export:
      Name: !Sub memoru-${Environment}-cards-table-arn

  ReviewsTableName:
    Description: Reviews table name
    Value: !Ref ReviewsTable
    Export:
      Name: !Sub memoru-${Environment}-reviews-table

  ReviewsTableArn:
    Description: Reviews table ARN
    Value: !GetAtt ReviewsTable.Arn
    Export:
      Name: !Sub memoru-${Environment}-reviews-table-arn

  # API Gateway
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub https://${HttpApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}
    Export:
      Name: !Sub memoru-${Environment}-api-endpoint

  # Lambda Functions
  ApiFunctionArn:
    Description: API Lambda function ARN
    Value: !GetAtt ApiFunction.Arn
    Export:
      Name: !Sub memoru-${Environment}-api-function-arn

  LineWebhookFunctionArn:
    Description: LINE Webhook Lambda function ARN
    Value: !GetAtt LineWebhookFunction.Arn
    Export:
      Name: !Sub memoru-${Environment}-line-webhook-function-arn

  # Monitoring (Production Only)
  AlertSNSTopicArn:
    Condition: IsProd
    Description: SNS Topic ARN for alerts
    Value: !Ref AlertSNSTopic
    Export:
      Name: !Sub memoru-${Environment}-alerts-topic-arn

  DashboardName:
    Condition: IsProd
    Description: CloudWatch Dashboard name
    Value: !Sub memoru-${Environment}-dashboard
