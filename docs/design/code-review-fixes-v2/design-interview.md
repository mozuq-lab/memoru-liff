# code-review-fixes-v2 設計ヒアリング記録

**作成日**: 2026-02-17
**ヒアリング実施**: step4 既存情報ベースの差分ヒアリング

## ヒアリング目的

第2回コードレビュー（2026-02-16）の Critical/High 修正に対し、技術的な実装方針・DB スキーマ変更・外部 API 連携方式を明確化するためのヒアリングを実施。

## 質問と回答

### Q1: 設計規模の確認

**質問日時**: 2026-02-17
**カテゴリ**: アーキテクチャ
**背景**: 8件の修正に対する設計文書の詳細度を決定する必要があった。

**回答**: フル設計（推奨）

**信頼性への影響**:
- 全修正項目について詳細なアーキテクチャ設計、データフロー、API 仕様を作成する方針が確定

---

### Q2: タイムゾーン管理方式

**質問日時**: 2026-02-17
**カテゴリ**: データモデル
**背景**: H-03（通知時刻/タイムゾーン判定）で、ユーザーごとのローカル時刻を算出するためにタイムゾーン情報が必要。固定値（Asia/Tokyo）とするか、DB に属性を追加して将来の多地域対応に備えるかの選択。

**質問**: H-03: 通知時刻判定で、ユーザーのタイムゾーンをどう管理しますか？
**回答**: DBに属性追加

**信頼性への影響**:
- users テーブルに `timezone` 属性追加が設計に含まれることが確定（信頼性 🔵）
- 既存の users テーブル設計への変更が明確化
- デフォルト値 `Asia/Tokyo` で既存レコードとの後方互換性を保証

---

### Q3: LINE IDトークン検証方式

**質問日時**: 2026-02-17
**カテゴリ**: セキュリティ / 技術選択
**背景**: H-01（LINE 連携本人性検証）で、ID トークンの検証方式として (a) LINE API 呼び出しと (b) PyJWT によるローカル検証の2方式がある。(a) はシンプルだが外部 API 依存、(b) は鍵管理が必要だがオフライン検証可能。

**質問**: H-01: LINE IDトークン検証の実装方式
**回答**: LINE API呼び出し（推奨）

**信頼性への影響**:
- line_service.py に `verify_id_token()` メソッドの追加が確定（信頼性 🔵）
- LINE API `/oauth2/v2.1/verify` エンドポイントの使用が確定
- PyJWT や公開鍵管理は不要（設計のシンプル化）
- 外部 API 呼び出しによるレイテンシ追加（100-300ms 程度）を許容

---

### Q4: コードベース分析の要否

**質問日時**: 2026-02-17
**カテゴリ**: アーキテクチャ
**背景**: 要件定義フェーズで既にコード分析を実施済み。設計に影響する追加調査が必要かを確認。

**質問**: 既存実装の詳細分析が必要ですか？
**回答**: 不要

**信頼性への影響**:
- 要件定義フェーズの分析結果をそのまま設計に活用

---

## ヒアリング結果サマリー

### 確認できた事項

- 設計規模: フル設計（architecture.md, dataflow.md, api-endpoints.md を作成）
- タイムゾーン: users テーブルに `timezone` 属性追加（デフォルト: Asia/Tokyo）
- LINE IDトークン: LINE API `/oauth2/v2.1/verify` で検証
- 追加のコード分析: 不要（要件定義フェーズの分析で十分）

### 設計方針の決定事項

1. **DB スキーマ**: users テーブルに `timezone` 属性を追加
2. **LINE 検証**: LINE API 外部呼び出し方式（シンプルさ優先）
3. **httpx 統一**: requests の API と互換性があるため、import 文の変更が主な修正
4. **設定値統一**: 3箇所の設定値（環境変数名、クライアントID）を一括修正

### 残課題

- LINE API の `/oauth2/v2.1/verify` のレスポンス形式の詳細は実装時に確認
- `should_notify()` の日付境界テストは実装時に追加

### 信頼性レベル分布

**ヒアリング前**:
- 🔵 青信号: 18件
- 🟡 黄信号: 6件
- 🔴 赤信号: 0件

**ヒアリング後**:
- 🔵 青信号: 22件 (+4)
- 🟡 黄信号: 2件 (-4)
- 🔴 赤信号: 0件 (±0)

## 関連文書

- **アーキテクチャ設計**: [architecture.md](architecture.md)
- **データフロー**: [dataflow.md](dataflow.md)
- **API 仕様**: [api-endpoints.md](api-endpoints.md)
- **要件定義**: [requirements.md](../../spec/code-review-fixes-v2/requirements.md)
