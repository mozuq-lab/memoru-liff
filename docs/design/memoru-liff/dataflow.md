# memoru-liff データフロー図

**作成日**: 2026-01-05
**関連アーキテクチャ**: [architecture.md](architecture.md)
**関連要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md)

**【信頼性レベル凡例】**:

- 🔵 **青信号**: EARS要件定義書・設計文書・ユーザヒアリングを参考にした確実なフロー
- 🟡 **黄信号**: EARS要件定義書・設計文書・ユーザヒアリングから妥当な推測によるフロー
- 🔴 **赤信号**: EARS要件定義書・設計文書・ユーザヒアリングにない推測によるフロー

---

## システム全体のデータフロー 🔵

**信頼性**: 🔵 *PRD・要件定義より*

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           ユーザー (LINEアプリ)                              │
└─────────────────────────────────────────────────────────────────────────────┘
                    │                              │
                    │ LIFF WebView                 │ LINE Messaging
                    ▼                              ▼
┌───────────────────────────────┐    ┌────────────────────────────────────────┐
│         CloudFront            │    │           LINE Platform                 │
│    (LIFF静的ホスティング)       │    │  (Messaging API / LIFF SDK)            │
└───────────────────────────────┘    └────────────────────────────────────────┘
                    │                              │
                    │ HTTPS                        │ Webhook
                    ▼                              ▼
┌───────────────────────────────┐    ┌────────────────────────────────────────┐
│        API Gateway            │    │         API Gateway                     │
│     (REST API + JWT検証)       │    │       (Webhook Endpoint)               │
└───────────────────────────────┘    └────────────────────────────────────────┘
                    │                              │
                    ▼                              ▼
┌───────────────────────────────┐    ┌────────────────────────────────────────┐
│      Lambda: api-main         │    │      Lambda: line-webhook              │
│   (カードCRUD, AI生成等)        │    │   (署名検証, Postback処理)              │
└───────────────────────────────┘    └────────────────────────────────────────┘
                    │                              │
                    ├──────────────┬───────────────┤
                    ▼              ▼               ▼
┌─────────────────────────┐ ┌─────────────┐ ┌─────────────────────────────────┐
│       DynamoDB          │ │   Bedrock   │ │     EventBridge Scheduler       │
│  (users/cards/reviews)  │ │  (AI生成)   │ │    (定期通知トリガー)             │
└─────────────────────────┘ └─────────────┘ └─────────────────────────────────┘
                                                       │
                                                       ▼
                                           ┌──────────────────────┐
                                           │ Lambda: due-push-job │
                                           │   (復習通知送信)       │
                                           └──────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                         Keycloak (ECS/Fargate)                              │
│                    認証フロー (OIDC + PKCE)                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 主要機能のデータフロー

### 1. 認証フロー: Keycloak OIDC ログイン 🔵

**信頼性**: 🔵 *PRD第3章・要件定義REQ-001, REQ-002より*

**関連要件**: REQ-001, REQ-002, REQ-003, REQ-101, REQ-102

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  ユーザー  │     │   LIFF   │     │ Keycloak │     │ LINE IdP │     │ Backend  │
│ (LINE内)  │     │ (React)  │     │(ECS/ALB) │     │          │     │(Lambda)  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 1. LIFFアクセス │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 2. 認証状態確認  │                │                │
     │                │ (oidc-client-ts)│                │                │
     │                │                │                │                │
     │                │ 3. Authorization Request (PKCE) │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 4. LINE IdP   │                │
     │                │                │   リダイレクト  │                │
     │                │                │───────────────>│                │
     │                │                │                │                │
     │ 5. LINEログイン │                │                │                │
     │<────────────────────────────────────────────────│                │
     │                │                │                │                │
     │ 6. 認証情報     │                │                │                │
     │─────────────────────────────────────────────────>│                │
     │                │                │                │                │
     │                │                │ 7. ID Token   │                │
     │                │                │<───────────────│                │
     │                │                │                │                │
     │                │ 8. Authorization Code           │                │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │                │ 9. Token Request (code + verifier)               │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │ 10. JWT (access_token, refresh_token)            │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │                │ 11. JWT保存     │                │                │
     │                │ (localStorage) │                │                │
     │                │                │                │                │
     │ 12. ホーム画面  │                │                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
```

**詳細ステップ**:

1. ユーザーがLINEアプリ内でLIFFを開く
2. フロントエンド（oidc-client-ts）が認証状態を確認
3. 未認証の場合、PKCE code_verifier/code_challenge を生成し、Keycloakへリダイレクト
4. KeycloakがLINE Identity Providerにリダイレクト
5. ユーザーがLINEでログイン
6. LINEがKeycloakに認証情報を返却
7. KeycloakがID Tokenを生成
8. KeycloakがAuthorization CodeをLIFFにリダイレクト
9. LIFFがcode + code_verifierでトークンリクエスト
10. Keycloakがaccess_token, refresh_tokenを発行
11. JWTをlocalStorageに保存
12. ホーム画面を表示

---

### 2. LINE連携フロー 🔵

**信頼性**: 🔵 *PRD第2章・要件定義REQ-003, REQ-202より*

**関連要件**: REQ-003, REQ-202

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  ユーザー  │     │   LIFF   │     │ LIFF SDK │     │ Backend  │
│          │     │ (React)  │     │          │     │(Lambda)  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 1. LINE連携    │                │                │
     │    ボタンタップ │                │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ 2. liff.getProfile()            │
     │                │───────────────>│                │
     │                │                │                │
     │                │ 3. userId, displayName          │
     │                │<───────────────│                │
     │                │                │                │
     │                │ 4. POST /users/link-line        │
     │                │    { line_user_id }             │
     │                │───────────────────────────────>│
     │                │                │                │
     │                │                │                │ 5. usersテーブル
     │                │                │                │    line_user_id更新
     │                │                │                │
     │                │ 6. 200 OK                       │
     │                │<───────────────────────────────│
     │                │                │                │
     │ 7. 連携完了表示 │                │                │
     │<───────────────│                │                │
     │                │                │                │
```

**詳細ステップ**:

1. ユーザーが「LINE連携」ボタンをタップ
2. LIFF SDKの `liff.getProfile()` を呼び出し
3. LINEユーザーID、表示名を取得
4. バックエンドAPIに `line_user_id` を送信
5. DynamoDB `users` テーブルの `line_user_id` を更新
6. 成功レスポンスを返却
7. 連携完了メッセージを表示

---

### 3. AIカード生成フロー 🔵

**信頼性**: 🔵 *PRD第2章・要件定義REQ-021, REQ-022, REQ-023より*

**関連要件**: REQ-021, REQ-022, REQ-023, REQ-024, REQ-012

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  ユーザー  │     │   LIFF   │     │ Backend  │     │ Bedrock  │     │ DynamoDB │
│          │     │ (React)  │     │(Lambda)  │     │(Claude)  │     │          │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 1. テキスト入力 │                │                │                │
     │   (≤2,000文字) │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 2. POST /cards/generate         │                │
     │                │    { text, user_id }            │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 3. カード数確認 │                │
     │                │                │───────────────────────────────>│
     │                │                │                │                │
     │                │                │ 4. count < 2000 │               │
     │                │                │<───────────────────────────────│
     │                │                │                │                │
     │                │                │ 5. InvokeModel │                │
     │                │                │   (プロンプト)  │                │
     │                │                │───────────────>│                │
     │                │                │                │                │
     │                │                │ 6. カード候補   │                │
     │                │                │   [{front, back}...]            │
     │                │                │<───────────────│                │
     │                │                │                │                │
     │                │ 7. カード候補一覧                │                │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │ 8. カード表示   │                │                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
     │ 9. 編集・選択   │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 10. POST /cards                 │                │
     │                │     [{ front, back }...]        │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 11. cards, reviews作成          │
     │                │                │───────────────────────────────>│
     │                │                │                │                │
     │                │ 12. 保存完了   │                │                │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │ 13. 完了表示   │                │                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
```

**詳細ステップ**:

1. ユーザーがテキストを入力（最大2,000文字）
2. バックエンドにAI生成リクエスト送信
3. DynamoDBで現在のカード数を確認
4. カード数が2,000枚未満であることを確認
5. Amazon Bedrock（Claude）にカード生成プロンプトを送信
6. AI生成されたカード候補を受信
7. フロントエンドにカード候補を返却
8. 生成されたカードをユーザーに表示
9. ユーザーがカードを編集・選択
10. 選択したカードを保存リクエスト
11. `cards` と `reviews`（初期SRSパラメータ）を作成
12. 保存完了レスポンスを返却
13. 完了メッセージを表示

---

### 4. LINE復習通知フロー 🔵

**信頼性**: 🔵 *PRD第2章・要件定義REQ-041, REQ-042, REQ-043より*

**関連要件**: REQ-041, REQ-042, REQ-043, REQ-201, REQ-202

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│EventBridge│    │due-push-job│    │ DynamoDB │     │ LINE API │     │  ユーザー  │
│Scheduler │     │ (Lambda) │     │          │     │          │     │ (LINE)   │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 1. 定期起動     │                │                │                │
     │  (5分間隔)      │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 2. 復習対象クエリ                │                │
     │                │   due ≤ now AND                 │                │
     │                │   通知時間 = 現在時              │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │ 3. 対象ユーザー・カード一覧      │                │
     │                │<───────────────│                │                │
     │                │                │                │                │
     │                │ 4. ユーザーごとに集計            │                │
     │                │   (line_user_id, count)         │                │
     │                │                │                │                │
     │                │ 5. Flex Message Push            │                │
     │                │  「N枚のカードが復習待ちです」    │                │
     │                │───────────────────────────────>│                │
     │                │                │                │                │
     │                │                │                │ 6. Push通知    │
     │                │                │                │───────────────>│
     │                │                │                │                │
     │                │                │                │ 7. 通知表示    │
     │                │                │                │  「復習開始」   │
     │                │                │                │   ボタン       │
     │                │                │                │                │
```

**詳細ステップ**:

1. EventBridge Schedulerが5分間隔でLambdaを起動
2. DynamoDBに復習対象（due ≤ 現在時刻、通知時間一致）をクエリ
3. 対象ユーザーとカード一覧を取得
4. ユーザーごとに復習カード数を集計
5. LINE Messaging APIでFlex Messageをプッシュ
6. LINEプラットフォームがユーザーに通知送信
7. ユーザーのLINEに「復習開始」ボタン付きで通知表示

---

### 5. LINE復習回答フロー 🔵

**信頼性**: 🔵 *PRD第2章・要件定義REQ-051, REQ-052, REQ-032より*

**関連要件**: REQ-051, REQ-052, REQ-031, REQ-032, REQ-033, REQ-034

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│  ユーザー  │     │ LINE API │     │ Webhook  │     │ Backend  │     │ DynamoDB │
│ (LINE)   │     │          │     │(Lambda)  │     │ (SRS)    │     │          │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │                │
     │ 1. 復習開始    │                │                │                │
     │   ボタンタップ │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 2. Postback    │                │                │
     │                │  action=start  │                │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 3. 署名検証    │                │
     │                │                │                │                │
     │                │                │ 4. line_user_id │               │
     │                │                │   → user_id    │                │
     │                │                │───────────────────────────────>│
     │                │                │                │                │
     │                │                │ 5. 復習カード取得                │
     │                │                │<───────────────────────────────│
     │                │                │                │                │
     │ 6. カード表面  │ Flex Message   │                │                │
     │   (問題)       │<───────────────│                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
     │ 7. 答えを見る  │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 8. Postback    │                │                │
     │                │  action=reveal │                │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │ 9. カード裏面  │ Flex Message   │                │                │
     │  + 採点ボタン  │<───────────────│                │                │
     │   (0-5)       │                │                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
     │ 10. 採点      │                │                │                │
     │    (grade=4)  │                │                │                │
     │───────────────>│                │                │                │
     │                │                │                │                │
     │                │ 11. Postback   │                │                │
     │                │  action=grade  │                │                │
     │                │  grade=4       │                │                │
     │                │───────────────>│                │                │
     │                │                │                │                │
     │                │                │ 12. SM-2計算   │                │
     │                │                │───────────────>│                │
     │                │                │                │                │
     │                │                │                │ 13. reviews更新 │
     │                │                │                │   interval,    │
     │                │                │                │   ease_factor, │
     │                │                │                │   due          │
     │                │                │                │───────────────>│
     │                │                │                │                │
     │ 14. 次のカード │ Flex Message   │                │                │
     │  or 完了通知   │<───────────────│                │                │
     │<───────────────│                │                │                │
     │                │                │                │                │
```

**詳細ステップ**:

1. ユーザーが「復習開始」ボタンをタップ
2. LINE PlatformがPostbackイベントを送信
3. Lambda（line-webhook）がX-Line-Signature署名を検証
4. `line_user_id` から `user_id` を特定
5. 復習対象カードを取得
6. カード表面（問題）をFlex Messageで表示
7. ユーザーが「答えを見る」をタップ
8. Postbackでカード裏面表示リクエスト
9. カード裏面 + 6段階採点ボタン（0-5）を表示
10. ユーザーが自己採点（例: grade=4）
11. Postbackで採点結果を送信
12. SM-2アルゴリズムでパラメータ計算
13. `reviews` テーブルを更新（interval, ease_factor, repetitions, due）
14. 次のカードを表示、または復習完了通知

---

## SM-2アルゴリズム処理フロー 🔵

**信頼性**: 🔵 *SM-2アルゴリズム仕様・要件定義REQ-031より*

**関連要件**: REQ-031, REQ-032, REQ-033, REQ-034

```
┌─────────────────────────────────────────────────────────────────────┐
│                        SM-2 パラメータ更新                           │
└─────────────────────────────────────────────────────────────────────┘

入力: grade (0-5), 現在のパラメータ (interval, ease_factor, repetitions)

┌─────────┐
│ grade   │
│ 入力    │
└────┬────┘
     │
     ▼
┌─────────────────────┐
│ grade < 3 ?         │
└────┬───────────┬────┘
     │Yes        │No
     ▼           ▼
┌─────────────┐  ┌─────────────────────────────────────────────┐
│ リセット     │  │ ease_factor更新                              │
│ repetitions │  │ EF' = EF + (0.1 - (5-grade)*(0.08+(5-grade)│
│ = 0         │  │         *0.02))                             │
│ interval    │  │ EF = max(1.3, EF')  ← 下限1.3               │
│ = 1         │  └────────────────────────┬────────────────────┘
└──────┬──────┘                           │
       │                                  ▼
       │                    ┌─────────────────────────────────┐
       │                    │ interval更新                     │
       │                    │ if repetitions == 0: interval=1 │
       │                    │ if repetitions == 1: interval=6 │
       │                    │ else: interval = interval * EF  │
       │                    └────────────────────┬────────────┘
       │                                         │
       │                                         ▼
       │                           ┌─────────────────────────┐
       │                           │ repetitions++           │
       │                           └────────────┬────────────┘
       │                                        │
       ▼                                        ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    due = now + interval days                        │
└─────────────────────────────────────────────────────────────────────┘
```

**採点基準 (grade)**:

| Grade | 意味 | 動作 |
|-------|------|------|
| 0 | 全く覚えていない | リセット（interval=1, repetitions=0） |
| 1 | 間違えた（見覚えはある） | リセット |
| 2 | 間違えた（答えは見て思い出した） | リセット |
| 3 | 正解（かなり考えた） | 継続（EF微減） |
| 4 | 正解（少し考えた） | 継続（EF維持〜微増） |
| 5 | 完璧に覚えている | 継続（EF増加） |

---

## エラーハンドリングフロー 🟡

**信頼性**: 🟡 *要件定義REQ-111, REQ-112から妥当な推測*

### AI生成エラー 🔵

**信頼性**: 🔵 *要件定義REQ-111・ヒアリングより*

```
┌──────────┐     ┌──────────┐     ┌──────────┐     ┌──────────┐
│   LIFF   │     │ Backend  │     │ Bedrock  │     │  ユーザー  │
└────┬─────┘     └────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │                │
     │ 生成リクエスト  │                │                │
     │───────────────>│                │                │
     │                │                │                │
     │                │ InvokeModel    │                │
     │                │───────────────>│                │
     │                │                │                │
     │                │ タイムアウト    │                │
     │                │ or エラー       │                │
     │                │<───────────────│                │
     │                │                │                │
     │ 500 エラー      │                │                │
     │ { code: "AI_GENERATION_FAILED" }│                │
     │<───────────────│                │                │
     │                │                │                │
     │                │                │ エラー表示     │
     │                │                │ 「再度お試し   │
     │                │                │  ください」    │
     │──────────────────────────────────────────────────>│
     │                │                │                │
```

### LINE Push失敗 🟡

**信頼性**: 🟡 *要件定義REQ-112から妥当な推測*

```
┌──────────┐     ┌──────────┐     ┌──────────┐
│due-push-job│    │ LINE API │     │CloudWatch│
└────┬─────┘     └────┬─────┘     └────┬─────┘
     │                │                │
     │ Push Message   │                │
     │───────────────>│                │
     │                │                │
     │ 401/403 Error  │                │
     │ (トークン無効)  │                │
     │<───────────────│                │
     │                │                │
     │ エラーログ出力                   │
     │───────────────────────────────>│
     │                │                │
     │ 次のユーザーへ                   │
     │ 処理継続       │                │
     │                │                │
```

---

## 状態管理フロー

### フロントエンド状態管理 🔵

**信頼性**: 🔵 *アーキテクチャ設計より（React Context）*

```
┌─────────────────────────────────────────────────────────────────────┐
│                     React Context 状態管理                          │
└─────────────────────────────────────────────────────────────────────┘

AuthContext:
┌─────────┐     ┌─────────────┐     ┌──────────┐     ┌──────────┐
│ 未認証   │────>│ ログイン中   │────>│ 認証済み  │────>│ ログアウト │
│         │     │ (リダイレクト)│     │ (JWT保持) │     │ (初期化)   │
└─────────┘     └─────────────┘     └──────────┘     └──────────┘
     ▲                                    │                │
     │                                    │ トークン期限切れ │
     │                                    ▼                │
     │                              ┌──────────┐          │
     │                              │リフレッシュ│          │
     │                              │ 試行中    │          │
     │                              └─────┬────┘          │
     │                                    │失敗            │
     └────────────────────────────────────┴────────────────┘

CardsContext:
┌─────────┐     ┌─────────────┐     ┌──────────┐
│ 初期状態 │────>│ ローディング │────>│ データ取得 │
│ (空)    │     │             │     │ 完了      │
└─────────┘     └─────────────┘     └──────────┘
                      │                   │
                      │エラー              │更新
                      ▼                   ▼
                ┌──────────┐        ┌──────────┐
                │ エラー状態 │<──────│ 更新中   │
                └──────────┘        └──────────┘
```

---

## データ整合性の保証 🟡

**信頼性**: 🟡 *DynamoDB特性から妥当な推測*

### カード作成時のトランザクション 🟡

**信頼性**: 🟡 *DynamoDB TransactWriteItemsから妥当な推測*

```
┌─────────────────────────────────────────────────────────────────────┐
│                  DynamoDB TransactWriteItems                        │
│                                                                     │
│  1. ConditionCheck: cards count < 2000                              │
│  2. Put: cards テーブルに新規カード                                   │
│  3. Put: reviews テーブルに初期SRSパラメータ                          │
│                                                                     │
│  → 全て成功 or 全てロールバック                                       │
└─────────────────────────────────────────────────────────────────────┘
```

### 復習更新の整合性 🔵

**信頼性**: 🔵 *SM-2アルゴリズム仕様より*

- `reviews` テーブルの更新は単一アイテム操作
- `UpdateItem` で条件付き更新（楽観的ロック不要、単一ユーザー操作のため）

---

## 関連文書

- **アーキテクチャ**: [architecture.md](architecture.md)
- **API仕様**: [api-endpoints.md](api-endpoints.md)
- **DBスキーマ**: [database-schema.md](database-schema.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md)

---

## 信頼性レベルサマリー

| レベル | 件数 | 割合 |
|--------|------|------|
| 🔵 青信号 | 14件 | 82% |
| 🟡 黄信号 | 3件 | 18% |
| 🔴 赤信号 | 0件 | 0% |

**品質評価**: ✅ 高品質（青信号が80%以上）
