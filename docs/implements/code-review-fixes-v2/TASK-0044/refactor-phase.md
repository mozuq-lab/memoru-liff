# TASK-0044 Refactorãƒ•ã‚§ãƒ¼ã‚º: LINE ID ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼ + httpx çµ±ä¸€

**å®Ÿæ–½æ—¥**: 2026-02-21
**ãƒ•ã‚§ãƒ¼ã‚º**: Refactor (å“è³ªæ”¹å–„)

---

## 1. ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°æ¦‚è¦

Greenãƒ•ã‚§ãƒ¼ã‚ºã§å®Ÿè£…ã—ãŸã‚³ãƒ¼ãƒ‰ã«å¯¾ã—ã¦ã€å“è³ªãƒ»å¯èª­æ€§ãƒ»ä¿å®ˆæ€§ã®è¦³ç‚¹ã‹ã‚‰æ”¹å–„ã‚’å®Ÿæ–½ã—ãŸã€‚
æ©Ÿèƒ½çš„ãªå¤‰æ›´ã¯è¡Œã‚ãšã€å…¨ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ã—ç¶šã‘ã‚‹ã“ã¨ã‚’ç¢ºèªã—ãŸã€‚

---

## 2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

| ãƒã‚§ãƒƒã‚¯é …ç›® | è©•ä¾¡ | å‚™è€ƒ |
|-------------|------|------|
| ID ãƒˆãƒ¼ã‚¯ãƒ³ã®æ¤œè¨¼æ–¹å¼ | âœ… å®‰å…¨ | LINE API ã‚’çµŒç”±ã—ãŸã‚µãƒ¼ãƒãƒ¼å´æ¤œè¨¼ |
| Channel ID ã®ç®¡ç† | âœ… å®‰å…¨ | ç’°å¢ƒå¤‰æ•° (`LINE_CHANNEL_ID`) ã§ç®¡ç† |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚ã®æƒ…å ±æ¼æ´© | âœ… å®‰å…¨ | `LineApiError` ã§ãƒ©ãƒƒãƒ—ã—è©³ç´°ã¯å†…éƒ¨ãƒ­ã‚°ã®ã¿ |
| æœªè¨­å®šæ™‚ã®ãƒ•ã‚§ã‚¤ãƒ«ã‚»ãƒ¼ãƒ• | âœ… å®‰å…¨ | `channel_id` æœªè¨­å®šæ™‚ã«æ˜ç¤ºçš„ã‚¨ãƒ©ãƒ¼ã‚’ç™ºç”Ÿ |
| XSS/CSRF | éå¯¾è±¡ | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã®ãŸã‚ |

**ç·åˆè©•ä¾¡**: é‡å¤§ãªè„†å¼±æ€§ãªã— âœ…

---

## 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒ“ãƒ¥ãƒ¼çµæœ

| ãƒã‚§ãƒƒã‚¯é …ç›® | è©•ä¾¡ | å‚™è€ƒ |
|-------------|------|------|
| LINE API å‘¼ã³å‡ºã—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ | âœ… é©åˆ‡ | 10ç§’ã«è¨­å®š |
| ä¸è¦ãª API å‘¼ã³å‡ºã— | âœ… ãªã— | `channel_id` æœªè¨­å®šæ™‚ã¯å³åº§ã«ã‚¨ãƒ©ãƒ¼ |
| httpx åŒæœŸãƒ¢ãƒ¼ãƒ‰ | âœ… é©åˆ‡ | Lambda ç’°å¢ƒã«åˆã‚ã›ãŸé¸æŠ |

**ç·åˆè©•ä¾¡**: é‡å¤§ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹èª²é¡Œãªã— âœ…

---

## 4. å®Ÿæ–½ã—ãŸæ”¹å–„å†…å®¹

### 4.1 `backend/src/services/line_service.py` - ãƒ­ã‚¬ãƒ¼è¿½åŠ ã¨è¦³æ¸¬æ€§å‘ä¸Š

ğŸ”µ ä¿¡é ¼æ€§: é’ä¿¡å· - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã® `handler.py` ã¨åŒã˜ `aws_lambda_powertools.Logger` ãƒ‘ã‚¿ãƒ¼ãƒ³

**å¤‰æ›´å†…å®¹**:
- `aws_lambda_powertools.Logger` ã‚’ import ã—ã¦ `logger = Logger()` ã‚’è¿½åŠ 
- `verify_id_token` ã«ãƒ­ã‚®ãƒ³ã‚°ã‚’è¿½åŠ :
  - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼æ™‚: `logger.error()`
  - é200ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚: `logger.warning()` (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€)
  - `sub` ã‚¯ãƒ¬ãƒ¼ãƒ æ¬ è½æ™‚: `logger.warning()`
  - æ¤œè¨¼æˆåŠŸæ™‚: `logger.info()`
- `verify_id_token` ã®docstringã«LINE APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®èª¬æ˜ã‚’è¿½åŠ 

**æ”¹å–„å‰**:
```python
# ãƒ­ã‚¬ãƒ¼ãªã—ã€ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ãŒä¸æ˜

def verify_id_token(self, id_token: str) -> str:
    ...
    except httpx.RequestError as e:
        raise LineApiError(f"Failed to verify ID token: {e}") from e

    if response.status_code != 200:
        raise UnauthorizedError("LINE ID token verification failed")
    ...
```

**æ”¹å–„å¾Œ**:
```python
logger = Logger()

def verify_id_token(self, id_token: str) -> str:
    """Verify LIFF ID token via LINE API and return line_user_id.

    Calls https://api.line.me/oauth2/v2.1/verify with the LIFF ID token
    and LINE_CHANNEL_ID, then extracts the 'sub' claim as line_user_id.
    ...
    """
    ...
    except httpx.RequestError as e:
        logger.error(f"ID token verification request failed: {e}")
        raise LineApiError(f"Failed to verify ID token: {e}") from e

    if response.status_code != 200:
        logger.warning(f"LINE ID token verification failed: status={response.status_code}")
        raise UnauthorizedError("LINE ID token verification failed")
    ...
    logger.info("LINE ID token verified successfully")
    return line_user_id
```

---

### 4.2 `backend/src/api/handler.py` - æœªä½¿ç”¨å¤‰æ•°ã®ä¿®æ­£

ğŸ”µ ä¿¡é ¼æ€§: é’ä¿¡å· - Pythonã®æ¨™æº–lint (æœªä½¿ç”¨å¤‰æ•° `e`)

**å¤‰æ›´å†…å®¹**:
- `unlink_line` é–¢æ•°ã® `except LineNotLinkedError as e:` ã®æœªä½¿ç”¨å¤‰æ•° `e` ã‚’é™¤å»
- `except LineNotLinkedError:` ã«å¤‰æ›´

**æ”¹å–„å‰**:
```python
    except LineNotLinkedError as e:
        return Response(...)
```

**æ”¹å–„å¾Œ**:
```python
    except LineNotLinkedError:
        return Response(...)
```

---

### 4.3 `frontend/src/pages/LinkLinePage.tsx` - ãƒ˜ãƒƒãƒ€ã‚³ãƒ¡ãƒ³ãƒˆæ›´æ–°

ğŸ”µ ä¿¡é ¼æ€§: é’ä¿¡å· - å®Ÿè£…å†…å®¹ã¨ã‚³ãƒ¡ãƒ³ãƒˆã®ä¸€è‡´ã‚’ç¢ºä¿

**å¤‰æ›´å†…å®¹**:
- TASK-0044 ã§è¿½åŠ ã•ã‚ŒãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¤‰æ›´ (IDãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼) ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ãƒ˜ãƒƒãƒ€ã‚³ãƒ¡ãƒ³ãƒˆã«æ˜è¨˜
- `ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘` ã« `TASK-0044 TC-14ã€œ16` ã‚’è¿½åŠ 

**æ”¹å–„å‰**:
```typescript
/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: LINEé€£æºç”»é¢
 * ã€å®Ÿè£…æ–¹é‡ã€‘: LINEé€£æºã®çŠ¶æ…‹è¡¨ç¤ºã¨é€£æº/è§£é™¤å‡¦ç†ã‚’æä¾›
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: TASK-0019 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1ã€œ7
 * ğŸ”µ é’ä¿¡å·: user-stories.md 1.2ã‚ˆã‚Š
 */
```

**æ”¹å–„å¾Œ**:
```typescript
/**
 * ã€æ©Ÿèƒ½æ¦‚è¦ã€‘: LINEé€£æºç”»é¢
 * ã€å®Ÿè£…æ–¹é‡ã€‘: LINEé€£æºã®çŠ¶æ…‹è¡¨ç¤ºã¨é€£æº/è§£é™¤å‡¦ç†ã‚’æä¾›
 * ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã€‘: liff.getIDToken() ã§å–å¾—ã—ãŸIDãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã€
 *                  ã‚µãƒ¼ãƒãƒ¼å´ã§ LINE API ã‚’é€šã˜ã¦æ¤œè¨¼ã™ã‚‹ (TASK-0044)
 * ã€ãƒ†ã‚¹ãƒˆå¯¾å¿œã€‘: TASK-0019 ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1ã€œ7, TASK-0044 TC-14ã€œ16
 * ğŸ”µ é’ä¿¡å·: user-stories.md 1.2, REQ-V2-021ã€œ023ã‚ˆã‚Š
 */
```

---

## 5. ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ

### 5.1 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
```
226 passed in 7.18s
```
å…¨226ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ âœ…

### 5.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
```
22 passed test files, 251 tests passed
```
å…¨251ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹ âœ…

---

## 6. å“è³ªåˆ¤å®š

| è©•ä¾¡é …ç›® | çµæœ |
|---------|------|
| ãƒ†ã‚¹ãƒˆçµæœ | âœ… å…¨226(BE) + 251(FE) ãƒ†ã‚¹ãƒˆãŒç¶™ç¶šæˆåŠŸ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | âœ… é‡å¤§ãªè„†å¼±æ€§ãªã— |
| ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ | âœ… é‡å¤§ãªæ€§èƒ½èª²é¡Œãªã— |
| ãƒªãƒ•ã‚¡ã‚¯ã‚¿å“è³ª | âœ… è¦³æ¸¬æ€§å‘ä¸Šã€lintæ”¹å–„ã€ã‚³ãƒ¡ãƒ³ãƒˆæ•´åˆæ€§ç¢ºä¿ |
| ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º | âœ… å…¨ãƒ•ã‚¡ã‚¤ãƒ«500è¡Œæœªæº€ |
| ã‚³ãƒ¡ãƒ³ãƒˆå“è³ª | âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ„å›³ãŒæ˜ç¤ºã•ã‚ŒãŸã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ  |

**ç·åˆè©•ä¾¡**: âœ… é«˜å“è³ª

---

## 7. å¤‰æ›´ã—ãªã‹ã£ãŸäº‹é …ã¨ç†ç”±

| é …ç›® | ç†ç”± |
|------|------|
| `line_service.py` ã® PowerTools ä¾å­˜ (`UnauthorizedError`) | ã‚µãƒ¼ãƒ“ã‚¹å±¤ã¸ã®PowerToolsä¾å­˜é™¤å»ã¯ã‚¹ã‚³ãƒ¼ãƒ—å¤– (åˆ¥ã‚¿ã‚¹ã‚¯ã§å¯¾å¿œ) |
| `handler.py` ã® `link_line_account` ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ§‹é€  | æ©Ÿèƒ½çš„ã«æ­£ã—ãå‹•ä½œã—ã¦ãŠã‚Šã€ãƒ†ã‚¹ãƒˆã‚‚å……è¶³ã—ã¦ã„ã‚‹ |
| ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ | Refactorãƒ•ã‚§ãƒ¼ã‚ºã§ã¯å®Ÿè£…ã‚³ãƒ¼ãƒ‰ã®ã¿ã‚’æ”¹å–„ã™ã‚‹åŸå‰‡ã«å¾“ã† |
