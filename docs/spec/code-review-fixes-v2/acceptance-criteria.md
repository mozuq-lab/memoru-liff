# code-review-fixes-v2 受け入れ基準

**作成日**: 2026-02-17
**関連要件定義**: [requirements.md](requirements.md)
**関連ユーザストーリー**: [user-stories.md](user-stories.md)
**ヒアリング記録**: [interview-record.md](interview-record.md)

**【信頼性レベル凡例】**:
- 🔵 **青信号**: コードレビュー結果・既存設計文書・実装コード・ユーザヒアリングから確実な基準
- 🟡 **黄信号**: コードレビュー結果から妥当な推測による基準
- 🔴 **赤信号**: コードレビュー結果にない推測による基準

---

## REQ-V2-001〜004: APIルート統一（CR-01） 🔵

**信頼性**: 🔵 *CR-01: コード分析で3レイヤー不一致を確認。ユーザヒアリングで設計文書準拠に決定*

### Given（前提条件）
- SAM テンプレート、Lambda ハンドラー、フロントエンド API クライアントが存在する
- 設計文書 api-endpoints.md のエンドポイント定義が正（single source of truth）

### When（実行条件）
- 各エンドポイントのパス定義を設計文書に合わせて修正する

### Then（期待結果）
- SAM テンプレート、Lambda ハンドラー、フロントエンド API クライアントのパスが全て一致する
- デプロイ後に全エンドポイントが正しくルーティングされる

### テストケース

#### 正常系

- [ ] **TC-001-01**: 設定更新パス統一 🔵
  - **確認項目**: SAM `PUT /users/me/settings`、handler `PUT /users/me/settings`、api.ts `PUT /users/me/settings`
  - **期待結果**: 3レイヤーのパスが一致
  - **信頼性**: 🔵 *設計文書 api-endpoints.md L220-251 に定義*

- [ ] **TC-001-02**: レビュー送信パス統一 🔵
  - **確認項目**: SAM `POST /reviews/{cardId}`、handler `POST /reviews/<card_id>`、api.ts `POST /reviews/${cardId}`
  - **期待結果**: 3レイヤーのパスが一致（パスパラメータ形式はレイヤーごとの慣例に従う）
  - **信頼性**: 🔵 *設計文書 api-endpoints.md L555-605 に定義*

- [ ] **TC-001-03**: LINE連携パス統一 🔵
  - **確認項目**: SAM `POST /users/link-line`、handler `POST /users/link-line`、api.ts `POST /users/link-line`
  - **期待結果**: 3レイヤーのパスが一致、SAM にイベント定義が存在する
  - **信頼性**: 🔵 *設計文書 api-endpoints.md L157-190 に定義*

- [ ] **TC-001-04**: 全エンドポイントの3レイヤー整合性チェック 🔵
  - **確認項目**: 全APIエンドポイントについて SAM/handler/frontend のパスを突合
  - **期待結果**: 不一致が0件
  - **信頼性**: 🔵 *CR-01 再発防止の包括的チェック*

#### 異常系

- [ ] **TC-001-E01**: SAM に未定義のパスへのリクエスト 🟡
  - **入力**: SAM に定義されていないパスへの HTTP リクエスト
  - **期待結果**: API Gateway が 403 または 404 を返却
  - **信頼性**: 🟡 *API Gateway のデフォルト動作から推測*

---

## REQ-V2-011〜014: card_count トランザクション修正（CR-02） 🔵

**信頼性**: 🔵 *CR-02: card_service.py のコード分析で4つの問題を確認*

### Given（前提条件）
- DynamoDB に Users テーブルと Cards テーブルが存在する
- card_count はユーザーのカード数を管理する属性

### When（実行条件）
- カードの作成または削除が実行される

### Then（期待結果）
- card_count が正確にカード数を反映する
- トランザクションの失敗が正しく分類される

### テストケース

#### 正常系

- [ ] **TC-002-01**: card_count 未初期化ユーザーのカード作成 🔵
  - **入力**: card_count 属性が存在しないユーザーがカードを作成
  - **期待結果**: `if_not_exists(card_count, 0) + 1` で card_count = 1 になる
  - **信頼性**: 🔵 *CR-02: card_service.py L106-127 の問題点1*

- [ ] **TC-002-02**: 既存ユーザーのカード作成（上限未到達） 🔵
  - **入力**: card_count = 100 のユーザーがカードを作成
  - **期待結果**: card_count = 101 になる
  - **信頼性**: 🔵 *CR-02: 正常系フロー*

- [ ] **TC-002-03**: カード削除時の card_count 減算 🔵
  - **入力**: card_count = 100 のユーザーがカードを削除
  - **期待結果**: card_count = 99 になる
  - **信頼性**: 🔵 *CR-02: card_service.py L234-250 の問題点3*

- [ ] **TC-002-04**: カード作成前のユーザーレコード保証 🔵
  - **入力**: ユーザーレコードが存在しない状態でカード作成
  - **期待結果**: get_or_create_user でユーザーレコードが作成された後にカード作成が実行される
  - **信頼性**: 🔵 *CR-02: handler.py L361 の問題点4*

#### 異常系

- [ ] **TC-002-E01**: カード上限到達時の正確なエラー分類 🔵
  - **入力**: card_count = 2000 のユーザーがカードを作成
  - **期待結果**: TransactionCanceledException の CancellationReasons を解析し、CardLimitExceededError を返却
  - **信頼性**: 🔵 *CR-02: card_service.py L130-132 の問題点2*

- [ ] **TC-002-E02**: 上限以外のトランザクション失敗 🟡
  - **入力**: DynamoDB のトランザクション競合やスロットリングによる失敗
  - **期待結果**: CardLimitExceededError ではなく内部エラーとして処理
  - **信頼性**: 🟡 *CR-02: CancellationReasons の分岐条件。DynamoDB ドキュメントで確認必要*

- [ ] **TC-002-E03**: 並行カード作成での整合性 🔵
  - **入力**: card_count = 1999 の状態で同時に2つのカード作成リクエスト
  - **期待結果**: 1つのみ成功し card_count = 2000 になる
  - **信頼性**: 🔵 *CR-02: トランザクション原子性による保証*

#### 境界値

- [ ] **TC-002-B01**: card_count = 0 でのカード削除 🟡
  - **入力**: card_count = 0 のユーザーがカードを削除
  - **期待結果**: card_count が負数にならない（下限チェック）
  - **信頼性**: 🟡 *EDGE-V2-101: 防御的プログラミングの推測*

- [ ] **TC-002-B02**: card_count = 2000 でのカード作成 🔵
  - **入力**: card_count = 2000 のユーザーがカードを作成
  - **期待結果**: CardLimitExceededError が返却される
  - **信頼性**: 🔵 *既存テストケースの延長*

---

## REQ-V2-021〜023: LINE連携本人性検証（H-01） 🔵

**信頼性**: 🔵 *H-01: ユーザヒアリングで LIFF IDトークン検証方式に決定*

### Given（前提条件）
- LIFF アプリが LINE アプリ内で動作している
- LIFF SDK が ID トークンを取得可能

### When（実行条件）
- ユーザーが LINE 連携を実行する

### Then（期待結果）
- サーバー側で ID トークンが検証される
- 検証成功時のみ連携が確定する

### テストケース

#### 正常系

- [ ] **TC-003-01**: 有効なIDトークンでの連携成功 🔵
  - **入力**: フロントエンドから有効な LIFF ID トークンを送信
  - **期待結果**: サーバーが LINE ID トークン検証 API で検証後、line_user_id を抽出し連携を確定。User 型オブジェクトを返却
  - **信頼性**: 🔵 *H-01: ユーザヒアリングで方式決定*

- [ ] **TC-003-02**: フロントエンドがIDトークンを送信する 🔵
  - **入力**: LIFF SDK から ID トークンを取得
  - **期待結果**: リクエストボディに `id_token` フィールドが含まれる（`line_user_id` は含まない）
  - **信頼性**: 🔵 *H-01: ID トークン経由のみの検証フロー*

#### 異常系

- [ ] **TC-003-E01**: 無効なIDトークンでの連携拒否 🔵
  - **入力**: 改ざんされた ID トークンを送信
  - **期待結果**: LINE ID トークン検証 API が失敗を返却し、サーバーが 401 エラーを返却
  - **信頼性**: 🔵 *H-01: セキュリティ要件*

- [ ] **TC-003-E02**: 期限切れIDトークンでの連携拒否 🟡
  - **入力**: 有効期限が切れた ID トークンを送信
  - **期待結果**: LINE ID トークン検証 API が失敗を返却し、サーバーが適切なエラーメッセージを返却
  - **信頼性**: 🟡 *EDGE-V2-001: ID トークンのライフサイクルから推測*

- [ ] **TC-003-E03**: IDトークン未送信での連携拒否 🟡
  - **入力**: `id_token` フィールドが空またはリクエストに含まれない
  - **期待結果**: 400 バリデーションエラー
  - **信頼性**: 🟡 *入力バリデーションの一般的なパターン*

---

## REQ-V2-031〜033: レスポンスDTO統一（H-02） 🔵

**信頼性**: 🔵 *H-02: handler のレスポンス形式と frontend の期待型の不一致を確認*

### Given（前提条件）
- フロントエンドが User 型オブジェクトを期待している

### When（実行条件）
- 設定更新、LINE 連携、LINE 連携解除を実行する

### Then（期待結果）
- バックエンドが User 型オブジェクトを返却する
- フロントエンドが正しくパースできる

### テストケース

#### 正常系

- [ ] **TC-004-01**: PUT /users/me/settings のレスポンス型 🔵
  - **入力**: `PUT /users/me/settings` を呼び出し
  - **期待結果**: `{success: true, data: User}` 形式のレスポンス（User にはuser_id, line_user_id, card_count, settings, created_at を含む）
  - **信頼性**: 🔵 *H-02: handler.py L184 の修正*

- [ ] **TC-004-02**: POST /users/link-line のレスポンス型 🔵
  - **入力**: `POST /users/link-line` を呼び出し
  - **期待結果**: `{success: true, data: User}` 形式のレスポンス
  - **信頼性**: 🔵 *H-02: handler.py L133 の修正*

- [ ] **TC-004-03**: LINE連携解除で専用APIを使用 🔵
  - **入力**: フロントエンドの LINE 連携解除ボタンを押下
  - **期待結果**: `POST /users/me/unlink-line` が呼ばれる（`usersApi.updateUser()` ではない）
  - **信頼性**: 🔵 *H-02: LinkLinePage.tsx L94 の修正*

---

## REQ-V2-041〜042: 通知時刻/タイムゾーン判定（H-03） 🔵

**信頼性**: 🔵 *H-03: notification_service.py のコード分析で時刻チェック未実装を確認*

### Given（前提条件）
- EventBridge が5分ごとに通知 Lambda を起動する
- ユーザーが notification_time を設定している

### When（実行条件）
- 通知 Lambda が実行される

### Then（期待結果）
- ユーザーのローカル時刻と notification_time が一致する場合のみ通知される

### テストケース

#### 正常系

- [ ] **TC-005-01**: 通知時刻一致時の送信 🔵
  - **入力**: notification_time = "21:00"、ユーザーのローカル時刻 = 21:03（Asia/Tokyo）
  - **期待結果**: 通知が送信される（±5分の精度）
  - **信頼性**: 🔵 *H-03: notification_service.py L79-86 の修正*

- [ ] **TC-005-02**: 通知時刻不一致時のスキップ 🔵
  - **入力**: notification_time = "21:00"、ユーザーのローカル時刻 = 15:00（Asia/Tokyo）
  - **期待結果**: 通知がスキップされる
  - **信頼性**: 🔵 *H-03: 時刻チェック実装*

- [ ] **TC-005-03**: デフォルトタイムゾーンの適用 🟡
  - **入力**: タイムゾーン未設定ユーザー、UTC 時刻 = 12:00
  - **期待結果**: Asia/Tokyo（UTC+9）で 21:00 として判定
  - **信頼性**: 🟡 *REQ-V2-112: デフォルトタイムゾーンの推測*

#### 境界値

- [ ] **TC-005-B01**: 日付境界でのタイムゾーン変換 🟡
  - **入力**: notification_time = "00:00"、UTC 時刻 = 15:00（→ JST 00:00）
  - **期待結果**: 正しく翌日の 00:00 として判定される
  - **信頼性**: 🟡 *EDGE-V2-102: タイムゾーン変換の境界ケース*

---

## REQ-V2-051: 環境変数名統一（H-04） 🔵

**信頼性**: 🔵 *H-04: deploy.yml と api.ts の環境変数名不一致を確認*

### テストケース

- [ ] **TC-006-01**: deploy.yml の環境変数名 🔵
  - **確認項目**: deploy.yml の全箇所で `VITE_API_BASE_URL` を使用
  - **期待結果**: `VITE_API_URL` が存在しない
  - **信頼性**: 🔵 *H-04: ユーザヒアリングで統一先決定*

- [ ] **TC-006-02**: .env.example との整合性 🟡
  - **確認項目**: .env.example に `VITE_API_BASE_URL` が記載
  - **期待結果**: 環境変数名が一致
  - **信頼性**: 🟡 *.env.example の存在・内容は未確認*

---

## REQ-V2-052: httpx統一（H-05） 🔵

**信頼性**: 🔵 *H-05: ユーザヒアリングで httpx 統一に決定*

### テストケース

- [ ] **TC-007-01**: line_service.py の import 確認 🔵
  - **確認項目**: `import requests` が `import httpx` に置換されている
  - **期待結果**: `requests` の import がない
  - **信頼性**: 🔵 *H-05: httpx 統一決定*

- [ ] **TC-007-02**: LINE API 呼び出しが httpx で動作 🔵
  - **入力**: LINE API への HTTP リクエスト
  - **期待結果**: httpx を使用して正常に通信できる
  - **信頼性**: 🔵 *H-05: 機能テスト*

- [ ] **TC-007-03**: requirements.txt に requests がない 🔵
  - **確認項目**: requirements.txt に `requests` が含まれていない
  - **期待結果**: httpx のみが HTTP ライブラリとして宣言されている
  - **信頼性**: 🔵 *H-05: 依存関係の統一*

---

## REQ-V2-053: OIDCクライアントID統一（H-06） 🔵

**信頼性**: 🔵 *H-06: ユーザヒアリングで `liff-client` 統一に決定*

### テストケース

- [ ] **TC-008-01**: deploy.yml のクライアントID 🔵
  - **確認項目**: deploy.yml L95 が `liff-client` を使用
  - **期待結果**: `memoru-liff` が存在しない
  - **信頼性**: 🔵 *H-06: ユーザヒアリングで統一先決定*

- [ ] **TC-008-02**: E2EテストフィクスチャのクライアントID 🔵
  - **確認項目**: auth.fixture.ts L32 が `liff-client` を使用
  - **期待結果**: `memoru-liff` が存在しない
  - **信頼性**: 🔵 *H-06: 全レイヤー統一*

- [ ] **TC-008-03**: 全レイヤーのクライアントID整合性チェック 🔵
  - **確認項目**: realm-export.json、template.yaml、deploy.yml、auth.fixture.ts のクライアントID
  - **期待結果**: すべて `liff-client` で統一
  - **信頼性**: 🔵 *H-06: 包括的チェック*

---

## テストケースサマリー

### カテゴリ別件数

| カテゴリ | 正常系 | 異常系 | 境界値 | 合計 |
|---------|--------|--------|--------|------|
| CR-01 APIルート統一 | 4 | 1 | 0 | 5 |
| CR-02 card_countトランザクション | 4 | 3 | 2 | 9 |
| H-01 LINE連携検証 | 2 | 3 | 0 | 5 |
| H-02 レスポンスDTO統一 | 3 | 0 | 0 | 3 |
| H-03 通知時刻判定 | 3 | 0 | 1 | 4 |
| H-04 環境変数名統一 | 2 | 0 | 0 | 2 |
| H-05 httpx統一 | 3 | 0 | 0 | 3 |
| H-06 OIDCクライアントID統一 | 3 | 0 | 0 | 3 |
| **合計** | **24** | **7** | **3** | **34** |

### 信頼性レベル分布

- 🔵 青信号: 28件 (82%)
- 🟡 黄信号: 6件 (18%)
- 🔴 赤信号: 0件 (0%)

**品質評価**: ✅ 高品質（青信号が82%、赤信号なし）

### 優先度別テストケース

- **Must Have**: 34件（全テストケース）

---

## テスト実施計画

### Phase 1: Critical修正テスト
- CR-01: APIルート統一テスト（TC-001-01〜E01）
- CR-02: card_countトランザクションテスト（TC-002-01〜B02）
- 優先度: Must Have

### Phase 2: High修正テスト
- H-01: LINE連携検証テスト（TC-003-01〜E03）
- H-02: レスポンスDTO統一テスト（TC-004-01〜03）
- H-03: 通知時刻判定テスト（TC-005-01〜B01）
- H-04: 環境変数名統一テスト（TC-006-01〜02）
- H-05: httpx統一テスト（TC-007-01〜03）
- H-06: OIDCクライアントID統一テスト（TC-008-01〜03）
- 優先度: Must Have
