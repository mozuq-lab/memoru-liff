# code-review-fixes-v2 ユーザストーリー

**作成日**: 2026-02-17
**関連要件定義**: [requirements.md](requirements.md)
**ヒアリング記録**: [interview-record.md](interview-record.md)

**【信頼性レベル凡例】**:
- 🔵 **青信号**: コードレビュー結果・既存設計文書・実装コード・ユーザヒアリングから確実なストーリー
- 🟡 **黄信号**: コードレビュー結果から妥当な推測によるストーリー
- 🔴 **赤信号**: コードレビュー結果にない推測によるストーリー

---

## エピック1: API契約の整合性確保

### ストーリー 1.1: 設定更新が正しく動作する 🔵

**信頼性**: 🔵 *CR-01: SAM/handler/frontend の3レイヤー不一致。設計文書 api-endpoints.md 準拠をユーザヒアリングで確認*

**私は** アプリユーザー **として**
**通知時間などの設定を変更して保存したい**
**そうすることで** 自分のペースで学習通知を受け取れる

**関連要件**: REQ-V2-001, REQ-V2-031

**詳細シナリオ**:
1. LIFF アプリの設定画面で通知時間を変更する
2. 保存ボタンを押す
3. フロントエンドが `PUT /users/me/settings` を呼び出す
4. API Gateway が SAM 定義に基づいてリクエストをルーティングする
5. Lambda ハンドラーが設定を更新し、User 型オブジェクトを返却する
6. フロントエンドが更新後のユーザー情報を表示する

**前提条件**:
- ユーザーがログイン済み
- SAM テンプレート、ハンドラー、フロントエンドのパスが一致している

**優先度**: Must Have

---

### ストーリー 1.2: レビュー送信が正しく動作する 🔵

**信頼性**: 🔵 *CR-01: SAM にパスパラメータがない。handler/frontend は一致*

**私は** アプリユーザー **として**
**カードの復習結果を記録したい**
**そうすることで** SRS アルゴリズムが次回復習日を正しく計算してくれる

**関連要件**: REQ-V2-002

**詳細シナリオ**:
1. 復習画面でカードの表裏を確認する
2. 0-5 の採点ボタンを押す
3. フロントエンドが `POST /reviews/{cardId}` を呼び出す
4. API Gateway が SAM 定義のパスパラメータを正しくルーティングする
5. Lambda ハンドラーが SM-2 パラメータを更新する

**前提条件**:
- SAM テンプレートのパスが `POST /reviews/{cardId}` 形式になっている

**優先度**: Must Have

---

### ストーリー 1.3: LINE連携エンドポイントが正しくルーティングされる 🔵

**信頼性**: 🔵 *CR-01: SAM に定義なし、handler/frontend のパス不一致*

**私は** アプリユーザー **として**
**LINE アカウントとアプリを連携させたい**
**そうすることで** LINE で復習通知を受け取れるようになる

**関連要件**: REQ-V2-003, REQ-V2-004

**詳細シナリオ**:
1. LINE 連携画面で「連携する」ボタンを押す
2. フロントエンドが `POST /users/link-line` を呼び出す
3. API Gateway が SAM 定義に基づいてリクエストをルーティングする
4. Lambda ハンドラーが LINE アカウントとの紐付けを行う

**前提条件**:
- SAM テンプレートに LINE 連携エンドポイントが定義されている
- フロントエンドのパスがハンドラーと一致している

**優先度**: Must Have

---

### ストーリー 1.4: レスポンスDTOが統一されている 🔵

**信頼性**: 🔵 *H-02: handler のレスポンス形式と frontend の期待型が不一致*

**私は** アプリユーザー **として**
**設定保存後やLINE連携後に最新の自分の情報が表示されてほしい**
**そうすることで** 操作が正しく反映されたことを確認できる

**関連要件**: REQ-V2-031, REQ-V2-032, REQ-V2-033

**詳細シナリオ**:
1. 設定更新または LINE 連携を実行する
2. バックエンドが User 型オブジェクトをレスポンスとして返却する
3. フロントエンドが User 型として正しくパースする
4. UI にユーザー情報が正しく反映される

**前提条件**:
- バックエンドのレスポンスがフロントエンドの期待する User 型と一致

**優先度**: Must Have

---

## エピック2: データ整合性の確保

### ストーリー 2.1: カード作成時の card_count が安全に管理される 🔵

**信頼性**: 🔵 *CR-02: card_service.py の card_count トランザクション不備。コード分析で確認*

**私は** アプリユーザー **として**
**カードを作成した際に正確なカード数が管理されてほしい**
**そうすることで** 上限の2,000枚に達した時に適切に通知される

**関連要件**: REQ-V2-011, REQ-V2-012, REQ-V2-014, REQ-V2-101, REQ-V2-102

**詳細シナリオ**:
1. ユーザーがカードを新規作成する
2. システムがユーザーレコードの存在を確認（なければ作成）
3. card_count を `if_not_exists` で安全に加算する
4. 上限チェックが正しく動作する
5. エラー時は適切なエラーメッセージを表示する

**前提条件**:
- DynamoDB トランザクションが利用可能
- ユーザーレコードの get_or_create が実装されている

**制約事項**:
- TransactionCanceledException の CancellationReasons で正確にエラーを分類する

**優先度**: Must Have

---

### ストーリー 2.2: カード削除時に card_count が正しく減算される 🔵

**信頼性**: 🔵 *CR-02: delete_card() で card_count 未減算。コード分析で確認*

**私は** アプリユーザー **として**
**カードを削除した際にカード数が正しく減ってほしい**
**そうすることで** 上限に余裕ができ、新しいカードを作成できる

**関連要件**: REQ-V2-013

**詳細シナリオ**:
1. ユーザーがカードを削除する
2. システムがトランザクションでカード削除と card_count 減算を同時実行する
3. card_count が 0 未満にならないよう下限チェックする
4. UI にカード数の変化が反映される

**前提条件**:
- 削除対象のカードが存在する
- card_count が 0 以上

**優先度**: Must Have

---

## エピック3: LINE連携セキュリティ強化

### ストーリー 3.1: LINE連携時にサーバー側で本人性を検証する 🔵

**信頼性**: 🔵 *H-01: 本人性検証なし。ユーザヒアリングで LIFF IDトークン検証方式に決定*

**私は** アプリ運営者 **として**
**LINE連携が本人のみ行えることを保証したい**
**そうすることで** 悪意あるユーザーが他人のLINE IDを紐付けることを防げる

**関連要件**: REQ-V2-021, REQ-V2-022, REQ-V2-023, REQ-V2-121

**詳細シナリオ**:
1. ユーザーが LINE 連携ボタンを押す
2. フロントエンドが LIFF SDK から ID トークンを取得する
3. フロントエンドが ID トークンをサーバーに送信する
4. サーバーが LINE ID トークン検証 API で ID トークンを検証する
5. 検証成功: ID トークンから line_user_id を抽出し連携を確定する
6. 検証失敗: 401 エラーを返却し連携を拒否する

**前提条件**:
- LIFF SDK が ID トークンを取得可能
- LINE Login API の ID トークン検証エンドポイントが利用可能

**制約事項**:
- line_user_id はフロントエンドから直接受信しない（IDトークン経由のみ）

**優先度**: Must Have

---

## エピック4: 通知機能の完成

### ストーリー 4.1: ユーザー設定の通知時間に合わせて通知される 🔵

**信頼性**: 🔵 *H-03: notification_service.py で時刻チェックなし。コード分析で確認*

**私は** アプリユーザー **として**
**自分が設定した時間に復習通知を受け取りたい**
**そうすることで** 生活リズムに合った時間に学習できる

**関連要件**: REQ-V2-041, REQ-V2-042, REQ-V2-111, REQ-V2-112

**詳細シナリオ**:
1. ユーザーが通知時間を「21:00」に設定する
2. EventBridge が5分ごとに通知 Lambda を起動する
3. Lambda がユーザーのタイムゾーン（デフォルト Asia/Tokyo）でローカル時刻を算出する
4. ローカル時刻が notification_time と一致する場合のみ通知を送信する
5. 一致しない場合はスキップする

**前提条件**:
- ユーザーが notification_time を設定済み
- ユーザーが LINE 連携済み

**制約事項**:
- タイムゾーン未設定時は Asia/Tokyo をデフォルトとする

**優先度**: Must Have

---

## エピック5: 設定整合性の確保

### ストーリー 5.1: CI/CDデプロイ後にAPIに正しく接続できる 🔵

**信頼性**: 🔵 *H-04: deploy.yml と api.ts で環境変数名不一致。コード分析で確認*

**私は** 開発者 **として**
**CI/CDでデプロイした後にフロントエンドがAPIに正しく接続してほしい**
**そうすることで** デプロイ後の接続障害を防げる

**関連要件**: REQ-V2-051

**詳細シナリオ**:
1. GitHub Actions でデプロイが実行される
2. deploy.yml が `VITE_API_BASE_URL` でビルドする
3. api.ts が `VITE_API_BASE_URL` を参照する
4. フロントエンドが正しい API URL に接続する

**前提条件**:
- deploy.yml と api.ts で同じ環境変数名を使用

**優先度**: Must Have

---

### ストーリー 5.2: LINE サービスが実行時にエラーなく動作する 🔵

**信頼性**: 🔵 *H-05: requests 未宣言。ユーザヒアリングで httpx 統一に決定*

**私は** 開発者 **として**
**Lambda 実行時に ImportError が発生しないようにしたい**
**そうすることで** LINE 通知機能が確実に動作する

**関連要件**: REQ-V2-052

**詳細シナリオ**:
1. line_service.py が httpx をインポートする
2. LINE API 呼び出しが httpx で実行される
3. Lambda 環境で ImportError が発生しない

**前提条件**:
- requirements.txt に httpx が宣言済み（既存）

**優先度**: Must Have

---

### ストーリー 5.3: OIDC認証が全環境で正しく動作する 🔵

**信頼性**: 🔵 *H-06: client_id 不一致。ユーザヒアリングで `liff-client` 統一に決定*

**私は** 開発者 **として**
**全環境で OIDC 認証が正しく動作してほしい**
**そうすることで** トークン検証の audience 不一致による認証失敗を防げる

**関連要件**: REQ-V2-053

**詳細シナリオ**:
1. Keycloak が `liff-client` クライアントでトークンを発行する
2. SAM テンプレートが JWT audience を `liff-client` で検証する
3. CI/CD が `liff-client` でフロントエンドをビルドする
4. E2E テストが `liff-client` でモック認証する

**前提条件**:
- Keycloak realm-export.json のクライアント ID が `liff-client`

**優先度**: Must Have

---

## ストーリーマップ

```
エピック1: API契約の整合性確保
├── ストーリー 1.1 (🔵 Must Have) — 設定更新ルート統一
├── ストーリー 1.2 (🔵 Must Have) — レビュー送信ルート統一
├── ストーリー 1.3 (🔵 Must Have) — LINE連携ルート追加・統一
└── ストーリー 1.4 (🔵 Must Have) — レスポンスDTO統一

エピック2: データ整合性の確保
├── ストーリー 2.1 (🔵 Must Have) — card_count 安全な加算
└── ストーリー 2.2 (🔵 Must Have) — card_count 削除時減算

エピック3: LINE連携セキュリティ強化
└── ストーリー 3.1 (🔵 Must Have) — LIFF IDトークン検証

エピック4: 通知機能の完成
└── ストーリー 4.1 (🔵 Must Have) — 通知時刻/タイムゾーン判定

エピック5: 設定整合性の確保
├── ストーリー 5.1 (🔵 Must Have) — 環境変数名統一
├── ストーリー 5.2 (🔵 Must Have) — httpx統一
└── ストーリー 5.3 (🔵 Must Have) — OIDCクライアントID統一
```

## 信頼性レベルサマリー

- 🔵 青信号: 11件 (100%)
- 🟡 黄信号: 0件 (0%)
- 🔴 赤信号: 0件 (0%)

**品質評価**: ✅ 高品質（全ストーリーが青信号）
