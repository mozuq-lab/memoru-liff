# code-review-fixes-v2 ヒアリング記録

**作成日**: 2026-02-17
**ヒアリング実施**: step4 既存情報ベースの差分ヒアリング

## ヒアリング目的

第2回コードレビュー（2026-02-16）の指摘事項に対し、修正方針・スコープ・実装アプローチを明確化するためのヒアリングを実施。第1回レビュー修正（全19タスク完了済み）後の再指摘事項と新規指摘事項を整理し、要件定義の信頼性を向上させた。

## 質問と回答

### Q1: 作業規模の確認

**質問日時**: 2026-02-17
**カテゴリ**: 優先順位
**背景**: 第2回コードレビューの18件の指摘に対し、要件定義の詳細度を決定する必要があった。

**質問**: この要件の作業規模について教えてください
**回答**: フル機能開発（推奨）

**信頼性への影響**:
- 全要件に対して詳細なEARS記法、ユーザーストーリー、受け入れ基準を作成する方針が確定
- 要件定義の網羅性が向上

---

### Q2: 対象スコープの確認

**質問日時**: 2026-02-17
**カテゴリ**: 優先順位
**背景**: 18件の指摘（Critical 2 + High 6 + Medium 8 + Low 2）のうち、どの範囲を要件定義に含めるかを決定する必要があった。

**質問**: 第2回コードレビューの指摘は Critical 2件、High 6件、Medium 8件、Low 2件の計18件です。どの範囲まで要件定義に含めますか？
**回答**: Critical + High（推奨）— P0の2件 + P1の6件 = 8件。リリース前に必須の修正のみ

**信頼性への影響**:
- スコープが明確化され、8件の要件に集中
- Medium/Low は付録として記載する方針

---

### Q3: 再指摘事項の扱い

**質問日時**: 2026-02-17
**カテゴリ**: 既存設計確認
**背景**: 第1回レビューの C-01（APIルート不一致）と C-02（レスポンス契約不一致）は TASK-0023・TASK-0024 で「完了」としたが、第2回レビューで再び検出された。前回の修正が不十分だった可能性がある。

**質問**: 第1回レビューで「C-01 APIルート不一致」と「C-02 レスポンス契約不一致」はTASK-0023・TASK-0024で完了済みですが、第2回レビューで再指摘されています。この不一致についてどう扱いますか？
**回答**: 新規要件として再定義

**信頼性への影響**:
- CR-01, H-02 の要件が前回の文脈に依存せず独立して定義可能に
- 前回修正の不足箇所を明確に特定し、再発防止策も含められる

---

### Q4: APIルート統一方針

**質問日時**: 2026-02-17
**カテゴリ**: 未定義部分詳細化
**背景**: 3レイヤー（SAM/handler/frontend）でパスが不一致であり、どのレイヤーの定義を「正」とするか決める必要があった。設計文書 api-endpoints.md では `PUT /users/me/settings`、`POST /reviews/:card_id`、`POST /users/link-line` と定義されている。

**質問**: CR-01: APIルート統一の方針を教えてください。設計文書のAPI仕様では `PUT /users/me/settings`、`POST /reviews/:card_id`、`POST /users/link-line` です。どちらに合わせますか？
**回答**: 設計文書に統一（推奨）

**信頼性への影響**:
- REQ-V2-001〜004 の信頼性が 🔵 に確定
- 設計文書を single source of truth として統一方針が明確化

---

### Q5: LINE連携の本人性検証方式

**質問日時**: 2026-02-17
**カテゴリ**: 未定義部分詳細化
**背景**: H-01 で指摘された LINE 連携の本人性検証が未実装。LIFF SDK の `profile.userId` をそのまま信用しており、悪意あるユーザーが任意の LINE ID を紐付け可能な状態。

**質問**: H-01: LINE連携の本人性検証について、LIFF IDトークンをサーバー側で検証する方針でよいですか？
**回答**: LIFF IDトークン検証（推奨）

**信頼性への影響**:
- REQ-V2-021〜022 の信頼性が 🔵 に確定
- REQ-V2-023（検証後の連携確定フロー）は LINE Login API 仕様依存のため 🟡

---

### Q6: HTTPライブラリの統一

**質問日時**: 2026-02-17
**カテゴリ**: 追加要件
**背景**: H-05 で line_service.py が `requests` を使用しているが requirements.txt に未宣言。プロジェクトでは `httpx` を宣言済み。

**質問**: H-05: line_service.pyで `requests` を使用していますが、`httpx` に統一しますか？それとも `requests` を requirements.txt に追加しますか？
**回答**: httpxに統一（推奨）

**信頼性への影響**:
- REQ-V2-052 の信頼性が 🔵 に確定
- 変更範囲は line_service.py の HTTP 呼び出し部分のリファクタリング

---

### Q7: OIDCクライアントIDの統一先

**質問日時**: 2026-02-17
**カテゴリ**: 既存設計確認
**背景**: H-06 で OIDC クライアント ID が `liff-client`（Keycloak/SAM）と `memoru-liff`（CI/CD/E2E）で不一致。

**質問**: H-06: OIDCクライアントIDが `liff-client`（Keycloak/SAM）と `memoru-liff`（CI/CD/E2E）で不一致です。どちらに統一しますか？
**回答**: liff-clientに統一

**信頼性への影響**:
- REQ-V2-053 の信頼性が 🔵 に確定
- Keycloak realm-export.json と SAM template.yaml の既存定義を変更不要

---

### Q8: 環境変数名の統一先

**質問日時**: 2026-02-17
**カテゴリ**: 既存設計確認
**背景**: H-04 で `VITE_API_BASE_URL`（api.ts）と `VITE_API_URL`（deploy.yml）で環境変数名が不一致。

**質問**: H-04: 環境変数名は `VITE_API_BASE_URL`（api.tsの現行）に統一してよいですか？
**回答**: VITE_API_BASE_URLに統一（推奨）

**信頼性への影響**:
- REQ-V2-051 の信頼性が 🔵 に確定
- 修正対象は deploy.yml のみ

---

### Q9: Medium項目の記載方針

**質問日時**: 2026-02-17
**カテゴリ**: 優先順位
**背景**: Medium 8件・Low 2件は今回のスコープ外だが、将来の参照用に記録の要否を確認。

**質問**: Mediumレベルの8件は今回の要件定義からは除外しますが、将来の対応用に付録として記載しますか？
**回答**: 付録として記載（推奨）

**信頼性への影響**:
- 要件定義書の完全性が向上
- 将来の改善計画の参考情報として活用可能

---

### Q10: 既存コードベースの詳細分析

**質問日時**: 2026-02-17
**カテゴリ**: 影響範囲
**背景**: 第1回レビュー修正後の実装状態を確認し、第2回レビュー指摘との差分を正確に把握する必要があった。

**質問**: 既存コードベースの詳細分析が必要ですか？
**回答**: 必要

**信頼性への影響**:
- コード分析により全指摘事項が実コードで確認され、要件の信頼性が大幅向上
- API ルート不一致3箇所、requests 使用、unlink API 未使用、環境変数不一致、TTL 未設定をすべて検証済み

---

## ヒアリング結果サマリー

### 確認できた事項
- 対象スコープ: Critical 2件 + High 6件 = 計8件
- 再指摘事項: 新規要件として独立定義
- API ルート統一: 設計文書（api-endpoints.md）を正とする
- LINE 連携検証: LIFF ID トークンのサーバー側検証方式
- HTTP ライブラリ: httpx に統一
- OIDC クライアント ID: `liff-client` に統一
- 環境変数名: `VITE_API_BASE_URL` に統一
- Medium/Low: 付録として記載

### 追加/変更要件
- なし（コードレビュー指摘事項をそのまま要件化）

### 残課題
- LINE ID トークン検証 API の詳細仕様（エンドポイント URL、レスポンス形式）は設計フェーズで確認
- デフォルトタイムゾーン（Asia/Tokyo）の妥当性は将来の多言語対応時に再検討
- TransactionCanceledException の CancellationReasons の具体的な分岐条件は実装時に DynamoDB ドキュメントで確認

### 信頼性レベル分布

**ヒアリング前**:
- 🔵 青信号: 18件
- 🟡 黄信号: 15件
- 🔴 赤信号: 5件

**ヒアリング後**:
- 🔵 青信号: 29件 (+11)
- 🟡 黄信号: 9件 (-6)
- 🔴 赤信号: 0件 (-5)

## 関連文書

- **要件定義書**: [requirements.md](requirements.md)
- **ユーザストーリー**: [user-stories.md](user-stories.md)
- **受け入れ基準**: [acceptance-criteria.md](acceptance-criteria.md)
