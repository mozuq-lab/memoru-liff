# memoru-liff 要件定義書

## 概要

LINE内で動作する暗記アプリ（SRS: Spaced Repetition System）。LIFF（LINE内Web）でカード入力・閲覧を行い、LINE Messaging APIで復習通知・回答を実現する。Keycloak（OIDC）を認証基盤として使用し、Amazon Bedrockを活用したAIカード生成機能を提供する。

## 関連文書

- **ヒアリング記録**: [interview-record.md](interview-record.md)
- **ユーザストーリー**: [user-stories.md](user-stories.md)
- **受け入れ基準**: [acceptance-criteria.md](acceptance-criteria.md)
- **コンテキストノート**: [note.md](note.md)
- **PRD**: [requirement.md](../../../requirement.md)

## 機能要件（EARS記法）

**【信頼性レベル凡例】**:

- 🔵 **青信号**: PRD・設計文書・ユーザヒアリングを参考にした確実な要件
- 🟡 **黄信号**: PRD・設計文書・ユーザヒアリングから妥当な推測による要件
- 🔴 **赤信号**: PRD・設計文書・ユーザヒアリングにない推測による要件

---

### 通常要件

#### 認証・認可

- REQ-001: システムは Keycloak（OIDC）を使用してユーザー認証を行わなければならない 🔵 *PRD第3章より*
- REQ-002: システムは Authorization Code + PKCE フローで認証を実装しなければならない 🔵 *PRD第3章より*
- REQ-003: システムは LINE Login を Keycloak Identity Provider として連携しなければならない 🔵 *PRD第3章より*
- REQ-004: システムは JWT（Keycloak発行）を使用してAPIリクエストを認可しなければならない 🔵 *PRD第4章より*

#### カード管理

- REQ-011: システムは フラッシュカード（表面・裏面）を保存できなければならない 🔵 *PRD第2章より*
- REQ-012: システムは ユーザーあたり最大2,000枚のカードを保存できなければならない 🔵 *ユーザヒアリングより*
- REQ-013: システムは カードの作成・編集・削除機能を提供しなければならない 🟡 *PRDから妥当な推測*
- REQ-014: システムは カード一覧表示機能を提供しなければならない 🟡 *PRDから妥当な推測*

#### AIカード生成（MVP）

- REQ-021: システムは テキスト入力からAIでフラッシュカードを生成できなければならない 🔵 *PRD第2章・ヒアリングより*
- REQ-022: システムは Amazon Bedrock を使用してカード生成を行わなければならない 🔵 *ユーザヒアリングより*
- REQ-023: システムは 入力テキストを最大2,000文字に制限しなければならない 🔵 *ユーザヒアリングより*
- REQ-024: システムは 生成されたカードをユーザーが確認・編集後に保存できなければならない 🟡 *PRDから妥当な推測*

#### SRS（間隔反復学習）

- REQ-031: システムは SM-2アルゴリズムに基づいて復習間隔を計算しなければならない 🔵 *PRD第2章より*
- REQ-032: システムは 0-5の6段階で回答を採点しなければならない 🔵 *ユーザヒアリングより*
- REQ-033: システムは 各カードの次回復習日（due）を管理しなければならない 🔵 *PRD第2章より*
- REQ-034: システムは interval, ease_factor, repetitions パラメータを管理しなければならない 🔵 *PRD第2章より*

#### LINE通知（MVP）

- REQ-041: システムは 復習期限のカードがあるユーザーにLINE通知を送信しなければならない 🔵 *PRD第2章・ヒアリングより*
- REQ-042: システムは Flex Message を使用して復習通知を表示しなければならない 🔵 *PRD第2章より*
- REQ-043: システムは ユーザーが通知時間を設定できなければならない 🔵 *ユーザヒアリングより*

#### LINE回答・採点

- REQ-051: システムは Postback を使用してユーザーの回答を受け付けなければならない 🔵 *PRD第2章より*
- REQ-052: システムは 回答結果に基づいてSRSパラメータを更新しなければならない 🔵 *PRD第2章より*

---

### 条件付き要件

#### 認証フロー

- REQ-101: ユーザーが未ログインの場合、システムは Keycloak ログイン画面にリダイレクトしなければならない 🔵 *PRD第3章より*
- REQ-102: JWTが期限切れの場合、システムは リフレッシュトークンで更新を試みなければならない 🔵 *PRD第3章より*
- REQ-103: LINE連携が未完了の場合、システムは LINE連携を促すメッセージを表示しなければならない 🟡 *PRDから妥当な推測*

#### エラー処理

- REQ-111: AIカード生成が失敗した場合、システムは エラーメッセージを表示しなければならない 🔵 *ユーザヒアリングより*
- REQ-112: LINE Push送信が失敗した場合、システムは エラーをログに記録しなければならない 🟡 *PRDから妥当な推測*

---

### 状態要件

#### 学習状態

- REQ-201: カードが復習期限（due）を過ぎている場合、システムは そのカードを復習対象としなければならない 🔵 *PRD第2章より*
- REQ-202: ユーザーがLINE連携済みの場合、システムは LINE通知を送信可能としなければならない 🔵 *PRD第2章より*

---

### オプション要件

- REQ-301: システムは AI採点機能（grade_answer）を提供してもよい 🔵 *PRD第2章より*
- REQ-302: システムは カードのエクスポート機能を提供してもよい 🔴 *PRDにない推測*
- REQ-303: システムは 学習統計ダッシュボードを提供してもよい 🔴 *PRDにない推測*

---

### 制約要件

#### 技術制約

- REQ-401: システムは AWS SAM（Python）でバックエンドを構築しなければならない 🔵 *PRD第1章より*
- REQ-402: システムは DynamoDB をデータストアとして使用しなければならない 🔵 *PRD第1章より*
- REQ-403: システムは Keycloak を ECS/Fargate + ALB + ACM 構成でデプロイしなければならない 🔵 *PRD第3章・ヒアリングより*
- REQ-404: システムは LIFF を CloudFront + S3 でホスティングしなければならない 🔵 *PRD第1章より*

#### セキュリティ制約

- REQ-411: システムは API呼び出しにレート制限を設けなければならない 🔵 *ユーザヒアリングより*
- REQ-412: システムは LINE Webhook署名検証を行わなければならない 🔵 *PRD第2章より*
- REQ-413: システムは Webhook処理時に line_user_id からユーザーを特定し、カード所有者を確認しなければならない 🔵 *PRD第2章より*

---

## 非機能要件

### パフォーマンス

- NFR-001: API レスポンスタイムは 95パーセンタイルで 3秒以内であるべき 🟡 *一般的なWeb標準から推測*
- NFR-002: AIカード生成は 30秒以内に完了すべき 🟡 *LLM処理時間から推測*
- NFR-003: LINE通知は due 時刻から 5分以内に送信されるべき 🟡 *EventBridge精度から推測*

### セキュリティ

- NFR-101: すべての通信は HTTPS を使用しなければならない 🔵 *PRD第3章より*
- NFR-102: 認証情報は Secrets Manager で管理しなければならない 🔵 *PRD第3章より*
- NFR-103: ユーザーは自分のカードのみアクセス可能でなければならない 🔵 *PRD第2章より*

### ユーザビリティ

- NFR-201: LIFF は LINE アプリ内 WebView で正常に動作しなければならない 🔵 *PRD第1章より*
- NFR-202: スマートフォンでの操作に最適化されたUIを提供しなければならない 🟡 *LIFF特性から推測*

### 可用性

- NFR-301: システムは 99%以上の稼働率を目指すべき 🟡 *一般的なSaaS標準から推測*
- NFR-302: Keycloak障害時もLINE Webhook処理は継続すべき 🟡 *認証分離設計から推測*

---

## Edgeケース

### エラー処理

- EDGE-001: Bedrock APIタイムアウト時、適切なエラーメッセージを表示する 🟡 *AI機能から推測*
- EDGE-002: DynamoDB書き込み失敗時、リトライ後にエラーを返す 🟡 *一般的な実装から推測*
- EDGE-003: LINE Pushトークン無効時、ユーザーに再連携を促す 🟡 *LINE API仕様から推測*

### 境界値

- EDGE-101: カード数が2,000枚に達した場合、新規作成を拒否しエラーを表示する 🔵 *ユーザヒアリングより*
- EDGE-102: 入力テキストが2,000文字を超えた場合、入力を制限する 🔵 *ユーザヒアリングより*
- EDGE-103: ease_factor が 1.3 未満にならないよう下限を設ける（SM-2仕様） 🔵 *SM-2アルゴリズム仕様より*

---

## 信頼性レベルサマリー

| レベル | 件数 | 割合 |
|--------|------|------|
| 🔵 青信号 | 38件 | 73% |
| 🟡 黄信号 | 12件 | 23% |
| 🔴 赤信号 | 2件 | 4% |

**品質評価**: ✅ 高品質（青信号が70%以上）
