# memoru-liff 受け入れ基準

**作成日**: 2026-01-05
**関連要件定義**: [requirements.md](requirements.md)
**関連ユーザストーリー**: [user-stories.md](user-stories.md)
**ヒアリング記録**: [interview-record.md](interview-record.md)

**【信頼性レベル凡例】**:

- 🔵 **青信号**: PRD・設計文書・ユーザヒアリングを参考にした確実な基準
- 🟡 **黄信号**: PRD・設計文書・ユーザヒアリングから妥当な推測による基準
- 🔴 **赤信号**: PRD・設計文書・ユーザヒアリングにない推測による基準

---

## REQ-001: Keycloak OIDC認証 🔵

**信頼性**: 🔵 *PRD第3章より*

### Given（前提条件）

- Keycloakが稼働している
- LIFFアプリがデプロイされている
- ユーザーがLINEアプリでLIFFを開いている

### When（実行条件）

- ユーザーが未認証状態でLIFFにアクセスする

### Then（期待結果）

- Keycloakログイン画面にリダイレクトされる
- ログイン成功後、LIFFアプリに戻る
- JWTがローカルストレージに保存される

### テストケース

#### 正常系

- [ ] **TC-001-01**: 未認証ユーザーのリダイレクト 🔵
  - **入力**: 未認証状態でLIFFにアクセス
  - **期待結果**: Keycloakログイン画面が表示される
  - **信頼性**: 🔵 *PRD第3章より*

- [ ] **TC-001-02**: LINE Loginでの認証成功 🔵
  - **入力**: LINE Identity Providerでログイン
  - **期待結果**: 認証成功、LIFFホーム画面に遷移
  - **信頼性**: 🔵 *PRD第3章より*

- [ ] **TC-001-03**: JWT保存確認 🔵
  - **入力**: 認証成功後
  - **期待結果**: access_token, refresh_tokenがストレージに保存
  - **信頼性**: 🔵 *PRD第3章より*

#### 異常系

- [ ] **TC-001-E01**: 認証キャンセル 🟡
  - **入力**: ログイン画面でキャンセル
  - **期待結果**: エラーメッセージを表示、再ログインを促す
  - **信頼性**: 🟡 *一般的なOIDCフローから推測*

- [ ] **TC-001-E02**: Keycloak接続エラー 🟡
  - **入力**: Keycloakがダウン中にアクセス
  - **期待結果**: エラーメッセージを表示
  - **信頼性**: 🟡 *一般的なエラー処理から推測*

---

## REQ-021: AIカード生成 🔵

**信頼性**: 🔵 *PRD第2章・ユーザヒアリングより*

### Given（前提条件）

- ユーザーがログイン済み
- カード数が2,000枚未満

### When（実行条件）

- ユーザーがテキストを入力して「生成」ボタンをタップ

### Then（期待結果）

- Bedrock APIが呼び出される
- フラッシュカード候補が生成・表示される
- ユーザーが保存ボタンで保存できる

### テストケース

#### 正常系

- [ ] **TC-021-01**: 正常なカード生成 🔵
  - **入力**: 500文字のテキスト
  - **期待結果**: 1-10枚のカード候補が生成される
  - **信頼性**: 🔵 *PRD第2章より*

- [ ] **TC-021-02**: 生成カードの保存 🔵
  - **入力**: 生成されたカードを選択して保存
  - **期待結果**: cards, reviewsテーブルにレコードが作成される
  - **信頼性**: 🔵 *PRD第2章より*

- [ ] **TC-021-03**: 生成カードの編集後保存 🟡
  - **入力**: 生成カードを編集して保存
  - **期待結果**: 編集内容が反映されて保存される
  - **信頼性**: 🟡 *PRDから妥当な推測*

#### 異常系

- [ ] **TC-021-E01**: Bedrock APIエラー 🔵
  - **入力**: Bedrock APIがエラーを返す
  - **期待結果**: エラーメッセージを表示、手動リトライを促す
  - **信頼性**: 🔵 *ユーザヒアリングより*

- [ ] **TC-021-E02**: 空テキスト入力 🟡
  - **入力**: 空文字列を入力
  - **期待結果**: バリデーションエラーを表示
  - **信頼性**: 🟡 *一般的なバリデーションから推測*

#### 境界値

- [ ] **TC-021-B01**: 入力テキスト2,000文字 🔵
  - **入力**: ちょうど2,000文字のテキスト
  - **期待結果**: 正常に生成される
  - **信頼性**: 🔵 *ユーザヒアリングより*

- [ ] **TC-021-B02**: 入力テキスト2,001文字 🔵
  - **入力**: 2,001文字のテキスト
  - **期待結果**: 入力が制限される or バリデーションエラー
  - **信頼性**: 🔵 *ユーザヒアリングより*

---

## REQ-032: SRS 6段階採点 🔵

**信頼性**: 🔵 *ユーザヒアリングより*

### Given（前提条件）

- 復習対象カードが存在
- ユーザーがLINEで回答中

### When（実行条件）

- ユーザーが自己採点ボタン（0-5）をタップ

### Then（期待結果）

- Postbackでgradeが送信される
- SM-2アルゴリズムでパラメータが更新される
- 次回復習日（due）が計算・保存される

### テストケース

#### 正常系

- [ ] **TC-032-01**: grade=5（完璧に覚えている）🔵
  - **入力**: grade=5を送信
  - **期待結果**: intervalが増加、ease_factorが上昇
  - **信頼性**: 🔵 *SM-2アルゴリズム仕様より*

- [ ] **TC-032-02**: grade=3（正解だが不安）🔵
  - **入力**: grade=3を送信
  - **期待結果**: intervalが微増、ease_factorが維持
  - **信頼性**: 🔵 *SM-2アルゴリズム仕様より*

- [ ] **TC-032-03**: grade=0（全く覚えていない）🔵
  - **入力**: grade=0を送信
  - **期待結果**: intervalが1日にリセット、repetitionsが0に
  - **信頼性**: 🔵 *SM-2アルゴリズム仕様より*

#### 境界値

- [ ] **TC-032-B01**: ease_factor下限 🔵
  - **入力**: 連続でgrade=0を送信
  - **期待結果**: ease_factorは1.3未満にならない
  - **信頼性**: 🔵 *SM-2アルゴリズム仕様より*

---

## REQ-041: LINE復習通知 🔵

**信頼性**: 🔵 *PRD第2章・ユーザヒアリングより*

### Given（前提条件）

- ユーザーがLINE連携済み
- 復習期限（due）が到来したカードが存在
- 通知時間が設定されている

### When（実行条件）

- EventBridge Schedulerが通知時間にLambdaを起動

### Then（期待結果）

- 対象ユーザーにFlex Messageが送信される
- メッセージに復習カード数と「復習開始」ボタンが含まれる

### テストケース

#### 正常系

- [ ] **TC-041-01**: 復習通知送信 🔵
  - **入力**: due ≤ 現在時刻のカードが存在
  - **期待結果**: LINE Pushメッセージが送信される
  - **信頼性**: 🔵 *PRD第2章より*

- [ ] **TC-041-02**: 複数カードの通知 🔵
  - **入力**: 5枚のカードが復習期限
  - **期待結果**: 「5枚のカードが復習待ちです」と表示
  - **信頼性**: 🔵 *PRD第2章より*

- [ ] **TC-041-03**: 復習カードなし 🟡
  - **入力**: 復習期限のカードが0枚
  - **期待結果**: 通知は送信されない
  - **信頼性**: 🟡 *一般的な通知ロジックから推測*

#### 異常系

- [ ] **TC-041-E01**: LINE Push失敗 🟡
  - **入力**: LINEトークンが無効
  - **期待結果**: エラーログ出力、再連携を促すメッセージ検討
  - **信頼性**: 🟡 *LINE API仕様から推測*

---

## REQ-012: カード最大2,000枚制限 🔵

**信頼性**: 🔵 *ユーザヒアリングより*

### Given（前提条件）

- ユーザーがログイン済み

### When（実行条件）

- ユーザーがカードを作成・保存しようとする

### Then（期待結果）

- カード数が2,000枚未満なら保存成功
- カード数が2,000枚に達していたらエラー

### テストケース

#### 境界値

- [ ] **TC-012-B01**: 1,999枚目のカード作成 🔵
  - **入力**: カード数1,998枚の状態で1枚作成
  - **期待結果**: 正常に保存される（合計1,999枚）
  - **信頼性**: 🔵 *ユーザヒアリングより*

- [ ] **TC-012-B02**: 2,000枚目のカード作成 🔵
  - **入力**: カード数1,999枚の状態で1枚作成
  - **期待結果**: 正常に保存される（合計2,000枚）
  - **信頼性**: 🔵 *ユーザヒアリングより*

- [ ] **TC-012-B03**: 2,001枚目のカード作成拒否 🔵
  - **入力**: カード数2,000枚の状態で1枚作成
  - **期待結果**: エラーメッセージ「カード上限に達しました」
  - **信頼性**: 🔵 *ユーザヒアリングより*

---

## REQ-411: レート制限 🔵

**信頼性**: 🔵 *ユーザヒアリングより*

### Given（前提条件）

- ユーザーがログイン済み
- API Gatewayにレート制限が設定されている

### When（実行条件）

- ユーザーが短時間に大量のAPIリクエストを送信

### Then（期待結果）

- 制限を超えたリクエストは 429 Too Many Requests を返す
- エラーメッセージが表示される

### テストケース

#### 正常系

- [ ] **TC-411-01**: 制限内のリクエスト 🟡
  - **入力**: 1分間に5リクエスト
  - **期待結果**: すべて正常に処理される
  - **信頼性**: 🟡 *具体的な制限値は設計フェーズで決定*

#### 異常系

- [ ] **TC-411-E01**: 制限超過 🟡
  - **入力**: 1分間に100リクエスト
  - **期待結果**: 制限超過後は429エラー
  - **信頼性**: 🟡 *一般的なレート制限から推測*

---

## 非機能要件テスト

### NFR-001: APIレスポンスタイム 🟡

**信頼性**: 🟡 *一般的なWeb標準から推測*

- [ ] **TC-NFR-001-01**: カード一覧取得
  - **測定項目**: レスポンスタイム
  - **目標値**: 95パーセンタイルで3秒以内
  - **測定条件**: 100枚のカードを持つユーザー
  - **信頼性**: 🟡 *一般的なWeb標準から推測*

### NFR-002: AIカード生成時間 🟡

**信頼性**: 🟡 *LLM処理時間から推測*

- [ ] **TC-NFR-002-01**: カード生成完了時間
  - **測定項目**: 生成完了までの時間
  - **目標値**: 30秒以内
  - **測定条件**: 1,000文字の入力テキスト
  - **信頼性**: 🟡 *Bedrock処理時間から推測*

### NFR-101: HTTPS通信 🔵

**信頼性**: 🔵 *PRD第3章より*

- [ ] **TC-NFR-101-01**: HTTPS強制
  - **検証内容**: HTTPリクエストがHTTPSにリダイレクトされる
  - **期待結果**: すべての通信がHTTPS
  - **信頼性**: 🔵 *PRD第3章より*

### NFR-103: データアクセス制御 🔵

**信頼性**: 🔵 *PRD第2章より*

- [ ] **TC-NFR-103-01**: 他ユーザーカードへのアクセス拒否
  - **検証内容**: 他ユーザーのcard_idでAPIを呼び出し
  - **期待結果**: 403 Forbidden または 404 Not Found
  - **信頼性**: 🔵 *認可要件より*

---

## テストケースサマリー

### カテゴリ別件数

| カテゴリ | 正常系 | 異常系 | 境界値 | 合計 |
|---------|--------|--------|--------|------|
| 機能要件 | 15件 | 8件 | 8件 | 31件 |
| 非機能要件 | 4件 | 0件 | 0件 | 4件 |
| **合計** | 19件 | 8件 | 8件 | 35件 |

### 信頼性レベル分布

| レベル | 件数 | 割合 |
|--------|------|------|
| 🔵 青信号 | 26件 | 74% |
| 🟡 黄信号 | 9件 | 26% |
| 🔴 赤信号 | 0件 | 0% |

**品質評価**: ✅ 高品質（青信号が70%以上）

### 優先度別テストケース

- **Must Have**: 24件
- **Should Have**: 11件

---

## テスト実施計画

### Phase 1: MVP基本機能テスト

- REQ-001, REQ-002, REQ-003（認証）
- REQ-021, REQ-022, REQ-023（AI生成）
- REQ-041, REQ-042, REQ-043（LINE通知）
- 優先度: Must Have
- 目標: MVP リリース前

### Phase 2: 拡張機能テスト

- REQ-011, REQ-013, REQ-014（カード管理）
- REQ-031, REQ-032, REQ-033, REQ-034（SRS）
- REQ-051, REQ-052（LINE回答）
- 優先度: Should Have
- 目標: Phase 2 リリース前

### Phase 3: 非機能・セキュリティテスト

- NFR-001 ~ NFR-302（非機能要件）
- REQ-411, REQ-412, REQ-413（セキュリティ）
- 境界値・エッジケース
- 優先度: Must Have + Should Have
- 目標: 本番リリース前
