# TASK-0031: H-02 CSPå¼·åŒ–

**ã‚¿ã‚¹ã‚¯ID**: TASK-0031
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: DIRECT
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - High ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *H-02: liff-hosting/template.yaml ã®å®Ÿè£…ã‹ã‚‰ç¢ºèªã€ãƒ’ã‚¢ãƒªãƒ³ã‚°ã§æ–¹é‡ç¢ºå®š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-010
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-remediation/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

CloudFront ResponseHeadersPolicy ã® CSP ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ `unsafe-eval` ã‚’é™¤å»ã™ã‚‹ã€‚`unsafe-inline` ã¯ LIFF SDK äº’æ›æ€§ã®ãŸã‚ç¶­æŒã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: ãªã—
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [ ] CSP ãƒ˜ãƒƒãƒ€ãƒ¼ã« `unsafe-eval` ãŒå«ã¾ã‚Œã¦ã„ãªã„ã“ã¨
- [ ] `unsafe-inline` ã¯ç¶­æŒã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [ ] Vite ãƒ“ãƒ«ãƒ‰å‡ºåŠ›ãŒå‹•ä½œã™ã‚‹ã“ã¨
- [ ] ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå›å¸°ãƒ†ã‚¹ãƒˆï¼‰

---

## å®Ÿè£…è©³ç´°

1. ğŸ”µ infrastructure/liff-hosting/template.yaml ã® ContentSecurityPolicy ã‚’ä¿®æ­£
2. ğŸ”µ `script-src` ã‹ã‚‰ `'unsafe-eval'` ã‚’é™¤å»
3. ğŸ”µ `'unsafe-inline'` ã¯ç¶­æŒ
4. ğŸŸ¡ Vite ãƒ“ãƒ«ãƒ‰ã®äº’æ›æ€§ç¢ºèªï¼ˆãƒ“ãƒ«ãƒ‰æ™‚ã« `unsafe-eval` ä¾å­˜ãŒãªã„ã‹ç¢ºèªï¼‰

**Before**: `"default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' ..."`

**After**: `"default-src 'self'; script-src 'self' 'unsafe-inline' ..."`

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

- ğŸ”µ template.yaml ã® CSP æ–‡å­—åˆ—ã« `unsafe-eval` ãŒãªã„ã“ã¨ã‚’ç¢ºèª
- ğŸŸ¡ Vite ãƒ“ãƒ«ãƒ‰ãŒ `unsafe-eval` ãªã—ã§æ­£å¸¸å‹•ä½œã™ã‚‹ã‹ç¢ºèª

---

## å®Ÿè£…æ‰‹é †

### DIRECTã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:direct-setup` - ç›´æ¥å®Ÿè£…ãƒ»è¨­å®š
2. `/tsumiki:direct-verify` - å‹•ä½œç¢ºèªãƒ»å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å®Ÿæ–½
- LIFF SDK ã¯ inline script ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ `unsafe-inline` ã¯å¿…è¦
- Vite ã®å‹•çš„ import ãŒå½±éŸ¿ã‚’å—ã‘ã‚‹å¯èƒ½æ€§ã‚ã‚Šã€‚ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆã§ç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 3 | 1 | 0 | 4 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 1 | 1 | 0 | 2 |

**å“è³ªè©•ä¾¡**: é«˜å“è³ªã€‚CSPä¿®æ­£ç®‡æ‰€ã¯æ˜ç¢ºã€‚Viteãƒ“ãƒ«ãƒ‰ã®äº’æ›æ€§ã®ã¿å®Ÿæ©Ÿç¢ºèªãŒå¿…è¦ã€‚
