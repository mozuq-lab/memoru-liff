# TASK-0026: C-04 DuePush Lambda IAM権限修正

**タスクID**: TASK-0026
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 1 - Critical 修正
**信頼性レベル**: 🔵 *C-04: template.yaml の IAM ポリシーから確認*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-012
- **設計文書**: [📐 architecture.md](../../design/code-review-remediation/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## タスク概要

DuePush Lambda に Users テーブルへの dynamodb:UpdateItem 権限を追加し、last_notified_date の更新が成功するようにする。

## 依存タスク

- **前提タスク**: なし
- **後続タスク**: TASK-0034 (H-05 cron修正)

## 完了条件

- [ ] DuePush Lambda が Users テーブルへの UpdateItem 権限を持つこと
- [ ] template.yaml がバリデーション（sam validate）をパスすること
- [ ] テストがすべてパスすること
- [ ] 既存テストが壊れていないこと（回帰テスト）

---

## 実装詳細

1. 🔵 backend/template.yaml の DuePushJob Lambda の Policies セクションに以下を追加:

### オプション A: SAM ポリシーテンプレート使用

```yaml
- DynamoDBCrudPolicy:
    TableName: !Ref UsersTable
```

### オプション B: 最小権限の明示的 Statement

```yaml
- Statement:
    - Effect: Allow
      Action:
        - dynamodb:UpdateItem
      Resource: !GetAtt UsersTable.Arn
```

---

## 単体テスト要件

- 🔵 SAM テンプレートのバリデーション確認
- 🔵 IAM ポリシーに UpdateItem が含まれていることを確認

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
2. `/tsumiki:direct-verify` - 動作確認・品質確認

---

## 注意事項

- 実際のデプロイはユーザーが手動で実施
- DynamoDBCrudPolicy は Read/Write の両方を含むので、不要な権限が含まれる可能性あり。最小権限の原則に従う場合は明示的な Statement を使用

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 1 | 0 | 0 | 1 |
| 単体テスト | 2 | 0 | 0 | 2 |

**品質評価**: すべての項目が🔵であり、template.yaml の修正箇所が明確。高い信頼性で実装可能。
