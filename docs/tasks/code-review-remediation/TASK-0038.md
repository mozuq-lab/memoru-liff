# TASK-0038: H-09 ProtectedRouteä¿®æ­£

**ã‚¿ã‚¹ã‚¯ID**: TASK-0038
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - High ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *H-09: ProtectedRoute.tsx ã®å®Ÿè£…ã‹ã‚‰ç¢ºèª*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-008, REQ-CR-104
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-remediation/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ProtectedRoute ã§ render ä¸­ã® login() å‘¼ã³å‡ºã—ã‚’ useEffect + loginAttempted ãƒ•ãƒ©ã‚°ã«å¤‰æ›´ã—ã€ç„¡é™ãƒ«ãƒ¼ãƒ—ã‚’é˜²æ­¢ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: ãªã— (TASK-0025 æ¨å¥¨)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [ ] login() ãŒ useEffect å†…ã§å‘¼ã°ã‚Œã‚‹ã“ã¨
- [ ] login() ãŒ1å›ã®ã¿å‘¼ã°ã‚Œã‚‹ã“ã¨ï¼ˆç„¡é™ãƒ«ãƒ¼ãƒ—ãªã—ï¼‰
- [ ] èªè¨¼æˆåŠŸå¾Œã« children ãŒãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨
- [ ] login() å¤±æ•—æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
- [ ] ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå›å¸°ãƒ†ã‚¹ãƒˆï¼‰

---

## å®Ÿè£…è©³ç´°

1. ğŸ”µ frontend/src/components/common/ProtectedRoute.tsx ã‚’ä¿®æ­£:
   - useState ã§ loginAttempted ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
   - useEffect å†…ã§ login() ã‚’å‘¼ã³å‡ºã—ï¼ˆrender ä¸­ã®ç›´æ¥å‘¼ã³å‡ºã—ã‚’ç§»å‹•ï¼‰
   - loginAttempted ãŒ true ã‹ã¤æœªèªè¨¼ã®å ´åˆã¯ Loading è¡¨ç¤ºï¼ˆå†è©¦è¡Œãªã—ï¼‰

2. ğŸŸ¡ login() å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ç”»é¢è¡¨ç¤º

### ã‚³ãƒ¼ãƒ‰ä¾‹

```typescript
const ProtectedRoute: React.FC<Props> = ({ children }) => {
  const { isAuthenticated, isLoading } = useAuth();
  const [loginAttempted, setLoginAttempted] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (!isLoading && !isAuthenticated && !loginAttempted) {
      setLoginAttempted(true);
      authService.login().catch((err) => {
        setError('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    }
  }, [isLoading, isAuthenticated, loginAttempted]);

  if (error) return <ErrorPage message={error} />;
  if (isLoading) return <Loading />;
  if (!isAuthenticated) return <Loading />;
  return <>{children}</>;
};
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

- ğŸ”µ login() ãŒ useEffect å†…ã§1å›ã®ã¿å‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸ”µ èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ children ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸŸ¡ login() å¤±æ•—æ™‚ã«ã‚¨ãƒ©ãƒ¼ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸ”µ isLoading ä¸­ã« Loading ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0038` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- ç„¡é™ãƒ«ãƒ¼ãƒ—ã®åŸå› : render ä¸­ã® login() â†’ å¤±æ•— â†’ å†ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° â†’ login() â†’ ...
- loginAttempted ãƒ•ãƒ©ã‚°ã§1å›ã®ã¿ã«åˆ¶é™

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 1 | 1 | 0 | 2 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 3 | 1 | 0 | 4 |

**å“è³ªè©•ä¾¡**: é«˜å“è³ªã€‚React ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã«å¾“ã£ãŸä¿®æ­£ã€‚login() å¤±æ•—æ™‚ã® UI ã®ã¿è¦è¨­è¨ˆã€‚
