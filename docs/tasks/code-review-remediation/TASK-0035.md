# TASK-0035: H-06 Race Conditionå¯¾ç­–

**ã‚¿ã‚¹ã‚¯ID**: TASK-0035
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - High ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *H-06: card_service.py ã®å®Ÿè£…ã‹ã‚‰ç¢ºèªã€ãƒ’ã‚¢ãƒªãƒ³ã‚°ã§ ConditionExpression æ–¹å¼ã«ç¢ºå®š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-015
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-remediation/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ã‚«ãƒ¼ãƒ‰ä½œæˆæ™‚ã® TransactWriteItems ã« ConditionExpression (`card_count < 2000`) ã‚’è¿½åŠ ã—ã€ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ã® Race Condition ã‚’é˜²æ­¢ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: ãªã—
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [x] ConditionExpression ãŒ TransactWriteItems ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [x] card_count >= 2000 ã®å ´åˆã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¤±æ•—ã™ã‚‹ã“ã¨
- [x] TransactionCanceledException ãŒé©åˆ‡ã«ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã•ã‚Œã‚‹ã“ã¨
- [x] ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [x] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå›å¸°ãƒ†ã‚¹ãƒˆï¼‰

---

## å®Ÿè£…è©³ç´°

1. ğŸ”µ backend/src/services/card_service.py ã®ã‚«ãƒ¼ãƒ‰ä½œæˆãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã« ConditionExpression ã‚’è¿½åŠ :

```python
transact_items = [
    {
        'Update': {
            'TableName': 'memoru-users',
            'Key': {'user_id': {'S': user_id}},
            'UpdateExpression': 'SET card_count = card_count + :inc',
            'ConditionExpression': 'card_count < :limit',
            'ExpressionAttributeValues': {
                ':inc': {'N': '1'},
                ':limit': {'N': '2000'}
            }
        }
    },
    # ... cards, reviews ã® Put
]
```

2. ğŸ”µ TransactionCanceledException ã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°è¿½åŠ :
   - `CARD_LIMIT_EXCEEDED` ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰ã§ 400 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™

3. ğŸŸ¡ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­è¨ˆï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

- ğŸ”µ card_count < 2000 ã§ã‚«ãƒ¼ãƒ‰ä½œæˆãŒæˆåŠŸã™ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸ”µ card_count >= 2000 ã§ã‚«ãƒ¼ãƒ‰ä½œæˆãŒå¤±æ•—ã™ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ (EDGE-CR-101)
- ğŸ”µ TransactionCanceledException ãŒ CARD_LIMIT_EXCEEDED ã«å¤‰æ›ã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0035` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- DynamoDB ã®ãƒã‚¤ãƒ†ã‚£ãƒ–æ©Ÿèƒ½ã§ Race Condition ã‚’ç¢ºå®Ÿã«é˜²æ­¢
- Atomic Counter ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ã¯ãªã ConditionExpression æ–¹å¼ã‚’æ¡ç”¨ï¼ˆãƒ’ã‚¢ãƒªãƒ³ã‚°ã§ç¢ºå®šï¼‰

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 2 | 1 | 0 | 3 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 3 | 0 | 0 | 3 |

**å“è³ªè©•ä¾¡**: é«˜å“è³ªã€‚DynamoDB ã® ConditionExpression ã¯å®Ÿç¸¾ã‚ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã€‚ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­è¨ˆã®ã¿è¦æ¤œè¨ã€‚
