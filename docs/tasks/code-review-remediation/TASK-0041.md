# TASK-0041: H-12 CloudWatch Logs保存期間設定

**タスクID**: TASK-0041
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 2 - High 修正
**信頼性レベル**: 🟡 *H-12: Claude Infra が検出、設定値は推定*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-413
- **設計文書**: [📐 architecture.md](../../design/code-review-remediation/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## タスク概要

各 Lambda の CloudWatch Logs LogGroup に保存期間を設定する。本番90日、開発14日。

## 依存タスク

- **前提タスク**: なし
- **後続タスク**: なし

## 完了条件

- [ ] 各 Lambda の LogGroup に RetentionInDays が設定されていること
- [ ] 本番: 90日、開発: 14日であること
- [ ] template.yaml がバリデーションをパスすること
- [ ] テストがすべてパスすること
- [ ] 既存テストが壊れていないこと（回帰テスト）

---

## 実装詳細

1. 🟡 backend/template.yaml に各 Lambda の LogGroup リソースを追加:

```yaml
ApiLogGroup:
  Type: AWS::Logs::LogGroup
  Properties:
    LogGroupName: !Sub "/aws/lambda/${MemoruApiFunction}"
    RetentionInDays: !If [IsProd, 90, 14]
```

2. 🟡 IsProd 条件が未定義の場合は追加:

```yaml
Conditions:
  IsProd: !Equals [!Ref Environment, 'prod']
```

3. 🟡 DuePushJob、LineWebhook 等の他の Lambda にも同様に設定

---

## 単体テスト要件

- 🟡 template.yaml の構文バリデーション
- 🟡 RetentionInDays の値確認

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
2. `/tsumiki:direct-verify` - 動作確認・品質確認

---

## 注意事項

- 実際のデプロイはユーザーが手動で実施
- 年間 $50-200 のコスト削減見込み
- 既存の LogGroup がある場合は RetentionInDays プロパティの追加のみ

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 0 | 3 | 0 | 3 |
| 単体テスト | 0 | 2 | 0 | 2 |

**品質評価**: 中品質。CloudWatch Logs の RetentionInDays 設定は標準的だが、具体的な Lambda 関数名は実装時に template.yaml を確認して決定する必要がある。
