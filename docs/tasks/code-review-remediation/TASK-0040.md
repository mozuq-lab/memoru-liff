# TASK-0040: H-11 NAT Gatewayæœ€é©åŒ–

**ã‚¿ã‚¹ã‚¯ID**: TASK-0040
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: DIRECT
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - High ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *H-11: Claude Infra ãŒæ¤œå‡ºã€è¨­å®šå€¤ã¯æ¨å®š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-414
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-remediation/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

é–‹ç™ºç’°å¢ƒã® NAT Gateway ã‚’æ¡ä»¶ä»˜ãã§å‰Šé™¤ã—ã€ECS ã‚¿ã‚¹ã‚¯ã‚’ Public Subnet ã«é…ç½®ã—ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: ãªã—
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [ ] æœ¬ç•ªç’°å¢ƒã§ NAT Gateway ãŒä½œæˆã•ã‚Œã‚‹ã“ã¨
- [ ] é–‹ç™ºç’°å¢ƒã§ NAT Gateway ãŒä½œæˆã•ã‚Œãªã„ã“ã¨
- [ ] é–‹ç™ºç’°å¢ƒã§ ECS ã‚¿ã‚¹ã‚¯ãŒ Public Subnet ã«é…ç½®ã•ã‚Œã‚‹ã“ã¨
- [ ] template.yaml ãŒãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [ ] ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå›å¸°ãƒ†ã‚¹ãƒˆï¼‰

---

## å®Ÿè£…è©³ç´°

1. ğŸŸ¡ infrastructure/keycloak/template.yaml ã« Condition ã‚’è¿½åŠ :

```yaml
Conditions:
  CreateNatGateway: !Equals [!Ref Environment, 'prod']
```

2. ğŸŸ¡ NAT Gateway ãƒªã‚½ãƒ¼ã‚¹ã« Condition ã‚’è¨­å®š:

```yaml
NatGateway:
  Type: AWS::EC2::NatGateway
  Condition: CreateNatGateway
```

3. ğŸŸ¡ ECS Service ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯è¨­å®šã‚’æ¡ä»¶åˆ†å²:

```yaml
ECSService:
  Properties:
    NetworkConfiguration:
      AwsvpcConfiguration:
        Subnets: !If [CreateNatGateway, !Ref PrivateSubnets, !Ref PublicSubnets]
        AssignPublicIp: !If [CreateNatGateway, DISABLED, ENABLED]
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

- ğŸŸ¡ template.yaml ã®æ§‹æ–‡ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
- ğŸŸ¡ Condition ã®è«–ç†ç¢ºèª

---

## å®Ÿè£…æ‰‹é †

### DIRECTã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:direct-setup` - ç›´æ¥å®Ÿè£…ãƒ»è¨­å®š
2. `/tsumiki:direct-verify` - å‹•ä½œç¢ºèªãƒ»å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- å®Ÿéš›ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§å®Ÿæ–½
- å¹´é–“ $360-480 ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›è¦‹è¾¼ã¿
- é–‹ç™ºç’°å¢ƒã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒ™ãƒ«ã¯ä½ä¸‹ã™ã‚‹ãŒè¨±å®¹ç¯„å›²

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 0 | 3 | 0 | 3 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 0 | 2 | 0 | 2 |

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªã€‚CloudFormation ã® Condition ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ¨™æº–çš„ã ãŒã€å…·ä½“çš„ãªãƒªã‚½ãƒ¼ã‚¹åã‚„ã‚µãƒ–ãƒãƒƒãƒˆæ§‹æˆã¯å®Ÿè£…æ™‚ã«ç¢ºèªãŒå¿…è¦ã€‚
