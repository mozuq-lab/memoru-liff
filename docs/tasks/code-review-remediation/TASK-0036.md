# TASK-0036: H-07 Bedrockリトライジッター

**タスクID**: TASK-0036
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 2 - High 修正
**信頼性レベル**: 🔵 *H-07: bedrock.py の実装から確認*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-016
- **設計文書**: [📐 architecture.md](../../design/code-review-remediation/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## タスク概要

Bedrock API リトライにフルジッター (Full Jitter) エクスポネンシャルバックオフを適用し、Thundering Herd 問題を緩和する。

## 依存タスク

- **前提タスク**: なし
- **後続タスク**: なし

## 完了条件

- [x] リトライ時にフルジッターが適用されていること
- [x] 最大待機時間が30秒を超えないこと
- [x] 既存のリトライ動作が維持されていること
- [x] テストがすべてパスすること
- [x] 既存テストが壊れていないこと（回帰テスト）

---

## 実装詳細

1. 🔵 backend/src/services/bedrock.py にジッター付きリトライロジックを追加:

```python
import random

def _retry_with_jitter(self, attempt: int) -> float:
    """Full Jitter Exponential Backoff"""
    max_delay = min(2 ** attempt, 30)  # 最大30秒
    return random.uniform(0, max_delay)
```

2. 🔵 既存のリトライロジックにジッターを組み込む

---

## 単体テスト要件

- 🔵 ジッターが0以上max_delay以下の範囲であることをテスト
- 🔵 エクスポネンシャルバックオフの指数が正しいことをテスト (EDGE-CR-103)
- 🔵 最大待機時間が30秒を超えないことをテスト

---

## 実装手順

### TDDタスクの場合
1. `/tsumiki:tdd-requirements TASK-0036` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- Full Jitter: `sleep = random(0, min(cap, base * 2^attempt))`
- AWS の推奨パターンに従う

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 2 | 0 | 0 | 2 |
| 単体テスト | 3 | 0 | 0 | 3 |

**品質評価**: 高品質。AWS 推奨のフルジッターパターンに従った明確な実装。
