# TASK-0033: H-04 LINEé€£æºè§£é™¤API

**ã‚¿ã‚¹ã‚¯ID**: TASK-0033
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - High ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *H-04: Frontend UI ã¨ Backend ã®å®Ÿè£…å·®ã‹ã‚‰ç¢ºèª*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-018
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-remediation/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

LINE ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºè§£é™¤ã® Backend API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ (POST /users/me/unlink-line) ã‚’æ–°è¦å®Ÿè£…ã™ã‚‹ã€‚Frontend ã« UI ã¯æ—¢ã«å­˜åœ¨ã™ã‚‹ãŒ Backend å®Ÿè£…ãŒãªã„ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: ãªã—
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [x] POST /users/me/unlink-line ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãŒå®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã“ã¨
- [x] line_user_id ãŒæ­£ã—ã REMOVE ã•ã‚Œã‚‹ã“ã¨
- [x] æœªé€£æºçŠ¶æ…‹ã§ã®è§£é™¤è©¦è¡Œã§ 400 ã‚¨ãƒ©ãƒ¼ãŒè¿”ã‚‹ã“ã¨
- [x] ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [x] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå›å¸°ãƒ†ã‚¹ãƒˆï¼‰

---

## å®Ÿè£…è©³ç´°

1. ğŸ”µ backend/src/api/handler.py ã«ãƒ«ãƒ¼ãƒˆè¿½åŠ :

```python
@app.post("/users/me/unlink-line")
def unlink_line():
    user_id = app.current_event.request_context.authorizer.claims["sub"]
    result = user_service.unlink_line(user_id)
    return {"success": True, "data": result}
```

2. ğŸ”µ backend/src/services/user_service.py ã« unlink_line ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ :

```python
def unlink_line(self, user_id: str) -> dict:
    self.users_table.update_item(
        Key={'user_id': user_id},
        UpdateExpression='REMOVE line_user_id SET updated_at = :now',
        ConditionExpression='attribute_exists(line_user_id)',
        ExpressionAttributeValues={':now': datetime.now(timezone.utc).isoformat()}
    )
    return {"user_id": user_id, "unlinked_at": datetime.now(timezone.utc).isoformat()}
```

3. ğŸ”µ backend/template.yaml ã« API ã‚¤ãƒ™ãƒ³ãƒˆè¿½åŠ :

```yaml
UnlinkLineEvent:
  Type: Api
  Properties:
    Path: /users/me/unlink-line
    Method: post
    RestApiId: !Ref MemoruApi
```

4. ğŸŸ¡ æœªé€£æºçŠ¶æ…‹ã§ã®è§£é™¤è©¦è¡Œã«å¯¾ã™ã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° (400 LINE_NOT_LINKED)

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

- ğŸ”µ æ­£å¸¸ç³»: é€£æºæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£é™¤ã§line_user_idãŒREMOVEã•ã‚Œã‚‹ã“ã¨
- ğŸ”µ ç•°å¸¸ç³»: æœªé€£æºãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è§£é™¤è©¦è¡Œã§400ã‚¨ãƒ©ãƒ¼ãŒè¿”ã‚‹ã“ã¨
- ğŸ”µ JWT ã‹ã‚‰æ­£ã—ã user_id ãŒå–å¾—ã•ã‚Œã‚‹ã“ã¨

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0033` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- Frontend ã®é€£æºè§£é™¤ UI ã¯æ—¢å­˜ã€‚Backend å®Ÿè£…ã®ã¿ãŒå¿…è¦
- datetime.now(timezone.utc) ã‚’ä½¿ç”¨ï¼ˆH-01 çµ±ä¸€ã«åˆã‚ã›ã‚‹ï¼‰

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 3 | 1 | 0 | 4 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 3 | 0 | 0 | 3 |

**å“è³ªè©•ä¾¡**: é«˜å“è³ªã€‚API ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯æ—¢å­˜ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«æº–æ‹ ã€‚ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è©³ç´°ã®ã¿è¦è¨­è¨ˆã€‚
