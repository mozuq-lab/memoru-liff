# TASK-0028: C-06 LINEç½²åã‚¿ã‚¤ãƒŸãƒ³ã‚°æ”»æ’ƒå¯¾ç­–

**ã‚¿ã‚¹ã‚¯ID**: TASK-0028
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 4æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 1 - Critical ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *C-06: line_service.py ã®å®Ÿè£…ã‹ã‚‰ç¢ºèª*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-009
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-remediation/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

LINE Webhook ç½²åæ¤œè¨¼ã§ã€ç©ºç½²åã®å ´åˆã®æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ (`if not signature: return False`) ã‚’å‰Šé™¤ã—ã€å¸¸ã« hmac.compare_digest ã‚’é€šã™ã‚ˆã†ã«ä¿®æ­£ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: ãªã—
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [ ] ç©ºç½²åã§ã‚‚ hmac.compare_digest ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨
- [ ] æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ãŒå­˜åœ¨ã—ãªã„ã“ã¨
- [ ] æ­£å¸¸ãªç½²åãŒå¼•ãç¶šãæ¤œè¨¼ã«æˆåŠŸã™ã‚‹ã“ã¨
- [ ] ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå›å¸°ãƒ†ã‚¹ãƒˆï¼‰

---

## å®Ÿè£…è©³ç´°

1. ğŸ”µ backend/src/services/line_service.py ã® verify_signature ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä¿®æ­£:
   - `if not signature: return False` ã®æ—©æœŸãƒªã‚¿ãƒ¼ãƒ³ã‚’å‰Šé™¤
   - signature ãŒ None ã®å ´åˆã¯ç©ºæ–‡å­—åˆ—ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - å¸¸ã« hmac.compare_digest(expected, signature) ã‚’å®Ÿè¡Œ

### ã‚³ãƒ¼ãƒ‰ä¾‹

```python
def verify_signature(self, body: str, signature: str | None) -> bool:
    if signature is None:
        signature = ""
    hash_value = hmac.new(
        self.channel_secret.encode('utf-8'),
        body.encode('utf-8'),
        hashlib.sha256
    ).digest()
    expected = base64.b64encode(hash_value).decode('utf-8')
    return hmac.compare_digest(expected, signature)
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

- ğŸ”µ æ­£å¸¸ãªç½²åã§ True ãŒè¿”ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸ”µ ä¸æ­£ãªç½²åã§ False ãŒè¿”ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸ”µ ç©ºç½²åï¼ˆNoneï¼‰ã§ False ãŒè¿”ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸ”µ ç©ºæ–‡å­—åˆ—ç½²åã§ False ãŒè¿”ã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0028` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- hmac.compare_digest ã¯ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚»ãƒ¼ãƒ•ãªæ¯”è¼ƒã‚’è¡Œã†ãŸã‚ã€ç©ºç½²åã§ã‚‚ä¸€å®šæ™‚é–“ã§å‡¦ç†ã•ã‚Œã‚‹
- EDGE-CR-001: ç©ºæ–‡å­—åˆ—ç½²åã®ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 1 | 0 | 0 | 1 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 4 | 0 | 0 | 4 |

**å“è³ªè©•ä¾¡**: ã™ã¹ã¦ã®é …ç›®ãŒğŸ”µã§ã‚ã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿®æ­£ã®å†…å®¹ãŒæ˜ç¢ºã€‚é«˜ã„ä¿¡é ¼æ€§ã§å®Ÿè£…å¯èƒ½ã€‚
