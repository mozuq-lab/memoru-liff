# TASK-0037: H-08 Tokenãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥

**ã‚¿ã‚¹ã‚¯ID**: TASK-0037
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - High ä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *H-08: api.ts ã«æ©Ÿèƒ½ãªã—ã€ãƒ’ã‚¢ãƒªãƒ³ã‚°ã§ interceptor æ–¹å¼ã«ç¢ºå®š*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-007, REQ-CR-102, REQ-CR-103
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-remediation/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

API ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ (api.ts) ã« 401 ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã¨è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹ã€‚ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¯ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’1å›ã«åˆ¶é™ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0025 (C-03 OIDC callback), TASK-0027 (C-05 204 response)
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [ ] 401 ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨
- [ ] ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆåŠŸå¾Œã«å…ƒã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒªãƒˆãƒ©ã‚¤ã•ã‚Œã‚‹ã“ã¨
- [ ] ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãŒ1å›ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨
- [ ] ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—æ™‚ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã“ã¨
- [ ] ãƒ†ã‚¹ãƒˆãŒã™ã¹ã¦ãƒ‘ã‚¹ã™ã‚‹ã“ã¨
- [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆãŒå£Šã‚Œã¦ã„ãªã„ã“ã¨ï¼ˆå›å¸°ãƒ†ã‚¹ãƒˆï¼‰

---

## å®Ÿè£…è©³ç´°

1. ğŸŸ¡ frontend/src/services/api.ts ã« isRefreshing ãƒ•ãƒ©ã‚°ã¨ refreshPromise ã‚’è¿½åŠ 
2. ğŸŸ¡ request() ãƒ¡ã‚½ãƒƒãƒ‰ã§ 401 ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚ã«ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’è©¦è¡Œ
3. ğŸŸ¡ ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã¯åŒã˜ Promise ã‚’å…±æœ‰ã—ã¦1å›ã®ã¿ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ (EDGE-CR-003)
4. ğŸŸ¡ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—æ™‚ã¯ authService.login() ã§ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### ã‚³ãƒ¼ãƒ‰ä¾‹

```typescript
class ApiClient {
  private isRefreshing = false;
  private refreshPromise: Promise<void> | null = null;

  private async request<T>(url: string, options: RequestInit): Promise<T> {
    const response = await this.fetchWithAuth(url, options);

    if (response.status === 401) {
      if (!this.isRefreshing) {
        this.isRefreshing = true;
        this.refreshPromise = this.refreshToken();
      }
      try {
        await this.refreshPromise;
        return this.request<T>(url, options);
      } catch {
        authService.login();
        throw new AuthError('Session expired');
      } finally {
        this.isRefreshing = false;
        this.refreshPromise = null;
      }
    }

    if (response.status === 204) return undefined as T;
    return response.json();
  }

  private async refreshToken(): Promise<void> {
    await authService.silentRenew();
  }
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

- ğŸŸ¡ 401 ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸŸ¡ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥æˆåŠŸå¾Œã«ãƒªãƒˆãƒ©ã‚¤ãŒè¡Œã‚ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ
- ğŸŸ¡ ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãŒ1å›ã®ã¿å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ (EDGE-CR-003)
- ğŸŸ¡ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—æ™‚ã«login()ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚’ãƒ†ã‚¹ãƒˆ

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0037` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- authService.silentRenew() ã® LIFF WebView ã§ã®å‹•ä½œã¯å®Ÿè£…æ™‚ã«æ¤œè¨¼ãŒå¿…è¦
- TASK-0027 (C-05 204 response) ã®ä¿®æ­£å¾Œã«å®Ÿè£…ã™ã‚‹ã“ã¨ï¼ˆrequest() ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å…±é€šã§ä¿®æ­£ã™ã‚‹ãŸã‚ï¼‰
- TASK-0025 (C-03 OIDC callback) ã§ PKCE ãƒ•ãƒ­ãƒ¼ãŒå®Œçµã—ã¦ã„ã‚‹ã“ã¨ãŒå‰æ

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 0 | 4 | 0 | 4 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 0 | 4 | 0 | 4 |

**å“è³ªè©•ä¾¡**: ä¸­å“è³ªã€‚interceptor ãƒ‘ã‚¿ãƒ¼ãƒ³è‡ªä½“ã¯ä¸€èˆ¬çš„ã ãŒã€LIFF WebView ã§ã® silentRenew å‹•ä½œã«ä¸ç¢ºå®Ÿæ€§ãŒã‚ã‚‹ã€‚å®Ÿè£…æ™‚ã®æ¤œè¨¼ãŒé‡è¦ã€‚
