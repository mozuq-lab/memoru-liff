# TASK-0032: H-03 Keycloak HTTPS強制

**タスクID**: TASK-0032
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 2 - High 修正
**信頼性レベル**: 🔵 *H-03: keycloak/template.yaml の実装から確認*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-remediation/requirements.md) - REQ-CR-011, REQ-CR-105
- **設計文書**: [📐 architecture.md](../../design/code-review-remediation/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-remediation/api-endpoints.md)

## タスク概要

本番環境の Keycloak で HTTPS を強制する。開発環境では HTTP を許可する環境分離を実装する。

## 依存タスク

- **前提タスク**: なし
- **後続タスク**: なし

## 完了条件

- [x] 本番環境で HTTPS が強制されること
- [x] 開発環境で HTTP が引き続き利用可能なこと
- [x] template.yaml がバリデーションをパスすること
- [x] テストがすべてパスすること
- [x] 既存テストが壊れていないこと（回帰テスト）

---

## 実装詳細

1. 🔵 infrastructure/keycloak/template.yaml に Environment パラメータを追加（まだない場合）
2. 🔵 Conditions セクションに `IsProd` 条件を追加
3. 🔵 ECS Task Definition の環境変数を条件付きに:

```yaml
- Name: KC_HTTP_ENABLED
  Value: !If [IsProd, 'false', 'true']
- Name: KC_HOSTNAME_STRICT_HTTPS
  Value: !If [IsProd, 'true', 'false']
```

---

## 単体テスト要件

- 🔵 template.yaml の構文バリデーション
- 🔵 Condition の論理確認

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
2. `/tsumiki:direct-verify` - 動作確認・品質確認

---

## 注意事項

- 実際のデプロイはユーザーが手動で実施
- 既存の Keycloak 設定との互換性確認が必要

---

## 信頼性レベルサマリー

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 3 | 0 | 0 | 3 |
| 単体テスト | 2 | 0 | 0 | 2 |

**品質評価**: 高品質。template.yaml の修正箇所は明確で、CloudFormation の標準パターンに従う。
