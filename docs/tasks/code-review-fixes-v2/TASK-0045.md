# TASK-0045: ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTOçµ±ä¸€ + unlinkLine APIä½¿ç”¨

**ã‚¿ã‚¹ã‚¯ID**: TASK-0045
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - Highä¿®æ­£
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *H-02: handler.py ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨ api.ts ã®æœŸå¾…å‹ã®ä¸ä¸€è‡´ã‚’ç¢ºèª*

## é–¢é€£æ–‡æ›¸

- **æ¦‚è¦**: [ğŸ“‹ overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [ğŸ“‹ requirements.md](../../spec/code-review-fixes-v2/requirements.md) - REQ-V2-031ã€œ033
- **è¨­è¨ˆæ–‡æ›¸**: [ğŸ“ architecture.md](../../design/code-review-fixes-v2/architecture.md)
- **APIä»•æ§˜**: [ğŸ”Œ api-endpoints.md](../../design/code-review-fixes-v2/api-endpoints.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦

ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆè¨­å®šæ›´æ–°ã€LINEé€£æºã€LINEé€£æºè§£é™¤ï¼‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’ User å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«çµ±ä¸€ã™ã‚‹ã€‚ã¾ãŸã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® LINE é€£æºè§£é™¤ã§ updateUser ã®ä»£ã‚ã‚Šã«å°‚ç”¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ unlinkLine ã‚’ä½¿ç”¨ã™ã‚‹ã‚ˆã†ä¿®æ­£ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯

- **å‰æã‚¿ã‚¹ã‚¯**: [TASK-0042: APIãƒ«ãƒ¼ãƒˆçµ±ä¸€](TASK-0042.md), [TASK-0044: LINEé€£æºæœ¬äººæ€§æ¤œè¨¼](TASK-0044.md)ï¼ˆlink_line ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä¿®æ­£ãŒå…ˆè¡Œï¼‰
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—

## å®Œäº†æ¡ä»¶

- [x] `PUT /users/me/settings` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ User å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”å´ã—ã¦ã„ã‚‹
- [x] `POST /users/link-line` ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ User å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”å´ã—ã¦ã„ã‚‹ï¼ˆTASK-0044ã¨é€£æºï¼‰
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã« unlinkLine ãƒ¡ã‚½ãƒƒãƒ‰ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® LINE é€£æºè§£é™¤ãŒ unlinkLine API ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® User å‹ã« timezone ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## å®Ÿè£…è©³ç´°

### 1. è¨­å®šæ›´æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ä¿®æ­£ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: handler.py L184 ãŒ `{success, settings}` ã‚’è¿”å´ã€frontend api.ts L141 ã¯ User å‹ã‚’æœŸå¾…*

update_settings ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ User å‹ã«çµ±ä¸€ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/src/api/handler.py`

```python
# Before:
@app.put("/users/me/settings")
def update_settings():
    user_id = get_user_id_from_jwt()
    body = app.current_event.json_body
    updated_settings = user_service.update_settings(user_id, body)
    return {"success": True, "settings": updated_settings}

# After:
@app.put("/users/me/settings")
def update_settings():
    user_id = get_user_id_from_jwt()
    body = app.current_event.json_body
    user_service.update_settings(user_id, body)
    user = user_service.get_user(user_id)
    return {"success": True, "data": user.to_dict()}
```

### 2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ unlinkLine ãƒ¡ã‚½ãƒƒãƒ‰è¿½åŠ  ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: LinkLinePage.tsx L94 ãŒ usersApi.updateUser() ã‚’ä½¿ç”¨ã€å°‚ç”¨ API ã‚’å‘¼ã‚“ã§ã„ãªã„*

APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã« unlinkLine ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/services/api.ts`

```typescript
// è¿½åŠ :
async unlinkLine(): Promise<User> {
  return this.request<User>('/users/me/unlink-line', {
    method: 'POST',
  });
}
```

### 3. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ LINEé€£æºè§£é™¤ä¿®æ­£ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: å°‚ç”¨ API ã®ä½¿ç”¨*

LinkLinePage ã§ updateUser ã®ä»£ã‚ã‚Šã« unlinkLine ã‚’ä½¿ç”¨ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/pages/LinkLinePage.tsx`

```typescript
// Before:
const updatedUser = await usersApi.updateUser({ line_user_id: null });

// After:
const updatedUser = await usersApi.unlinkLine();
```

### 4. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ Userå‹æ›´æ–° ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-03å¯¾å¿œã§è¿½åŠ ã•ã‚Œã‚‹ timezone ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰*

User å‹ã« timezone ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã€‚

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/types/user.ts`

```typescript
interface User {
  user_id: string;
  line_user_id: string | null;
  card_count: number;
  notification_time: string;
  timezone: string;  // æ–°è¦è¿½åŠ 
  created_at: string;
  updated_at: string;
}
```

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: è¨­å®šæ›´æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒUserå‹ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®æ¤œè¨¼*

**Given**: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: PUT /users/me/settings ã§notification_timeã‚’æ›´æ–°
**Then**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® data ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« User å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå«ã¾ã‚Œã‚‹ã“ã¨

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `backend/tests/api/test_handler.py`

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: è¨­å®šæ›´æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å«ã‚€ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: Userå‹ã®å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ç¢ºèª*

**Given**: LINEé€£æºæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: PUT /users/me/settings ã§è¨­å®šã‚’æ›´æ–°
**Then**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã« user_id, line_user_id, card_count, notification_time, timezone, created_at, updated_at ãŒå«ã¾ã‚Œã‚‹ã“ã¨

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: unlinkLine APIã®å‘¼ã³å‡ºã— ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®APIå‘¼ã³å‡ºã—ç¢ºèª*

**Given**: LINEé€£æºæ¸ˆã¿ã®çŠ¶æ…‹
**When**: LINEé€£æºè§£é™¤ãƒœã‚¿ãƒ³ã‚’æŠ¼ä¸‹
**Then**: POST /users/me/unlink-line ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã“ã¨ï¼ˆupdateUser ã§ã¯ãªã„ï¼‰

**ãƒ†ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/pages/__tests__/LinkLinePage.test.tsx`

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: unlinkLine ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒUserå‹ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: unlinkLine ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼*

**Given**: LINEé€£æºæ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: POST /users/me/unlink-line ã‚’å‘¼ã³å‡ºã™
**Then**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã® data ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« User å‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆline_user_id: nullï¼‰ãŒå«ã¾ã‚Œã‚‹ã“ã¨

---

## çµ±åˆãƒ†ã‚¹ãƒˆè¦ä»¶

### çµ±åˆãƒ†ã‚¹ãƒˆ1: ãƒ¬ã‚¹ãƒãƒ³ã‚¹DTOä¸€è²«æ€§ãƒ†ã‚¹ãƒˆ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *H-02: å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼é–¢é€£ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼çµ±ä¸€*

**ãƒ†ã‚¹ãƒˆå†…å®¹**: GET /users/me, PUT /users/me/settings, POST /users/link-line, POST /users/me/unlink-line ã®å…¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒåŒã˜ User å‹æ§‹é€ ã‚’æŒã¤ã“ã¨
**æœŸå¾…çµæœ**: å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ `{success: true, data: User}` å½¢å¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹

---

## UI/UXè¦ä»¶

### ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜å‡¦ç†ã‚’ç¶­æŒ*

- LINEé€£æºè§£é™¤ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤ºã¯æ—¢å­˜å‡¦ç†ã‚’ç¶­æŒ

### ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†ã‚’ç¶­æŒ*

- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼å¤‰æ›´ã«ã‚ˆã‚‹ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®èª¿æ•´ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚‹

### ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å¤‰æ›´ãªã—*

- ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã®ã¿ã®å¤‰æ›´

### ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ ğŸ”µ

**ä¿¡é ¼æ€§**: ğŸ”µ *å¤‰æ›´ãªã—*

- å¤‰æ›´ãªã—

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯

1. `/tsumiki:tdd-requirements TASK-0045` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …

- TASK-0044 ã§ link_line ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒ User å‹ã«å¤‰æ›´ã•ã‚Œã‚‹ãŸã‚ã€ã“ã®ã‚¿ã‚¹ã‚¯ã§ã¯ update_settings ã¨ unlinkLine ã«é›†ä¸­
- User å‹ã® to_dict() ãƒ¡ã‚½ãƒƒãƒ‰ãŒ timezone ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å«ã‚€ã“ã¨ã‚’ç¢ºèª
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®çŠ¶æ…‹ç®¡ç†ï¼ˆContextç­‰ï¼‰ãŒUserå‹å¤‰æ›´ã«å¯¾å¿œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼

### é …ç›®åˆ¥ä¿¡é ¼æ€§

| ã‚«ãƒ†ã‚´ãƒª | ğŸ”µ é’ | ğŸŸ¡ é»„ | ğŸ”´ èµ¤ | åˆè¨ˆ |
|---------|-------|-------|-------|------|
| å®Ÿè£…è©³ç´° | 4 | 0 | 0 | 4 |
| å˜ä½“ãƒ†ã‚¹ãƒˆ | 4 | 0 | 0 | 4 |
| çµ±åˆãƒ†ã‚¹ãƒˆ | 1 | 0 | 0 | 1 |
| UI/UXè¦ä»¶ | 4 | 0 | 0 | 4 |

### å…¨ä½“è©•ä¾¡

- **ç·é …ç›®æ•°**: 13é …ç›®
- ğŸ”µ **é’ä¿¡å·**: 13é …ç›® (100%)
- ğŸŸ¡ **é»„ä¿¡å·**: 0é …ç›® (0%)
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›® (0%)

**å“è³ªè©•ä¾¡**: âœ… é«˜å“è³ª

**æ¨æ¸¬ãŒå¤šã„é …ç›®**: ãªã—
