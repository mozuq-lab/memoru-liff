# TASK-0043: card_countトランザクション修正

**タスクID**: TASK-0043
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 1 - Critical修正
**信頼性レベル**: 🔵 *CR-02: card_service.py のコード分析で4つの問題を確認*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-fixes-v2/requirements.md) - REQ-V2-011〜014, REQ-V2-101〜103
- **設計文書**: [📐 architecture.md](../../design/code-review-fixes-v2/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-fixes-v2/api-endpoints.md)

## タスク概要

カード作成・削除時の card_count 管理に関するDynamoDBトランザクションの4つの問題を修正する。(1) if_not_exists による安全な加算、(2) TransactionCanceledException のエラー分類、(3) delete_card での card_count 減算、(4) カード作成前のユーザーレコード存在保証。

## 依存タスク

- **前提タスク**: なし
- **後続タスク**: なし

## 完了条件

- [x] カード作成時の card_count 加算に `if_not_exists(card_count, :zero)` が使用されている
- [x] TransactionCanceledException の CancellationReasons を解析し、上限超過とその他のエラーを正確に分類している
- [x] カード削除時にトランザクションで card_count を減算している
- [x] カード作成前に get_or_create_user でユーザーレコードの存在が保証されている
- [x] card_count が負数にならないよう下限チェックがある
- [x] 単体テストカバレッジ80%以上

---

## 実装詳細

### 1. if_not_exists による安全な加算 🔵

**信頼性**: 🔵 *CR-02: card_service.py L106-127 で card_count 属性が存在しない場合にトランザクション失敗*

カード作成トランザクションの UpdateExpression と ConditionExpression を修正する。

**実装ファイル**: `backend/src/services/card_service.py`

```python
# Before:
'UpdateExpression': 'SET card_count = card_count + :inc',
'ConditionExpression': 'card_count < :limit',

# After:
'UpdateExpression': 'SET card_count = if_not_exists(card_count, :zero) + :inc',
'ConditionExpression': 'if_not_exists(card_count, :zero) < :limit',
'ExpressionAttributeValues': {
    ':inc': {'N': '1'},
    ':limit': {'N': '2000'},
    ':zero': {'N': '0'}
}
```

### 2. TransactionCanceledException のエラー分類 🔵

**信頼性**: 🔵 *CR-02: card_service.py L130-132 で一律 CardLimitExceededError に変換している*

CancellationReasons を解析して、上限超過とその他のトランザクション失敗を正確に分類する。

**実装ファイル**: `backend/src/services/card_service.py`

```python
# Before:
except ClientError as e:
    if e.response['Error']['Code'] == 'TransactionCanceledException':
        raise CardLimitExceededError()

# After:
except ClientError as e:
    if e.response['Error']['Code'] == 'TransactionCanceledException':
        reasons = e.response.get('CancellationReasons', [])
        # インデックス0 = Users テーブルの Update（card_count チェック）
        if reasons and reasons[0].get('Code') == 'ConditionalCheckFailed':
            raise CardLimitExceededError()
        # それ以外のトランザクション失敗は内部エラー
        logger.error(f"Transaction failed: {reasons}")
        raise InternalError("Card creation failed")
```

### 3. delete_card での card_count 減算 🔵

**信頼性**: 🔵 *CR-02: card_service.py L234-250 の delete_card で card_count 未減算*

カード削除をトランザクションに変更し、card_count の減算を原子的に行う。

**実装ファイル**: `backend/src/services/card_service.py`

```python
def delete_card(self, user_id: str, card_id: str) -> None:
    client = boto3.client('dynamodb')
    client.transact_write_items(
        TransactItems=[
            {
                'Delete': {
                    'TableName': self.cards_table_name,
                    'Key': {
                        'user_id': {'S': user_id},
                        'card_id': {'S': card_id}
                    },
                    'ConditionExpression': 'attribute_exists(card_id)'
                }
            },
            {
                'Delete': {
                    'TableName': self.reviews_table_name,
                    'Key': {
                        'user_id': {'S': user_id},
                        'card_id': {'S': card_id}
                    }
                }
            },
            {
                'Update': {
                    'TableName': self.users_table_name,
                    'Key': {'user_id': {'S': user_id}},
                    'UpdateExpression': 'SET card_count = card_count - :dec',
                    'ConditionExpression': 'card_count > :zero',
                    'ExpressionAttributeValues': {
                        ':dec': {'N': '1'},
                        ':zero': {'N': '0'}
                    }
                }
            }
        ]
    )
```

### 4. カード作成前のユーザーレコード保証 🔵

**信頼性**: 🔵 *CR-02: handler.py L361 でユーザー存在保証なし*

カード作成ハンドラーで get_or_create_user を事前に呼び出す。

**実装ファイル**: `backend/src/api/handler.py`

```python
@app.post("/cards")
def create_cards():
    user_id = get_user_id_from_jwt()
    # ユーザーレコードの存在保証
    user_service.get_or_create_user(user_id)
    # カード作成
    cards = card_service.create_cards(user_id, body['cards'])
    return {"success": True, "data": cards}
```

**実装ファイル**: `backend/src/services/user_service.py`

```python
def get_or_create_user(self, user_id: str) -> User:
    """ユーザーレコードの存在を保証する（なければ作成）"""
    user = self.get_user(user_id)
    if user is None:
        user = self.create_user(user_id)
    return user
```

---

## 単体テスト要件

### テストケース1: if_not_exists で card_count 未存在ユーザーのカード作成 🔵

**信頼性**: 🔵 *CR-02: card_count 属性がないケース*

**Given**: card_count 属性が存在しないユーザーレコード
**When**: カードを作成する
**Then**: card_count が 1 に設定されること

**テストファイル**: `backend/tests/services/test_card_service.py`

### テストケース2: TransactionCanceledException でカード上限超過エラー 🔵

**信頼性**: 🔵 *CR-02: ConditionalCheckFailed で CardLimitExceededError*

**Given**: card_count が上限（2000）に達しているユーザー
**When**: カードを作成する
**Then**: CardLimitExceededError が発生すること

### テストケース3: TransactionCanceledException で内部エラー 🔵

**信頼性**: 🔵 *CR-02: ConditionalCheckFailed 以外のエラー*

**Given**: トランザクションが上限以外の理由で失敗
**When**: カードを作成する
**Then**: InternalError が発生すること（CardLimitExceededError ではない）

### テストケース4: CancellationReasons なしの TransactionCanceledException 🟡

**信頼性**: 🟡 *CR-02: DynamoDB API の例外パターンから推測*

**Given**: CancellationReasons を含まない TransactionCanceledException
**When**: カードを作成する
**Then**: InternalError が発生すること

### テストケース5: delete_card で card_count 減算 🔵

**信頼性**: 🔵 *CR-02: 削除時の card_count 減算*

**Given**: card_count = 5 のユーザーのカード
**When**: カードを削除する
**Then**: card_count が 4 になること

### テストケース6: card_count = 0 での削除防御 🟡

**信頼性**: 🟡 *CR-02: card_count 整合性の境界ケース*

**Given**: card_count = 0 のユーザー
**When**: カードを削除しようとする
**Then**: card_count が負数にならないこと

### テストケース7: get_or_create_user の動作確認 🔵

**信頼性**: 🔵 *CR-02: ユーザー存在保証*

**Given**: 存在しないユーザーID
**When**: get_or_create_user を呼び出す
**Then**: 新しいユーザーレコードが作成され、card_count = 0 で初期化されること

### テストケース8: 既存ユーザーの get_or_create_user 🔵

**信頼性**: 🔵 *CR-02: 既存ユーザーの場合*

**Given**: 既存のユーザーID
**When**: get_or_create_user を呼び出す
**Then**: 既存のユーザーレコードがそのまま返却されること

---

## 統合テスト要件

### 統合テスト1: カード作成→削除のcard_count整合性 🔵

**信頼性**: 🔵 *CR-02: 作成と削除の両方で card_count が正しく更新されること*

**テスト内容**: カード作成で card_count +1、カード削除で card_count -1 がトランザクションで正しく動作すること
**期待結果**: 作成・削除後の card_count が正しい値を維持

---

## UI/UX要件

### ローディング状態 🔵

**信頼性**: 🔵 *バックエンド修正のみ*

- 変更なし（バックエンドのトランザクション処理のみ）

### エラー表示 🔵

**信頼性**: 🔵 *CR-02: エラー分類の改善*

- カード上限超過時: 既存のエラーメッセージを維持
- トランザクション内部エラー時: 汎用的なエラーメッセージ（新規）

### モバイル対応 🔵

**信頼性**: 🔵 *バックエンド修正のみ*

- 変更なし

### アクセシビリティ 🔵

**信頼性**: 🔵 *バックエンド修正のみ*

- 変更なし

---

## 実装手順

### TDDタスク

1. `/tsumiki:tdd-requirements TASK-0043` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- DynamoDB トランザクションの TransactItems の順序に注意（インデックスでエラー分類するため）
- if_not_exists は DynamoDB の組み込み関数で、属性が存在しない場合のデフォルト値を指定する
- delete_card のトランザクション化により、カード存在チェック（ConditionExpression）が必要
- InternalError クラスが既存でない場合は作成が必要

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 4 | 0 | 0 | 4 |
| 単体テスト | 6 | 2 | 0 | 8 |
| 統合テスト | 1 | 0 | 0 | 1 |
| UI/UX要件 | 4 | 0 | 0 | 4 |

### 全体評価

- **総項目数**: 17項目
- 🔵 **青信号**: 15項目 (88%)
- 🟡 **黄信号**: 2項目 (12%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質

**推測が多い項目**: テストケース4（CancellationReasons なし）、テストケース6（card_count=0削除防御）
