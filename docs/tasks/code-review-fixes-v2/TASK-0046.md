# TASK-0046: 通知時刻/タイムゾーン判定

**タスクID**: TASK-0046
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 2 - High修正
**信頼性レベル**: 🔵 *H-03: notification_service.py のコード分析で確認。ユーザヒアリングで DB 属性追加方式に決定*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-fixes-v2/requirements.md) - REQ-V2-041〜042, REQ-V2-111〜112
- **設計文書**: [📐 architecture.md](../../design/code-review-fixes-v2/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-fixes-v2/api-endpoints.md)

## タスク概要

通知送信前にユーザーのタイムゾーンを考慮したローカル時刻を算出し、ユーザー設定の notification_time と一致する場合のみ通知を送信するよう修正する。users テーブルに timezone 属性を追加し、デフォルトは Asia/Tokyo とする。

## 依存タスク

- **前提タスク**: なし（独立タスク）
- **後続タスク**: なし

## 完了条件

- [ ] notification_service.py に should_notify メソッドが実装されている
- [ ] ユーザーのタイムゾーンを考慮したローカル時刻計算が正しい
- [ ] notification_time とローカル時刻の一致判定（±5分精度）が実装されている
- [ ] タイムゾーン未設定の場合 Asia/Tokyo がデフォルトとして使用される
- [ ] process_notifications で should_notify を使用している
- [ ] User モデルに timezone 属性が追加されている
- [ ] 設定更新 API で timezone を受け付ける
- [ ] 単体テストカバレッジ80%以上

---

## 実装詳細

### 1. should_notify メソッド追加 🔵

**信頼性**: 🔵 *H-03: notification_service.py L79-86 で時刻チェックなし。設計文書の should_notify 実装に準拠*

通知送信前のタイムゾーン考慮 + 時刻一致判定メソッドを追加する。

**実装ファイル**: `backend/src/services/notification_service.py`

```python
from zoneinfo import ZoneInfo
from datetime import datetime, timezone

def should_notify(self, user, current_utc: datetime) -> bool:
    """ユーザーのローカル時刻が notification_time と一致するか判定"""
    tz_name = user.timezone or 'Asia/Tokyo'
    user_tz = ZoneInfo(tz_name)
    local_time = current_utc.astimezone(user_tz)

    notification_time = user.notification_time or '09:00'

    # ±5分の精度で判定（EventBridge の実行間隔に合わせる）
    notif_hour, notif_min = map(int, notification_time.split(':'))
    local_hour, local_min = local_time.hour, local_time.minute

    notif_total_min = notif_hour * 60 + notif_min
    local_total_min = local_hour * 60 + local_min
    diff = abs(local_total_min - notif_total_min)

    # 日付境界をまたぐケース（23:58 と 00:02 等）
    if diff > 720:
        diff = 1440 - diff

    return diff <= 5
```

### 2. process_notifications の修正 🔵

**信頼性**: 🔵 *H-03: 時刻チェックの追加*

process_notifications 内で should_notify を使用して通知判定する。

**実装ファイル**: `backend/src/services/notification_service.py`

```python
def process_notifications(self):
    current_utc = datetime.now(timezone.utc)
    users = self.user_service.get_linked_users()

    for user in users:
        if user.last_notified_date == current_utc.strftime('%Y-%m-%d'):
            result.skipped += 1
            continue

        if not self.should_notify(user, current_utc):
            result.skipped += 1
            continue

        due_count = self.card_service.get_due_card_count(user.user_id)
        if due_count > 0:
            self.send_notification(user, due_count)
```

### 3. User モデルに timezone 属性追加 🔵

**信頼性**: 🔵 *ユーザヒアリングで DB 属性追加方式に決定*

User モデル（Pydantic）に timezone フィールドを追加する。

**実装ファイル**: `backend/src/models/user.py`（または該当するモデルファイル）

```python
class User(BaseModel):
    user_id: str
    line_user_id: Optional[str] = None
    card_count: int = 0
    notification_time: str = '09:00'
    timezone: str = 'Asia/Tokyo'  # 新規追加
    created_at: Optional[str] = None
    updated_at: Optional[str] = None
```

### 4. 設定更新 API で timezone を受け付ける 🔵

**信頼性**: 🔵 *api-endpoints.md で settings リクエストに timezone が含まれる*

update_settings ハンドラーで timezone パラメータを処理する。

**実装ファイル**: `backend/src/services/user_service.py`

```python
def update_settings(self, user_id: str, settings: dict) -> None:
    update_expression_parts = []
    expression_values = {}

    if 'notification_time' in settings:
        update_expression_parts.append('notification_time = :nt')
        expression_values[':nt'] = settings['notification_time']

    if 'timezone' in settings:
        update_expression_parts.append('timezone = :tz')
        expression_values[':tz'] = settings['timezone']

    # ... 既存の更新処理を拡張
```

---

## 単体テスト要件

### テストケース1: 通知時刻一致（Asia/Tokyo） 🔵

**信頼性**: 🔵 *H-03: 基本的な時刻判定*

**Given**: timezone='Asia/Tokyo', notification_time='09:00', UTC時刻が 00:00 (JST 09:00)
**When**: should_notify を呼び出す
**Then**: True を返すこと

**テストファイル**: `backend/tests/services/test_notification_service.py`

### テストケース2: 通知時刻不一致 🔵

**信頼性**: 🔵 *H-03: 時刻不一致時のスキップ*

**Given**: timezone='Asia/Tokyo', notification_time='09:00', UTC時刻が 06:00 (JST 15:00)
**When**: should_notify を呼び出す
**Then**: False を返すこと

### テストケース3: ±5分の精度判定 🔵

**信頼性**: 🔵 *H-03: EventBridge の実行精度を考慮*

**Given**: timezone='Asia/Tokyo', notification_time='09:00', UTC時刻が 00:03 (JST 09:03)
**When**: should_notify を呼び出す
**Then**: True を返すこと（5分以内）

### テストケース4: ±5分超過 🔵

**信頼性**: 🔵 *H-03: 精度範囲外*

**Given**: timezone='Asia/Tokyo', notification_time='09:00', UTC時刻が 00:06 (JST 09:06)
**When**: should_notify を呼び出す
**Then**: False を返すこと（5分超過）

### テストケース5: タイムゾーン未設定のデフォルト 🟡

**信頼性**: 🟡 *H-03: デフォルトタイムゾーンの設定。日本向けサービスとして妥当な推測*

**Given**: timezone=None（未設定）, notification_time='09:00'
**When**: should_notify を呼び出す
**Then**: Asia/Tokyo として判定されること

### テストケース6: 日付境界をまたぐケース 🟡

**信頼性**: 🟡 *H-03: タイムゾーン変換の境界ケース*

**Given**: timezone='America/New_York', notification_time='23:58', ローカル時刻が 00:01
**When**: should_notify を呼び出す
**Then**: True を返すこと（差分3分）

### テストケース7: 異なるタイムゾーンでの通知判定 🔵

**信頼性**: 🔵 *H-03: 複数タイムゾーン対応*

**Given**: timezone='America/New_York' (UTC-5), notification_time='09:00', UTC時刻が 14:00
**When**: should_notify を呼び出す
**Then**: True を返すこと（EST 09:00）

### テストケース8: process_notifications での should_notify 使用 🔵

**信頼性**: 🔵 *H-03: 統合動作確認*

**Given**: 通知時刻と一致するユーザーと不一致のユーザーが混在
**When**: process_notifications を実行
**Then**: 時刻一致ユーザーのみに通知が送信されること

---

## 統合テスト要件

### 統合テスト1: タイムゾーン対応通知フロー 🔵

**信頼性**: 🔵 *H-03: データフロー図 dataflow.md の通知送信フローより*

**テスト内容**: EventBridge → Lambda → should_notify判定 → 条件付き通知送信の一連のフロー
**期待結果**: タイムゾーンを考慮した正確な通知タイミングで送信

---

## UI/UX要件

### ローディング状態 🔵

**信頼性**: 🔵 *バックエンド修正のみ*

- 変更なし（バッチ処理のため）

### エラー表示 🟡

**信頼性**: 🟡 *無効なタイムゾーン名の扱い*

- 無効なタイムゾーン名が設定された場合のエラーハンドリング

### モバイル対応 🔵

**信頼性**: 🔵 *バックエンド修正のみ*

- 変更なし

### アクセシビリティ 🔵

**信頼性**: 🔵 *バックエンド修正のみ*

- 変更なし

---

## 実装手順

### TDDタスク

1. `/tsumiki:tdd-requirements TASK-0046` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- Python 3.9+ の zoneinfo モジュールを使用（Lambda Python 3.12 で利用可能）
- DynamoDB はスキーマレスのため DDL 変更不要。既存レコードに timezone がない場合はコード側でデフォルト処理
- EventBridge の cron 実行間隔（5分）と ±5分判定の関係に注意
- notification_time のフォーマットは HH:MM（24時間制）を前提

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 4 | 0 | 0 | 4 |
| 単体テスト | 6 | 2 | 0 | 8 |
| 統合テスト | 1 | 0 | 0 | 1 |
| UI/UX要件 | 3 | 1 | 0 | 4 |

### 全体評価

- **総項目数**: 17項目
- 🔵 **青信号**: 14項目 (82%)
- 🟡 **黄信号**: 3項目 (18%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質

**推測が多い項目**: テストケース5（デフォルトTZ）、テストケース6（日付境界）、エラー表示（無効TZ）
