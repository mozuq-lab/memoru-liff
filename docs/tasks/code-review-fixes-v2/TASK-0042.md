# TASK-0042: APIルート統一（3レイヤー整合性修正）

**タスクID**: TASK-0042
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 1 - Critical修正
**信頼性レベル**: 🔵 *CR-01: コード分析で3レイヤー不一致を確認。設計文書 api-endpoints.md 準拠をユーザヒアリングで決定*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-fixes-v2/requirements.md) - REQ-V2-001〜004
- **設計文書**: [📐 architecture.md](../../design/code-review-fixes-v2/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-fixes-v2/api-endpoints.md)

## タスク概要

SAMテンプレート、Lambdaハンドラー、フロントエンドAPIクライアントの3レイヤーでAPIパスが不一致になっている問題を修正する。設計文書（api-endpoints.md）の定義を単一ソースとし、3つのエンドポイント（設定更新、レビュー送信、LINE連携）のパスを統一する。

## 依存タスク

- **前提タスク**: なし
- **後続タスク**: [TASK-0044: LINE連携本人性検証 + httpx統一](TASK-0044.md), [TASK-0045: レスポンスDTO統一 + unlinkLine API使用](TASK-0045.md)

## 完了条件

- [x] SAMテンプレートの設定更新イベントパスが `PUT /users/me/settings` に修正されている
- [x] SAMテンプレートのレビュー送信イベントパスが `POST /reviews/{cardId}` に修正されている
- [x] SAMテンプレートにLINE連携エンドポイント `POST /users/link-line` のイベント定義が追加されている
- [x] フロントエンドAPIクライアントのLINE連携パスが `POST /users/link-line` に統一されている
- [x] 3レイヤー（SAM/handler/frontend）で全エンドポイントのパスが一致している
- [x] 既存テストが修正後のパスで通ること
- [x] 単体テストカバレッジ80%以上

---

## 実装詳細

### 1. SAMテンプレート設定更新パス修正 🔵

**信頼性**: 🔵 *CR-01: SAM L255-260 が `PUT /users/me` で handler `PUT /users/me/settings` と不一致。api-endpoints.md に準拠*

SAMテンプレートの `UpdateSettingsEvent` のパスを修正する。

**実装ファイル**: `backend/template.yaml`

```yaml
# Before:
UpdateSettingsEvent:
  Type: Api
  Properties:
    Path: /users/me
    Method: put

# After:
UpdateSettingsEvent:
  Type: Api
  Properties:
    Path: /users/me/settings
    Method: put
```

### 2. SAMテンプレートレビュー送信パス修正 🔵

**信頼性**: 🔵 *CR-01: SAM L305-310 が `POST /reviews` でパスパラメータなし。handler/frontend は `/reviews/<card_id>` で一致*

SAMテンプレートの `SubmitReviewEvent` にパスパラメータを追加する。

**実装ファイル**: `backend/template.yaml`

```yaml
# Before:
SubmitReviewEvent:
  Type: Api
  Properties:
    Path: /reviews
    Method: post

# After:
SubmitReviewEvent:
  Type: Api
  Properties:
    Path: /reviews/{cardId}
    Method: post
```

### 3. SAMテンプレートLINE連携イベント追加 🔵

**信頼性**: 🔵 *CR-01: SAM に LINE 連携イベント定義が欠落*

SAMテンプレートに `LinkLineEvent` を新規追加する。

**実装ファイル**: `backend/template.yaml`

```yaml
# 追加:
LinkLineEvent:
  Type: Api
  Properties:
    Path: /users/link-line
    Method: post
    RestApiId: !Ref MemoruApi
```

### 4. フロントエンドLINE連携パス修正 🔵

**信頼性**: 🔵 *CR-01: frontend api.ts L149 が `/users/me/link-line` で handler `/users/link-line` と不一致*

フロントエンドAPIクライアントのLINE連携パスを修正する。

**実装ファイル**: `frontend/src/services/api.ts`

```typescript
// Before:
async linkLine(data: { line_user_id: string }): Promise<User> {
  return this.request<User>('/users/me/link-line', {
    method: 'POST',
    body: JSON.stringify(data),
  });
}

// After:
async linkLine(data: { id_token: string }): Promise<User> {
  return this.request<User>('/users/link-line', {
    method: 'POST',
    body: JSON.stringify(data),
  });
}
```

---

## 単体テスト要件

### テストケース1: SAMテンプレートパス整合性 🔵

**信頼性**: 🔵 *CR-01: 3レイヤー整合性を検証*

**Given**: 修正後のSAMテンプレート
**When**: テンプレートのイベント定義を検証
**Then**: 設定更新が `/users/me/settings`、レビュー送信が `/reviews/{cardId}`、LINE連携が `/users/link-line` であること

**テストファイル**: `backend/tests/test_template_routes.py`

### テストケース2: フロントエンドAPIパス確認 🔵

**信頼性**: 🔵 *CR-01: フロントエンドのパス修正確認*

**Given**: 修正後のAPIクライアント
**When**: linkLine メソッドを呼び出す
**Then**: リクエストが `/users/link-line` に送信されること

**テストファイル**: `frontend/src/services/__tests__/api.test.ts`

### テストケース3: 既存テストの回帰確認 🔵

**信頼性**: 🔵 *修正後の全テスト通過を確認*

**Given**: 全テストスイート
**When**: テスト実行
**Then**: すべてのテストが通ること（パス変更に伴うテスト修正含む）

---

## 統合テスト要件

### 統合テスト1: 3レイヤー整合性テスト 🔵

**信頼性**: 🔵 *CR-01: SAM/handler/frontend の全パスが一致すること*

**テスト内容**: SAMテンプレートのパス定義、handlerのルート定義、frontendのAPIパスが全エンドポイントで一致することを検証
**期待結果**: 12個の全エンドポイントで3レイヤーのパスが完全一致

---

## UI/UX要件

### ローディング状態 🔵

**信頼性**: 🔵 *パス変更のみのため既存のローディング処理を維持*

- 既存のローディング状態処理に変更なし

### エラー表示 🔵

**信頼性**: 🔵 *パス変更のみ*

- 既存のエラー表示に変更なし

### モバイル対応 🔵

**信頼性**: 🔵 *パス変更のみ*

- 変更なし

### アクセシビリティ 🔵

**信頼性**: 🔵 *パス変更のみ*

- 変更なし

---

## 実装手順

### TDDタスク

1. `/tsumiki:tdd-requirements TASK-0042` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- API契約の統一は設計文書（api-endpoints.md）を単一ソースとする
- AWSリソースの実際のデプロイはユーザーが手動で実行
- SAMテンプレート変更後はローカルでのビルド確認を推奨
- フロントエンドのlinkLineメソッドの引数型変更は TASK-0044 (H-01) で実施するため、このタスクではパスのみ修正

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 4 | 0 | 0 | 4 |
| 単体テスト | 3 | 0 | 0 | 3 |
| 統合テスト | 1 | 0 | 0 | 1 |
| UI/UX要件 | 4 | 0 | 0 | 4 |

### 全体評価

- **総項目数**: 12項目
- 🔵 **青信号**: 12項目 (100%)
- 🟡 **黄信号**: 0項目 (0%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質

**推測が多い項目**: なし
