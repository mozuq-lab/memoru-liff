# TASK-0044: LINE連携本人性検証 + httpx統一

**タスクID**: TASK-0044
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 2 - High修正
**信頼性レベル**: 🔵 *H-01: ユーザヒアリングで LIFF IDトークン検証方式に決定。H-05: httpx統一に決定*

## 関連文書

- **概要**: [📋 overview.md](overview.md)
- **要件定義**: [📋 requirements.md](../../spec/code-review-fixes-v2/requirements.md) - REQ-V2-021〜023, REQ-V2-121, REQ-V2-052
- **設計文書**: [📐 architecture.md](../../design/code-review-fixes-v2/architecture.md)
- **API仕様**: [🔌 api-endpoints.md](../../design/code-review-fixes-v2/api-endpoints.md)

## タスク概要

LINE連携時のセキュリティ強化として、フロントエンドから line_user_id を直接送信する方式から、LIFF IDトークンをサーバー側で LINE API を使って検証する方式に変更する。同時に、HTTPクライアントライブラリを requests から httpx に統一する（H-05）。LINE Channel ID は環境変数で管理する。

## 依存タスク

- **前提タスク**: [TASK-0042: APIルート統一](TASK-0042.md)（SAMテンプレートにLINE連携イベント定義が必要）
- **後続タスク**: [TASK-0045: レスポンスDTO統一 + unlinkLine API使用](TASK-0045.md)

## 完了条件

- [x] フロントエンドが LIFF IDトークンを送信するよう変更されている
- [x] バックエンドで LINE API を使って IDトークンを検証している
- [x] 検証成功後に取得した line_user_id でのみ連携を確定している
- [x] IDトークン検証失敗時に 401 エラーを返却している
- [x] line_service.py が httpx を使用している（requests を除去）
- [x] requirements.txt に httpx が追加され、requests が除去されている
- [x] LINE_CHANNEL_ID が環境変数として SAM テンプレートに定義されている
- [x] 単体テストカバレッジ80%以上

---

## 実装詳細

### 1. フロントエンド: IDトークン送信 🔵

**信頼性**: 🔵 *H-01: LinkLinePage.tsx L75-77 で line_user_id を直接送信。ユーザヒアリングで LIFF IDトークン検証方式に決定*

フロントエンドのLINE連携処理で、`liff.getProfile()` の代わりに `liff.getIDToken()` を使用する。

**実装ファイル**: `frontend/src/pages/LinkLinePage.tsx`

```typescript
// Before:
const updatedUser = await usersApi.linkLine({
  line_user_id: profile.userId,
});

// After:
const idToken = liff.getIDToken();
if (!idToken) {
  throw new Error('IDトークンを取得できませんでした');
}
const updatedUser = await usersApi.linkLine({
  id_token: idToken,
});
```

### 2. バックエンド: IDトークン検証フロー 🔵

**信頼性**: 🔵 *H-01: handler.py L112-132 で本人性検証なし。ユーザヒアリングで方式決定*

link_line ハンドラーで IDトークンを受信し、LINE API で検証する。

**実装ファイル**: `backend/src/api/handler.py`

```python
@app.post("/users/link-line")
def link_line():
    user_id = get_user_id_from_jwt()
    body = app.current_event.json_body
    id_token = body.get('id_token')

    if not id_token:
        raise BadRequestError("id_token is required")

    # LINE ID トークンを検証して line_user_id を取得
    line_user_id = line_service.verify_id_token(id_token)

    # ユーザーに LINE ID を紐付け
    user = user_service.link_line(user_id, line_user_id)
    return {"success": True, "data": user.to_dict()}
```

### 3. LINE サービス: verify_id_token + httpx統一 🔵

**信頼性**: 🔵 *H-01: LINE Login API 検証。H-05: requests → httpx*

LINE IDトークンの検証メソッドを追加し、HTTPクライアントを httpx に統一する。

**実装ファイル**: `backend/src/services/line_service.py`

```python
import httpx  # requests から httpx に統一

class LineService:
    def __init__(self):
        self.channel_id = os.environ.get('LINE_CHANNEL_ID')

    def verify_id_token(self, id_token: str) -> str:
        """LIFF IDトークンをLINE APIで検証し、line_user_idを返す"""
        response = httpx.post(
            'https://api.line.me/oauth2/v2.1/verify',
            data={
                'id_token': id_token,
                'client_id': self.channel_id,
            }
        )

        if response.status_code != 200:
            raise UnauthorizedError("LINE ID token verification failed")

        data = response.json()
        return data['sub']  # line_user_id
```

### 4. requirements.txt 更新 🔵

**信頼性**: 🔵 *H-05: ユーザヒアリングで httpx 統一に決定*

**実装ファイル**: `backend/requirements.txt`

```
# 追加:
httpx>=0.27.0

# 削除:
# requests（未宣言だが import されていたもの）
```

### 5. SAMテンプレート: LINE_CHANNEL_ID 環境変数追加 🔵

**信頼性**: 🔵 *ユーザヒアリングで環境変数管理に決定*

**実装ファイル**: `backend/template.yaml`

```yaml
# Lambda 関数の環境変数に追加:
Environment:
  Variables:
    LINE_CHANNEL_ID: !Ref LineChannelId

# パラメータに追加:
Parameters:
  LineChannelId:
    Type: String
    Description: LINE Login Channel ID for ID token verification
```

### 6. フロントエンド APIクライアント型変更 🔵

**信頼性**: 🔵 *H-01: リクエストボディの型変更*

**実装ファイル**: `frontend/src/services/api.ts`

```typescript
// linkLine メソッドの引数型を変更
async linkLine(data: { id_token: string }): Promise<User> {
  return this.request<User>('/users/link-line', {
    method: 'POST',
    body: JSON.stringify(data),
  });
}
```

---

## 単体テスト要件

### テストケース1: IDトークン検証成功 🔵

**信頼性**: 🔵 *H-01: 正常系*

**Given**: 有効なLIFF IDトークン
**When**: verify_id_token を呼び出す
**Then**: LINE API が 200 を返し、sub フィールドから line_user_id が取得されること

**テストファイル**: `backend/tests/services/test_line_service.py`

### テストケース2: IDトークン検証失敗（無効トークン） 🔵

**信頼性**: 🔵 *H-01: 検証失敗時の動作*

**Given**: 無効なIDトークン
**When**: verify_id_token を呼び出す
**Then**: UnauthorizedError が発生すること

### テストケース3: IDトークン未送信 🔵

**信頼性**: 🔵 *H-01: バリデーション*

**Given**: id_token フィールドがないリクエスト
**When**: link_line ハンドラーを呼び出す
**Then**: 400 BadRequestError が返却されること

### テストケース4: IDトークン有効期限切れ 🟡

**信頼性**: 🟡 *H-01: IDトークンのライフサイクルから推測*

**Given**: 有効期限切れのIDトークン
**When**: verify_id_token を呼び出す
**Then**: UnauthorizedError が発生すること（LINE API が 400 を返す）

### テストケース5: httpx への移行確認 🔵

**信頼性**: 🔵 *H-05: requests → httpx*

**Given**: line_service.py のコード
**When**: HTTP 呼び出しを実行
**Then**: httpx が使用されていること（requests がインポートされていないこと）

### テストケース6: フロントエンド IDトークン送信 🔵

**信頼性**: 🔵 *H-01: フロントエンド修正*

**Given**: LIFF SDKが初期化済み
**When**: LINE連携ボタンを押下
**Then**: liff.getIDToken() で取得したトークンが送信されること

**テストファイル**: `frontend/src/pages/__tests__/LinkLinePage.test.tsx`

---

## 統合テスト要件

### 統合テスト1: LINE連携E2Eフロー 🔵

**信頼性**: 🔵 *H-01: データフロー図 dataflow.md より*

**テスト内容**: IDトークン送信→LINE API検証→連携確定→User型レスポンス返却の一連のフロー
**期待結果**: IDトークン検証を経由して正しく LINE 連携が完了し、User 型でレスポンスが返却される

---

## UI/UX要件

### ローディング状態 🔵

**信頼性**: 🔵 *既存のローディング処理を維持*

- LINE連携ボタン押下後のローディング表示は既存処理を維持
- LINE API 検証のためレイテンシが若干増加する可能性あり

### エラー表示 🟡

**信頼性**: 🟡 *H-01: IDトークン検証失敗時のUI表示*

- IDトークン検証失敗時: 「LINE連携に失敗しました。再度お試しください。」
- IDトークン取得失敗時: 「LINEの認証情報を取得できませんでした。」

### モバイル対応 🔵

**信頼性**: 🔵 *LIFF SDK はモバイル前提*

- LINEアプリ内ブラウザでの動作を確認

### アクセシビリティ 🔵

**信頼性**: 🔵 *既存のアクセシビリティ処理を維持*

- 変更なし

---

## 実装手順

### TDDタスク

1. `/tsumiki:tdd-requirements TASK-0044` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項

- LINE Login API の verify エンドポイントは `https://api.line.me/oauth2/v2.1/verify`
- LIFF アプリの Channel ID は LINE Developers Console で確認
- IDトークンの有効期限は比較的短い（数分〜数十分）
- httpx は requests とほぼ同じ API なので、import 文の変更が主な修正
- Lambda の実行環境に httpx がインストールされている必要がある（requirements.txt 経由）

---

## 信頼性レベルサマリー

### 項目別信頼性

| カテゴリ | 🔵 青 | 🟡 黄 | 🔴 赤 | 合計 |
|---------|-------|-------|-------|------|
| 実装詳細 | 6 | 0 | 0 | 6 |
| 単体テスト | 5 | 1 | 0 | 6 |
| 統合テスト | 1 | 0 | 0 | 1 |
| UI/UX要件 | 3 | 1 | 0 | 4 |

### 全体評価

- **総項目数**: 17項目
- 🔵 **青信号**: 15項目 (88%)
- 🟡 **黄信号**: 2項目 (12%)
- 🔴 **赤信号**: 0項目 (0%)

**品質評価**: ✅ 高品質

**推測が多い項目**: テストケース4（有効期限切れ）、エラー表示のUI文言
