# TASK-0001: Keycloak ECS/Fargate インフラ構築

**タスクID**: TASK-0001
**タスクタイプ**: DIRECT
**推定工数**: 8時間
**フェーズ**: Phase 1 - 基盤構築
**信頼性レベル**: 🔵 *PRD第3章・architecture.mdより*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-001, REQ-002, REQ-403
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)

## タスク概要
Keycloakを稼働させるためのAWSインフラストラクチャを構築する。ECS/Fargateによるコンテナ実行環境、ALBによるロードバランシング、RDS PostgreSQLによるデータ永続化、ACM証明書によるHTTPS通信を実現する。Infrastructure as Code（CloudFormation/CDK）により再現性のある環境構築を行う。

## 依存タスク
- **前提タスク**: なし
- **後続タスク**: TASK-0002（Keycloak Realm/Client 設定）, TASK-0005（API Gateway + Lambda 基盤構築）

## 完了条件
- [ ] ECSクラスター、タスク定義作成
- [ ] ALB + ACM証明書設定
- [ ] RDS PostgreSQL（Keycloak用）作成
- [ ] セキュリティグループ設定
- [x] CloudFormation/CDKテンプレート作成

---

## 実装詳細

### 1. ECSクラスター・タスク定義作成 🔵
**信頼性**: 🔵 *architecture.mdより*

ECS Fargateクラスターを作成し、Keycloakコンテナを実行するためのタスク定義を設定する。

- **クラスター名**: memoru-keycloak-cluster
- **タスク定義**:
  - CPU: 512（0.5 vCPU）
  - Memory: 1024 MB
  - コンテナイメージ: quay.io/keycloak/keycloak:latest
  - ポート: 8080（HTTP）
  - 環境変数: KC_DB, KC_DB_URL, KC_DB_USERNAME, KC_DB_PASSWORD
  - ログドライバー: awslogs

**実装ファイル**: `infrastructure/keycloak/ecs.yaml`

### 2. ALB + ACM証明書設定 🔵
**信頼性**: 🔵 *architecture.mdより*

Application Load Balancerを設定し、HTTPS通信を可能にする。

- **ALB名**: memoru-keycloak-alb
- **リスナー**:
  - HTTPS:443 → ターゲットグループ
  - HTTP:80 → HTTPS:443リダイレクト
- **ターゲットグループ**:
  - ヘルスチェックパス: /health/ready
  - ヘルスチェック間隔: 30秒
  - 健全性しきい値: 2回
- **ACM証明書**: keycloak.example.com用

**実装ファイル**: `infrastructure/keycloak/alb.yaml`

### 3. RDS PostgreSQL作成 🔵
**信頼性**: 🔵 *PRD第3章より*

Keycloakのデータ永続化用にRDS PostgreSQLインスタンスを作成する。

- **インスタンス識別子**: memoru-keycloak-db
- **インスタンスクラス**: db.t3.micro
- **エンジン**: PostgreSQL 15
- **ストレージ**: 20 GB（gp3）
- **可用性**: Single-AZ（コスト最適化）
- **バックアップ保持期間**: 7日
- **暗号化**: 有効（AWS管理キー）
- **パラメータグループ**: カスタム（文字コードUTF-8）

**実装ファイル**: `infrastructure/keycloak/rds.yaml`

### 4. セキュリティグループ設定 🔵
**信頼性**: 🔵 *architecture.mdより*

最小権限の原則に基づいたセキュリティグループを設定する。

- **ALB用セキュリティグループ**:
  - インバウンド: 0.0.0.0/0 → HTTPS:443, HTTP:80
  - アウトバウンド: ECS SG → 8080
- **ECS用セキュリティグループ**:
  - インバウンド: ALB SG → 8080
  - アウトバウンド: RDS SG → 5432, 0.0.0.0/0 → HTTPS:443
- **RDS用セキュリティグループ**:
  - インバウンド: ECS SG → 5432
  - アウトバウンド: なし

**実装ファイル**: `infrastructure/keycloak/security-groups.yaml`

### 5. Route53レコード設定 🔵
**信頼性**: 🔵 *architecture.mdより*

カスタムドメインでKeycloakにアクセスできるようにRoute53を設定する。

- **レコード名**: keycloak.example.com
- **レコードタイプ**: A（エイリアス）
- **ターゲット**: ALB DNS名
- **ルーティングポリシー**: シンプル

**実装ファイル**: `infrastructure/keycloak/dns.yaml`

### 6. CloudFormation/CDKテンプレート統合 🔵
**信頼性**: 🔵 *PRD第3章より*

すべてのリソースを単一のテンプレートに統合し、パラメータ化する。

- **パラメータ**:
  - Environment: dev/prod
  - DomainName: カスタムドメイン
  - DBMasterPassword: Secrets Manager参照
- **出力**:
  - KeycloakURL
  - ALBDNSName
  - RDSEndpoint

**実装ファイル**: `infrastructure/keycloak/template.yaml`

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
   - IaCファイル作成
   - パラメータ設定
   - デプロイ実行
2. `/tsumiki:direct-verify` - 動作確認・品質確認
   - スタック作成確認
   - リソース疎通確認
   - ヘルスチェック確認

---

## 注意事項
- RDSのマスターパスワードはSecrets Managerを使用して管理すること
- ACM証明書はus-east-1リージョンで作成が必要な場合があるため注意
- Keycloakの初回起動時にadminユーザーの作成が必要
- ECSタスクのメモリ不足に注意（Keycloakは起動時にメモリを多く消費）
- VPC設定は既存VPCを使用するか、新規作成するか事前に決定すること

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 6項目
- 🟡 **黄信号**: 0項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
