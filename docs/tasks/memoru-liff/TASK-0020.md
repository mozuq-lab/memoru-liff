# TASK-0020: E2Eテスト（認証フロー）

**タスクID**: TASK-0020
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 4 - 統合テスト
**信頼性レベル**: 🟡 *acceptance-criteria.mdより妥当な推測*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-001, REQ-002, REQ-003
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)
- **受け入れ基準**: [acceptance-criteria.md](../../spec/memoru-liff/acceptance-criteria.md)

## タスク概要
認証フロー全体のE2Eテストを実装する。Playwright/Cypressを使用し、未認証ユーザーのリダイレクト、Keycloak経由のLINE Login認証、JWT保存確認、エラーケースをカバーするテストスイートを構築する。

## 依存タスク
- **前提タスク**: TASK-0012（Keycloak Identity Brokering設定）, TASK-0019（フロントエンドルーティング）
- **後続タスク**: TASK-0022（本番デプロイ準備）

## 完了条件
- [x] Playwright/Cypress設定完了
- [x] 認証フローE2Eテスト実装
- [x] LINE連携E2Eテスト実装
- [x] エラーケーステスト実装
- [x] すべてのテストがパス

---

## 実装詳細

### 1. E2Eテストフレームワーク設定 🟡
**信頼性**: 🟡 *一般的なE2Eテスト設定パターンから推測*

Playwrightを使用したE2Eテスト環境を構築する。

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:3000',
    trace: 'on-first-retry',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
  ],
  webServer: {
    command: 'npm run dev',
    url: 'http://localhost:3000',
    reuseExistingServer: !process.env.CI,
  },
});
```

**実装ファイル**: `frontend/playwright.config.ts`

### 2. 認証フローE2Eテスト 🟡
**信頼性**: 🟡 *acceptance-criteria.mdより妥当な推測*

未認証ユーザーのリダイレクト、認証成功後のホーム画面遷移をテストする。

```typescript
// frontend/e2e/auth.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Authentication Flow', () => {
  test('TC-001-01: 未認証ユーザーはKeycloakにリダイレクトされる', async ({ page }) => {
    // 未認証状態でホームにアクセス
    await page.goto('/');

    // Keycloak認証ページへリダイレクトされることを確認
    await expect(page).toHaveURL(/.*keycloak.*\/auth/);
  });

  test('TC-001-02: LINE Loginで認証成功後ホーム画面に遷移', async ({ page }) => {
    // モック認証フローを実行
    await page.goto('/');

    // Keycloakページで認証
    await page.click('[data-testid="line-login-button"]');

    // 認証成功後ホーム画面に遷移
    await expect(page).toHaveURL('/home');
    await expect(page.locator('[data-testid="home-container"]')).toBeVisible();
  });

  test('TC-001-03: 認証成功後JWTがlocalStorageに保存される', async ({ page }) => {
    // 認証フローを完了
    await authenticateUser(page);

    // JWTがlocalStorageに保存されていることを確認
    const token = await page.evaluate(() =>
      localStorage.getItem('access_token')
    );
    expect(token).toBeTruthy();
    expect(token).toMatch(/^eyJ/); // JWT形式確認
  });
});
```

**実装ファイル**: `frontend/e2e/auth.spec.ts`

### 3. テストヘルパー・フィクスチャ 🟡
**信頼性**: 🟡 *一般的なテストパターンから推測*

認証状態のセットアップ、モックサーバー設定を行うヘルパーを実装する。

```typescript
// frontend/e2e/fixtures/auth.fixture.ts
import { test as base } from '@playwright/test';

export const test = base.extend({
  authenticatedPage: async ({ page }, use) => {
    // 認証済み状態をセットアップ
    await page.goto('/');
    await page.evaluate((token) => {
      localStorage.setItem('access_token', token);
    }, process.env.TEST_JWT_TOKEN);
    await use(page);
  },
});
```

**実装ファイル**: `frontend/e2e/fixtures/auth.fixture.ts`

### 4. エラーケーステスト 🟡
**信頼性**: 🟡 *一般的なエラーハンドリングパターンから推測*

認証エラー、ネットワークエラー時の挙動をテストする。

```typescript
// frontend/e2e/auth-error.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Authentication Error Cases', () => {
  test('認証キャンセル時はエラーメッセージを表示', async ({ page }) => {
    await page.route('**/auth/callback**', route => {
      route.fulfill({
        status: 400,
        body: JSON.stringify({ error: 'access_denied' }),
      });
    });

    await page.goto('/auth/callback?error=access_denied');
    await expect(page.locator('[data-testid="auth-error"]')).toBeVisible();
  });

  test('トークン期限切れ時は再認証を促す', async ({ page }) => {
    // 期限切れトークンをセット
    await page.evaluate(() => {
      localStorage.setItem('access_token', 'expired_token');
    });

    await page.goto('/home');
    await expect(page).toHaveURL(/.*keycloak.*\/auth/);
  });
});
```

**実装ファイル**: `frontend/e2e/auth-error.spec.ts`

---

## テスト要件

### テストケース1: 未認証ユーザーのリダイレクト 🟡
**信頼性**: 🟡 *acceptance-criteria.mdより推測*
**関連TC**: TC-001-01
**テスト内容**: 未認証状態でアプリにアクセスした場合、Keycloak認証ページにリダイレクトされることを確認する。

### テストケース2: LINE Loginでの認証成功 🟡
**信頼性**: 🟡 *acceptance-criteria.mdより推測*
**関連TC**: TC-001-02
**テスト内容**: LINE Loginボタン経由でKeycloakのLINE Identity Provider認証を完了し、ホーム画面に遷移することを確認する。

### テストケース3: JWT保存確認 🟡
**信頼性**: 🟡 *acceptance-criteria.mdより推測*
**関連TC**: TC-001-03
**テスト内容**: 認証成功後、JWTアクセストークンがlocalStorageに正しく保存されることを確認する。

---

## 実装手順

### TDDタスクの場合
1. `/tsumiki:tdd-requirements TASK-0020` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項
- E2EテストはCI環境での実行時間を考慮し、並列実行設定を最適化すること
- LINE Login認証はKeycloak経由で行われるため、Keycloakのテスト用設定が必要
- 実際のLINE APIへのアクセスは行わず、モックまたはKeycloakのテストユーザーを使用
- トークンの有効期限テストはタイムスタンプ操作が必要なためユニットテストと併用

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 0項目
- 🟡 **黄信号**: 7項目（E2Eテスト設定、認証フローテスト、ヘルパー、エラーケース、TC-001-01〜03）
- 🔴 **赤信号**: 0項目

**品質評価**: 要改善 - acceptance-criteria.mdに基づく推測が主であり、詳細仕様の確認が必要
