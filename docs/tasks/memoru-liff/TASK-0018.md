# TASK-0018: 設定画面（通知時間設定）

**タスクID**: TASK-0018
**タスクタイプ**: TDD
**推定工数**: 4時間
**フェーズ**: Phase 3 - フロントエンド実装
**信頼性レベル**: 🔵 *user-stories.md 4.2より*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-043
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)

## タスク概要
ユーザーが復習通知の時間を設定できる画面を実装する。時間選択UI、設定保存処理、現在の設定値の表示を行う。

## 依存タスク
- **前提タスク**: TASK-0006（ユーザー設定API）, TASK-0014（ホーム画面・ナビゲーション）
- **後続タスク**: なし

## 完了条件
- [x] 通知時間選択UI実装
- [x] 設定保存処理実装
- [x] 単体テスト80%以上のカバレッジ達成

---

## 実装詳細

### 1. 設定画面 🔵
**信頼性**: 🔵 *user-stories.md 4.2より*

通知時間設定を含む設定画面を実装する。

```typescript
// frontend/src/pages/SettingsPage.tsx
import { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import { useAuthContext } from '../contexts/AuthContext';
import { Loading } from '../components/common/Loading';
import { Error } from '../components/common/Error';
import { usersApi } from '../services/api';

interface UserSettings {
  notifyAt: string;
}

const NOTIFICATION_TIMES = [
  { value: '07:00', label: '07:00' },
  { value: '09:00', label: '09:00' },
  { value: '12:00', label: '12:00' },
  { value: '18:00', label: '18:00' },
  { value: '21:00', label: '21:00' },
];

export const SettingsPage = () => {
  const navigate = useNavigate();
  const { user, logout } = useAuthContext();
  const [settings, setSettings] = useState<UserSettings | null>(null);
  const [selectedTime, setSelectedTime] = useState<string>('');
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [error, setError] = useState<string | null>(null);
  const [successMessage, setSuccessMessage] = useState<string | null>(null);

  const fetchSettings = useCallback(async () => {
    setIsLoading(true);
    setError(null);

    try {
      const data = await usersApi.getSettings();
      setSettings(data);
      setSelectedTime(data.notifyAt || '09:00');
    } catch (err) {
      setError('設定の取得に失敗しました');
    } finally {
      setIsLoading(false);
    }
  }, []);

  useEffect(() => {
    fetchSettings();
  }, [fetchSettings]);

  useEffect(() => {
    if (successMessage) {
      const timer = setTimeout(() => setSuccessMessage(null), 3000);
      return () => clearTimeout(timer);
    }
  }, [successMessage]);

  const handleSave = async () => {
    setIsSaving(true);
    setError(null);

    try {
      await usersApi.updateSettings({ notifyAt: selectedTime });
      setSettings({ ...settings!, notifyAt: selectedTime });
      setSuccessMessage('設定を保存しました');
    } catch (err) {
      setError('設定の保存に失敗しました');
    } finally {
      setIsSaving(false);
    }
  };

  const handleLogout = async () => {
    try {
      await logout();
      navigate('/');
    } catch (err) {
      setError('ログアウトに失敗しました');
    }
  };

  const hasChanges = settings && selectedTime !== settings.notifyAt;

  if (isLoading) {
    return <Loading message="設定を読み込み中..." />;
  }

  if (error && !settings) {
    return <Error message={error} onRetry={fetchSettings} />;
  }

  return (
    <div className="pb-20">
      <header className="bg-white shadow-sm p-4 mb-4">
        <h1 className="text-xl font-bold text-gray-800">設定</h1>
      </header>

      {/* 成功メッセージ */}
      {successMessage && (
        <div className="mx-4 mb-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded-lg">
          {successMessage}
        </div>
      )}

      {/* エラーメッセージ */}
      {error && (
        <div className="mx-4 mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded-lg">
          {error}
        </div>
      )}

      <div className="px-4">
        {/* 通知設定セクション */}
        <section className="bg-white rounded-lg shadow p-4 mb-6">
          <h2 className="text-lg font-semibold text-gray-800 mb-4">
            通知設定
          </h2>

          <div className="mb-4">
            <label className="block text-sm font-medium text-gray-700 mb-2">
              復習通知時間
            </label>
            <p className="text-sm text-gray-500 mb-3">
              毎日この時間にLINEで復習のリマインドを送信します
            </p>

            <div className="space-y-2">
              {NOTIFICATION_TIMES.map((time) => (
                <label
                  key={time.value}
                  className={`flex items-center p-3 rounded-lg border cursor-pointer min-h-[44px] ${
                    selectedTime === time.value
                      ? 'border-blue-500 bg-blue-50'
                      : 'border-gray-300 hover:bg-gray-50'
                  }`}
                >
                  <input
                    type="radio"
                    name="notifyTime"
                    value={time.value}
                    checked={selectedTime === time.value}
                    onChange={(e) => setSelectedTime(e.target.value)}
                    className="sr-only"
                  />
                  <div className={`w-5 h-5 rounded-full border-2 mr-3 flex items-center justify-center ${
                    selectedTime === time.value
                      ? 'border-blue-500'
                      : 'border-gray-400'
                  }`}>
                    {selectedTime === time.value && (
                      <div className="w-3 h-3 rounded-full bg-blue-500" />
                    )}
                  </div>
                  <span className="text-gray-800">{time.label}</span>
                </label>
              ))}
            </div>
          </div>

          <button
            onClick={handleSave}
            disabled={!hasChanges || isSaving}
            className={`w-full py-3 rounded-lg font-medium min-h-[44px] ${
              hasChanges && !isSaving
                ? 'bg-blue-600 text-white hover:bg-blue-700'
                : 'bg-gray-300 text-gray-500 cursor-not-allowed'
            }`}
          >
            {isSaving ? '保存中...' : '設定を保存'}
          </button>
        </section>

        {/* アカウント情報セクション */}
        <section className="bg-white rounded-lg shadow p-4 mb-6">
          <h2 className="text-lg font-semibold text-gray-800 mb-4">
            アカウント
          </h2>

          <div className="py-3 border-b border-gray-200">
            <span className="text-sm text-gray-600">ログインID</span>
            <p className="text-gray-800 mt-1">{user?.profile?.email || '-'}</p>
          </div>

          <div className="py-3">
            <span className="text-sm text-gray-600">名前</span>
            <p className="text-gray-800 mt-1">{user?.profile?.name || '-'}</p>
          </div>
        </section>

        {/* LINE連携セクション */}
        <section className="bg-white rounded-lg shadow p-4 mb-6">
          <h2 className="text-lg font-semibold text-gray-800 mb-4">
            LINE連携
          </h2>

          <a
            href="/link-line"
            className="flex items-center justify-between py-3 text-blue-600 hover:text-blue-800"
          >
            <span>LINE連携設定</span>
            <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
            </svg>
          </a>
        </section>

        {/* ログアウトボタン */}
        <button
          onClick={handleLogout}
          className="w-full py-3 text-red-600 border border-red-600 rounded-lg hover:bg-red-50 min-h-[44px]"
        >
          ログアウト
        </button>
      </div>
    </div>
  );
};
```

**実装ファイル**: `frontend/src/pages/SettingsPage.tsx`

### 2. API連携（ユーザー設定） 🔵
**信頼性**: 🔵 *architecture.mdより*

ユーザー設定の取得・更新API連携を実装する。

```typescript
// frontend/src/services/api.ts (部分)
interface UserSettings {
  notifyAt: string;
}

export const usersApi = {
  getSettings: async (): Promise<UserSettings> => {
    const response = await apiClient.get<UserSettings>('/users/settings');
    return response.data;
  },

  updateSettings: async (settings: Partial<UserSettings>): Promise<UserSettings> => {
    const response = await apiClient.put<UserSettings>('/users/settings', settings);
    return response.data;
  },
};
```

**実装ファイル**: `frontend/src/services/api.ts`

---

## 単体テスト要件

### テストケース1: 現在の設定値の表示 🔵
**信頼性**: 🔵 *user-stories.md 4.2より*
**Given**: ユーザーが設定画面にアクセス
**When**: 設定が読み込まれる
**Then**: 現在の通知時間が選択状態で表示される

### テストケース2: 通知時間の選択 🔵
**信頼性**: 🔵 *REQ-043より*
**Given**: 設定画面が表示されている
**When**: 別の通知時間を選択
**Then**: 選択した時間がハイライトされる

### テストケース3: 設定の保存 🔵
**信頼性**: 🔵 *REQ-043より*
**Given**: 通知時間を変更した
**When**: 保存ボタンをクリック
**Then**: 設定が保存され、成功メッセージが表示される

### テストケース4: 変更がない場合の保存ボタン無効化 🟡
**信頼性**: 🟡 *要件から妥当な推測*
**Given**: 設定を変更していない
**When**: 保存ボタンの状態を確認
**Then**: 保存ボタンが無効化されている

### テストケース5: 保存成功フィードバック 🟡
**信頼性**: 🟡 *要件から妥当な推測*
**Given**: 設定を保存
**When**: 保存が成功
**Then**: 「設定を保存しました」メッセージが表示され、3秒後に消える

### テストケース6: 保存エラー時の表示 🟡
**信頼性**: 🟡 *要件から妥当な推測*
**Given**: 設定を保存中
**When**: エラーが発生
**Then**: エラーメッセージが表示される

### テストケース7: ログアウト処理 🔵
**信頼性**: 🔵 *architecture.mdより*
**Given**: 設定画面が表示されている
**When**: ログアウトボタンをクリック
**Then**: ログアウト処理が実行され、トップページにリダイレクトされる

---

## UI/UX要件

### ローディング状態 🔵
**信頼性**: 🔵 *NFR-201より*
- 設定読み込み中はローディングスピナーを表示
- 保存中はボタンに「保存中...」を表示

### エラー表示 🟡
**信頼性**: 🟡 *要件から妥当な推測*
- API取得エラー時はエラーメッセージを表示
- 保存エラー時はインラインエラーを表示

### 保存成功フィードバック 🟡
**信頼性**: 🟡 *要件から妥当な推測*
- 保存成功時は緑色のバナーを表示
- 3秒後に自動で非表示

### 現在の設定値表示 🔵
**信頼性**: 🔵 *user-stories.md 4.2より*
- 現在選択されている時間をハイライト表示
- 変更前の値が分かるようにする

### モバイル対応 🔵
**信頼性**: 🔵 *NFR-201より*
- ラジオボタンは大きなタップ領域（44px以上）
- スクロール可能なレイアウト
- セクション分けで視認性を確保

---

## 実装手順

### TDDタスクの場合
1. `/tsumiki:tdd-requirements TASK-0018` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項
- 通知時間の選択肢は固定（07:00, 09:00, 12:00, 18:00, 21:00）
- 将来的にカスタム時間入力を追加する可能性を考慮した設計
- タイムゾーンはJST（日本標準時）を前提とする
- 設定変更後は即座にサーバーに反映される（下書き保存なし）

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 9項目
- 🟡 **黄信号**: 5項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
