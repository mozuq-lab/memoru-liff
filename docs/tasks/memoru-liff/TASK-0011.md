# TASK-0011: å®šæœŸé€šçŸ¥Lambdaå®Ÿè£…

**ã‚¿ã‚¹ã‚¯ID**: TASK-0011
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 2 - ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *architecture.mdãƒ»dataflow.mdã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸
- **æ¦‚è¦**: [overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-041, REQ-042, REQ-043
- **è¨­è¨ˆæ–‡æ›¸**: [architecture.md](../../design/memoru-liff/architecture.md)
- **APIä»•æ§˜**: [api-endpoints.md](../../design/memoru-liff/api-endpoints.md)
- **ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼**: [dataflow.md](../../design/memoru-liff/dataflow.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦
EventBridge Schedulerã«ã‚ˆã£ã¦å®šæœŸçš„ï¼ˆ5åˆ†é–“éš”ï¼‰ã«èµ·å‹•ã•ã‚Œã€å¾©ç¿’æœŸé™ãŒåˆ°æ¥ã—ãŸã‚«ãƒ¼ãƒ‰ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«LINE Push Messageã§é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹Lambdaé–¢æ•°ã‚’å®Ÿè£…ã™ã‚‹ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã®é€šçŸ¥æ™‚é–“è¨­å®šã‚’è€ƒæ…®ã—ãŸãƒãƒƒãƒå‡¦ç†ã‚’è¡Œã†ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯
- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0010ï¼ˆLINE Webhookãƒ»Postbackå‡¦ç†å®Ÿè£…ï¼‰
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: ãªã—ï¼ˆPhase 2å®Œäº†ï¼‰

## å®Œäº†æ¡ä»¶
- [x] due-push-job Lambdaå®Ÿè£…
- [x] EventBridge Schedulerè¨­å®š
- [x] å¾©ç¿’å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªå®Ÿè£…
- [x] LINE Push Messageé€ä¿¡å®Ÿè£…
- [x] é€šçŸ¥æ™‚é–“ãƒãƒƒãƒãƒ³ã‚°å®Ÿè£…
- [x] ãƒãƒƒãƒå‡¦ç†ï¼ˆè¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰å®Ÿè£…
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸80%ä»¥ä¸Š

---

## å®Ÿè£…è©³ç´°

### 1. Lambdaé–¢æ•°ãƒ¡ã‚¤ãƒ³ãƒãƒ³ãƒ‰ãƒ©å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*

EventBridge Schedulerã‹ã‚‰å‘¼ã³å‡ºã•ã‚Œã‚‹Lambdaé–¢æ•°ã®ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚

**ãƒãƒ³ãƒ‰ãƒ©æ§‹é€ **:
```python
import json
from datetime import datetime, timezone
from services.notification_service import NotificationService

def handler(event, context):
    """
    EventBridge Schedulerã‹ã‚‰5åˆ†é–“éš”ã§å‘¼ã³å‡ºã•ã‚Œã‚‹

    å‡¦ç†ãƒ•ãƒ­ãƒ¼:
    1. ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ï¼ˆUTCï¼‰
    2. é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
    3. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Push Messageé€ä¿¡
    4. çµæœã‚’ãƒ­ã‚°å‡ºåŠ›
    """
    current_time = datetime.now(timezone.utc)
    service = NotificationService()

    result = service.process_notifications(current_time)

    return {
        'statusCode': 200,
        'body': json.dumps({
            'processed_users': result['processed'],
            'sent_notifications': result['sent'],
            'errors': result['errors']
        })
    }
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/functions/due_push_job/handler.py`

### 2. EventBridge Schedulerè¨­å®š ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*

5åˆ†é–“éš”ã§Lambdaé–¢æ•°ã‚’èµ·å‹•ã™ã‚‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ã‚’è¨­å®šã™ã‚‹ã€‚

**CDKè¨­å®š**:
```python
from aws_cdk import aws_events as events
from aws_cdk import aws_events_targets as targets

# 5åˆ†é–“éš”ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
rule = events.Rule(
    self, "DuePushJobSchedule",
    schedule=events.Schedule.rate(Duration.minutes(5)),
    targets=[targets.LambdaFunction(due_push_job_lambda)]
)
```

**å®Ÿè¡Œé–“éš”ã®æ ¹æ‹ **:
- 5åˆ†é–“éš” = 1æ™‚é–“ã‚ãŸã‚Š12å›å®Ÿè¡Œ
- é€šçŸ¥ç²¾åº¦: ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®šæ™‚é–“ã‹ã‚‰æœ€å¤§5åˆ†ã®é…å»¶è¨±å®¹
- ã‚³ã‚¹ãƒˆ: Lambdaå®Ÿè¡Œå›æ•° = 12 x 24 x 30 = 8,640å›/æœˆ

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/infrastructure/stacks/scheduler_stack.py`

### 3. å¾©ç¿’å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ã‚¨ãƒªå®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*

é€šçŸ¥å¯¾è±¡ã¨ãªã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’åŠ¹ç‡çš„ã«å–å¾—ã™ã‚‹ã‚¯ã‚¨ãƒªã‚’å®Ÿè£…ã™ã‚‹ã€‚

**å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¡ä»¶**:
1. LINEé€£æºæ¸ˆã¿ï¼ˆline_user_idãŒå­˜åœ¨ï¼‰
2. notification_time ãŒç¾åœ¨æ™‚åˆ»ã®5åˆ†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å†…
3. å¾©ç¿’æœŸé™ï¼ˆdue_date <= ä»Šæ—¥ï¼‰ã®ã‚«ãƒ¼ãƒ‰ã‚’1æšä»¥ä¸Šä¿æœ‰
4. æœ¬æ—¥ã¾ã é€šçŸ¥æœªé€ä¿¡

**ã‚¯ã‚¨ãƒªæˆ¦ç•¥**:
```python
def get_notification_targets(current_time: datetime) -> list:
    """
    é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—

    1. notification_time-indexã§æ™‚é–“å¸¯ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    2. line_user_id exists ã§LINEé€£æºãƒã‚§ãƒƒã‚¯
    3. last_notified_date != ä»Šæ—¥ ã§é‡è¤‡é˜²æ­¢
    """
    # 5åˆ†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®è¨ˆç®—
    # ä¾‹: 09:02 â†’ 09:00-09:05 ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å¯¾è±¡
    window_start = current_time.replace(minute=(current_time.minute // 5) * 5, second=0)
    window_end = window_start + timedelta(minutes=5)

    # DynamoDB Query
    pass
```

**GSIè¨­è¨ˆ**:
- `notification_time-index`: é€šçŸ¥æ™‚é–“ã§ã®æ¤œç´¢ç”¨

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/functions/due_push_job/services/user_query.py`

### 4. å¾©ç¿’æœŸé™ã‚«ãƒ¼ãƒ‰å­˜åœ¨ãƒã‚§ãƒƒã‚¯å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*

ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¾©ç¿’ã™ã¹ãã‚«ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã™ã‚‹ã€‚

**å‡¦ç†**:
```python
def has_due_cards(user_id: str, today: date) -> bool:
    """
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæœŸé™ã‚«ãƒ¼ãƒ‰ã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèª

    GSI user_id-due_date-index ã§ due_date <= today ã‚’æ¤œç´¢
    1ä»¶ã§ã‚‚å­˜åœ¨ã™ã‚Œã°True
    """
    pass

def get_due_card_count(user_id: str, today: date) -> int:
    """å¾©ç¿’æœŸé™ã‚«ãƒ¼ãƒ‰ã®æ•°ã‚’å–å¾—"""
    pass
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/functions/due_push_job/services/card_query.py`

### 5. LINE Push Messageé€ä¿¡å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*

å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ãƒªãƒã‚¤ãƒ³ãƒ‰é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ã€‚

**é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**:
```json
{
  "type": "flex",
  "altText": "å¾©ç¿’ãƒªãƒã‚¤ãƒ³ãƒ‰",
  "contents": {
    "type": "bubble",
    "body": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "text",
          "text": "å¾©ç¿’ã®æ™‚é–“ã§ã™ï¼",
          "weight": "bold",
          "size": "lg"
        },
        {
          "type": "text",
          "text": "{due_count}æšã®ã‚«ãƒ¼ãƒ‰ãŒå¾©ç¿’ã‚’å¾…ã£ã¦ã„ã¾ã™",
          "wrap": true
        }
      ]
    },
    "footer": {
      "type": "box",
      "layout": "vertical",
      "contents": [
        {
          "type": "button",
          "action": {
            "type": "postback",
            "label": "å¾©ç¿’ã‚’å§‹ã‚ã‚‹",
            "data": "action=start"
          },
          "style": "primary"
        }
      ]
    }
  }
}
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/functions/due_push_job/services/push_service.py`

### 6. ãƒãƒƒãƒå‡¦ç†å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*

è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã™ã‚‹ãƒãƒƒãƒå‡¦ç†ã‚’å®Ÿè£…ã™ã‚‹ã€‚

**å‡¦ç†ãƒ•ãƒ­ãƒ¼**:
```python
def process_notifications(current_time: datetime) -> dict:
    """
    ãƒãƒƒãƒé€šçŸ¥å‡¦ç†

    Returns:
        dict: {
            'processed': å‡¦ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°,
            'sent': é€ä¿¡æˆåŠŸæ•°,
            'errors': ã‚¨ãƒ©ãƒ¼æƒ…å ±ãƒªã‚¹ãƒˆ
        }
    """
    result = {'processed': 0, 'sent': 0, 'errors': []}

    # 1. å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—
    targets = get_notification_targets(current_time)

    # 2. å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‡¦ç†
    for user in targets:
        result['processed'] += 1
        try:
            # æœŸé™ã‚«ãƒ¼ãƒ‰ç¢ºèª
            due_count = get_due_card_count(user['user_id'], current_time.date())
            if due_count == 0:
                continue

            # Push Messageé€ä¿¡
            send_reminder(user['line_user_id'], due_count)

            # é€šçŸ¥æ¸ˆã¿ãƒ•ãƒ©ã‚°æ›´æ–°
            update_last_notified(user['user_id'], current_time.date())

            result['sent'] += 1
        except Exception as e:
            result['errors'].append({
                'user_id': user['user_id'],
                'error': str(e)
            })

    return result
```

**ä¸¦åˆ—å‡¦ç†ã®è€ƒæ…®**:
- åˆæœŸãƒªãƒªãƒ¼ã‚¹ã¯é€æ¬¡å‡¦ç†
- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°å¢—åŠ æ™‚ã¯ThreadPoolExecutorã§ä¸¦åˆ—åŒ–æ¤œè¨

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/functions/due_push_job/services/notification_service.py`

### 7. é‡è¤‡é€šçŸ¥é˜²æ­¢å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*

åŒã˜æ—¥ã«åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸è¤‡æ•°å›é€šçŸ¥ã—ãªã„ã‚ˆã†åˆ¶å¾¡ã™ã‚‹ã€‚

**å®Ÿè£…æ–¹æ³•**:
- Usersãƒ†ãƒ¼ãƒ–ãƒ«ã« `last_notified_date` å±æ€§ã‚’è¿½åŠ 
- é€šçŸ¥é€ä¿¡å‰ã«ãƒã‚§ãƒƒã‚¯ã€é€ä¿¡å¾Œã«æ›´æ–°
- æ—¥ä»˜ã¯UTCã§ç®¡ç†

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/functions/due_push_job/services/notification_service.py`

### 8. ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*

LINE Pushå¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‚’é©åˆ‡ã«å‡ºåŠ›ã™ã‚‹ã€‚

**ãƒ­ã‚°å½¢å¼**:
```python
import logging
import json

logger = logging.getLogger()
logger.setLevel(logging.INFO)

def log_push_error(user_id: str, line_user_id: str, error: Exception):
    """Push Messageå¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°"""
    logger.error(json.dumps({
        'event': 'push_message_failed',
        'user_id': user_id,
        'line_user_id': line_user_id[:8] + '...',  # ãƒã‚¹ã‚­ãƒ³ã‚°
        'error_type': type(error).__name__,
        'error_message': str(error)
    }))
```

**CloudWatch Logsã§ç›£è¦–å¯èƒ½ãªå½¢å¼ã§å‡ºåŠ›**

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/functions/due_push_job/utils/logger.py`

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ½å‡º - æ™‚é–“ãƒãƒƒãƒ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: notification_time=09:00ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ç¾åœ¨æ™‚åˆ»09:02
**When**: get_notification_targets ã‚’å‘¼ã³å‡ºã™
**Then**: è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå«ã¾ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ½å‡º - æ™‚é–“ä¸ä¸€è‡´ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: notification_time=09:00ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ç¾åœ¨æ™‚åˆ»09:06
**When**: get_notification_targets ã‚’å‘¼ã³å‡ºã™
**Then**: è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å«ã¾ã‚Œãªã„

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ½å‡º - 5åˆ†ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦å¢ƒç•Œå€¤ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: notification_time=09:04ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ç¾åœ¨æ™‚åˆ»09:04
**When**: get_notification_targets ã‚’å‘¼ã³å‡ºã™
**Then**: è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå«ã¾ã‚Œã‚‹ï¼ˆ09:00-09:05ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼‰

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: LINEæœªé€£æºãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é™¤å¤– ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*
**Given**: line_user_idãŒnullã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: get_notification_targets ã‚’å‘¼ã³å‡ºã™
**Then**: è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯å«ã¾ã‚Œãªã„

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: æœŸé™ã‚«ãƒ¼ãƒ‰ãªã—ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é€šçŸ¥ã‚¹ã‚­ãƒƒãƒ— ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: å¾©ç¿’æœŸé™ã‚«ãƒ¼ãƒ‰ãŒ0æšã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: process_notifications ã‚’å®Ÿè¡Œ
**Then**: Push Messageã¯é€ä¿¡ã•ã‚Œãªã„

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6: æœŸé™ã‚«ãƒ¼ãƒ‰ã‚ã‚Šãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: å¾©ç¿’æœŸé™ã‚«ãƒ¼ãƒ‰ãŒ5æšã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: process_notifications ã‚’å®Ÿè¡Œ
**Then**: ã€Œ5æšã®ã‚«ãƒ¼ãƒ‰ãŒ...ã€ã®Push MessageãŒé€ä¿¡

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹7: é‡è¤‡é€šçŸ¥é˜²æ­¢ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: æœ¬æ—¥æ—¢ã«é€šçŸ¥æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼ˆlast_notified_date=ä»Šæ—¥ï¼‰
**When**: process_notifications ã‚’å®Ÿè¡Œ
**Then**: Push Messageã¯é€ä¿¡ã•ã‚Œãªã„

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹8: é€šçŸ¥æ¸ˆã¿ãƒ•ãƒ©ã‚°æ›´æ–° ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: æœªé€šçŸ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: é€šçŸ¥é€ä¿¡æˆåŠŸ
**Then**: last_notified_dateãŒä»Šæ—¥ã«æ›´æ–°

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹9: Push Messageé€ä¿¡æˆåŠŸ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*
**Given**: æœ‰åŠ¹ãªline_user_id
**When**: send_reminder ã‚’å‘¼ã³å‡ºã™
**Then**: LINE Push APIãŒæ­£å¸¸ã«å‘¼ã³å‡ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹10: Push Messageé€ä¿¡å¤±æ•— - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ–ãƒ­ãƒƒã‚¯ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *LINE Messaging APIä»•æ§˜ã‚ˆã‚Š*
**Given**: ãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿ã®line_user_id
**When**: send_reminder ã‚’å‘¼ã³å‡ºã™
**Then**: ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›ã€å‡¦ç†ã¯ç¶™ç¶š

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹11: ãƒãƒƒãƒå‡¦ç† - è¤‡æ•°ãƒ¦ãƒ¼ã‚¶ãƒ¼ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**Given**: é€šçŸ¥å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼10å
**When**: process_notifications ã‚’å®Ÿè¡Œ
**Then**: 10åå…¨å“¡ã«å‡¦ç†ãŒå®Ÿè¡Œã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹12: ãƒãƒƒãƒå‡¦ç† - éƒ¨åˆ†å¤±æ•— ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**Given**: é€šçŸ¥å¯¾è±¡10åä¸­ã€2åãŒãƒ–ãƒ­ãƒƒã‚¯æ¸ˆã¿
**When**: process_notifications ã‚’å®Ÿè¡Œ
**Then**: 8åã«é€ä¿¡æˆåŠŸã€2åã¯ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã€å‡¦ç†å…¨ä½“ã¯æˆåŠŸ

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹13: ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¤‰æ› - Asia/Tokyo ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *requirements.mdã‚ˆã‚Š*
**Given**: timezone="Asia/Tokyo"ã€notification_time="09:00"
**When**: UTC 00:00ã«å‡¦ç†å®Ÿè¡Œ
**Then**: è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¯¾è±¡ï¼ˆ09:00 JST = 00:00 UTCï¼‰

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹14: Lambdaå®Ÿè¡Œçµæœãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**Given**: å‡¦ç†å®Œäº†
**When**: handler ãŒè¿”å´
**Then**: processed, sent, errors ã‚’å«ã‚€JSONãŒè¿”å´

---

## çµ±åˆãƒ†ã‚¹ãƒˆè¦ä»¶

### çµ±åˆãƒ†ã‚¹ãƒˆ1: End-to-Endé€šçŸ¥ãƒ•ãƒ­ãƒ¼ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*
**ãƒ†ã‚¹ãƒˆå†…å®¹**: EventBridge â†’ Lambda â†’ DynamoDB Query â†’ LINE Push ã®ä¸€é€£ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸å‹•ä½œ

### çµ±åˆãƒ†ã‚¹ãƒˆ2: EventBridge Schedulerå®Ÿè¡Œç¢ºèª ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *å®Ÿç’°å¢ƒä¾å­˜*
**ãƒ†ã‚¹ãƒˆå†…å®¹**: 5åˆ†é–“éš”ã§LambdaãŒèµ·å‹•ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªï¼ˆCloudWatch Logsï¼‰

### çµ±åˆãƒ†ã‚¹ãƒˆ3: LINE Pushå®Ÿæ¥ç¶šãƒ†ã‚¹ãƒˆ ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *å®Ÿç’°å¢ƒä¾å­˜*
**ãƒ†ã‚¹ãƒˆå†…å®¹**: å®Ÿéš›ã®LINEãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Push MessageãŒå±Šãã“ã¨ã‚’ç¢ºèªï¼ˆæ‰‹å‹•å®Ÿè¡Œï¼‰

### çµ±åˆãƒ†ã‚¹ãƒˆ4: å¤§é‡ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†ãƒ†ã‚¹ãƒˆ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**ãƒ†ã‚¹ãƒˆå†…å®¹**: 100åã®å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’5åˆ†ä»¥å†…ã«å‡¦ç†å®Œäº†ã§ãã‚‹ã“ã¨ã‚’ç¢ºèª

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0011` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …
- Lambdaå®Ÿè¡Œæ™‚é–“ä¸Šé™ï¼ˆ15åˆ†ï¼‰ã‚’è€ƒæ…®ã—ã€å¤§é‡ãƒ¦ãƒ¼ã‚¶ãƒ¼æ™‚ã¯åˆ†å‰²å‡¦ç†ã‚’æ¤œè¨
- LINE Push Messageç„¡æ–™æ ï¼ˆ1,000é€š/æœˆï¼‰ã‚’è¶…ãˆã‚‹å ´åˆã¯æœ‰æ–™ãƒ—ãƒ©ãƒ³ãŒå¿…è¦
- ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å‡¦ç†ã¯ pytz ã¾ãŸã¯ zoneinfo ã‚’ä½¿ç”¨
- EventBridge Schedulerã¯ UTC ã§å‹•ä½œã™ã‚‹ãŸã‚ã€æ™‚é–“è¨ˆç®—ã«æ³¨æ„
- ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã‚‚å‡¦ç†ã‚’ç¶™ç¶šã—ã€æœ€å¾Œã«ã¾ã¨ã‚ã¦ãƒ­ã‚°å‡ºåŠ›
- CloudWatch Alarmã§ error_count > 0 ã®ç›£è¦–ã‚’æ¨å¥¨

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼
- ğŸ”µ **é’ä¿¡å·**: 20é …ç›®
- ğŸŸ¡ **é»„ä¿¡å·**: 2é …ç›®ï¼ˆEventBridgeå®Ÿè¡Œç¢ºèªã€LINE Pushå®Ÿæ¥ç¶šãƒ†ã‚¹ãƒˆï¼‰
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›®

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
