# TASK-0012: LIFF SDK + Keycloak OIDC èªè¨¼é€£æº

**ã‚¿ã‚¹ã‚¯ID**: TASK-0012
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 3 - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸ”µ *architecture.mdãƒ»dataflow.mdã‚ˆã‚Š*

## é–¢é€£æ–‡æ›¸
- **æ¦‚è¦**: [overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-001, REQ-002, REQ-101, REQ-102
- **è¨­è¨ˆæ–‡æ›¸**: [architecture.md](../../design/memoru-liff/architecture.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦
LIFF SDKã¨Keycloak OIDCã‚’é€£æºã—ã€LINEèªè¨¼ã‹ã‚‰Keycloakã¸ã®PKCEèªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè£…ã™ã‚‹ã€‚oidc-client-tsã‚’ä½¿ç”¨ã—ã¦ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ï¼ˆå–å¾—ãƒ»ä¿å­˜ãƒ»ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼‰ã‚’è¡Œã„ã€ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼åŸºç›¤ã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯
- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0002ï¼ˆKeycloakè¨­å®šï¼‰, TASK-0004ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç’°å¢ƒæ§‹ç¯‰ï¼‰
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0013, TASK-0014

## å®Œäº†æ¡ä»¶
- [x] oidc-client-tsè¨­å®šå®Œäº†
- [x] LIFF SDKåˆæœŸåŒ–å‡¦ç†å®Ÿè£…
- [x] PKCEèªè¨¼ãƒ•ãƒ­ãƒ¼å®Ÿè£…
- [x] JWTãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ï¼ˆlocalStorageï¼‰å®Ÿè£…
- [x] ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³å‡¦ç†å®Ÿè£…
- [x] å˜ä½“ãƒ†ã‚¹ãƒˆ80%ä»¥ä¸Šã®ã‚«ãƒãƒ¬ãƒƒã‚¸é”æˆ

---

## å®Ÿè£…è©³ç´°

### 1. oidc-client-tsè¨­å®š ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*

Keycloak OIDCãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã¸ã®æ¥ç¶šè¨­å®šã‚’è¡Œã†ã€‚

```typescript
// frontend/src/config/oidc.ts
import { UserManagerSettings } from 'oidc-client-ts';

export const oidcConfig: UserManagerSettings = {
  authority: import.meta.env.VITE_KEYCLOAK_URL + '/realms/' + import.meta.env.VITE_KEYCLOAK_REALM,
  client_id: import.meta.env.VITE_KEYCLOAK_CLIENT_ID,
  redirect_uri: window.location.origin + '/callback',
  post_logout_redirect_uri: window.location.origin,
  response_type: 'code',
  scope: 'openid profile email',
  automaticSilentRenew: true,
  silent_redirect_uri: window.location.origin + '/silent-renew',
};
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/config/oidc.ts`

### 2. LIFF SDKåˆæœŸåŒ– ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*

LIFF SDKã‚’åˆæœŸåŒ–ã—ã€LINEãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèªã™ã‚‹ã€‚

```typescript
// frontend/src/services/liff.ts
import liff from '@line/liff';

export const initializeLiff = async (): Promise<void> => {
  await liff.init({ liffId: import.meta.env.VITE_LIFF_ID });

  if (!liff.isLoggedIn()) {
    liff.login();
  }
};

export const getLiffProfile = async () => {
  return await liff.getProfile();
};

export const getLiffIdToken = (): string | null => {
  return liff.getIDToken();
};
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/services/liff.ts`

### 3. èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdãƒ»dataflow.mdã‚ˆã‚Š*

PKCEèªè¨¼ãƒ•ãƒ­ãƒ¼ã¨ãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†ã‚’ä¸€å…ƒåŒ–ã™ã‚‹èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè£…ã™ã‚‹ã€‚

```typescript
// frontend/src/services/auth.ts
import { UserManager, User } from 'oidc-client-ts';
import { oidcConfig } from '../config/oidc';

class AuthService {
  private userManager: UserManager;

  constructor() {
    this.userManager = new UserManager(oidcConfig);
    this.setupEventListeners();
  }

  private setupEventListeners(): void {
    this.userManager.events.addAccessTokenExpiring(() => {
      this.refreshToken();
    });

    this.userManager.events.addUserSignedOut(() => {
      this.logout();
    });
  }

  async login(): Promise<void> {
    await this.userManager.signinRedirect();
  }

  async handleCallback(): Promise<User> {
    return await this.userManager.signinRedirectCallback();
  }

  async getUser(): Promise<User | null> {
    return await this.userManager.getUser();
  }

  async getAccessToken(): Promise<string | null> {
    const user = await this.getUser();
    return user?.access_token ?? null;
  }

  async refreshToken(): Promise<void> {
    await this.userManager.signinSilent();
  }

  async logout(): Promise<void> {
    await this.userManager.signoutRedirect();
  }

  async isAuthenticated(): Promise<boolean> {
    const user = await this.getUser();
    return !!user && !user.expired;
  }
}

export const authService = new AuthService();
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/services/auth.ts`

### 4. useAuth ãƒ•ãƒƒã‚¯å®Ÿè£… ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*

React Hooksã‚’ä½¿ç”¨ã—ã¦èªè¨¼çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã€‚

```typescript
// frontend/src/hooks/useAuth.ts
import { useState, useEffect, useCallback } from 'react';
import { User } from 'oidc-client-ts';
import { authService } from '../services/auth';

interface UseAuthReturn {
  user: User | null;
  isLoading: boolean;
  isAuthenticated: boolean;
  error: Error | null;
  login: () => Promise<void>;
  logout: () => Promise<void>;
  refreshToken: () => Promise<void>;
}

export const useAuth = (): UseAuthReturn => {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<Error | null>(null);

  useEffect(() => {
    const initAuth = async () => {
      try {
        const currentUser = await authService.getUser();
        setUser(currentUser);
      } catch (err) {
        setError(err as Error);
      } finally {
        setIsLoading(false);
      }
    };

    initAuth();
  }, []);

  const login = useCallback(async () => {
    setIsLoading(true);
    setError(null);
    try {
      await authService.login();
    } catch (err) {
      setError(err as Error);
      setIsLoading(false);
    }
  }, []);

  const logout = useCallback(async () => {
    setIsLoading(true);
    try {
      await authService.logout();
      setUser(null);
    } catch (err) {
      setError(err as Error);
    } finally {
      setIsLoading(false);
    }
  }, []);

  const refreshToken = useCallback(async () => {
    try {
      await authService.refreshToken();
      const currentUser = await authService.getUser();
      setUser(currentUser);
    } catch (err) {
      setError(err as Error);
    }
  }, []);

  return {
    user,
    isLoading,
    isAuthenticated: !!user && !user.expired,
    error,
    login,
    logout,
    refreshToken,
  };
};
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/hooks/useAuth.ts`

### 5. ãƒˆãƒ¼ã‚¯ãƒ³è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*

ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™å‰ã«è‡ªå‹•ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚’è¡Œã†ã€‚

- oidc-client-tsã®`automaticSilentRenew`ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æœ‰åŠ¹åŒ–
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ã®ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¯¾å¿œ
- ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—æ™‚ã¯å†ãƒ­ã‚°ã‚¤ãƒ³ã‚’ä¿ƒã™

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `frontend/src/services/auth.ts`ï¼ˆä¸Šè¨˜ã«å«ã‚€ï¼‰

---

## å˜ä½“ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: LIFF SDKåˆæœŸåŒ–æˆåŠŸ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**Given**: LIFF IDãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
**When**: initializeLiff()ã‚’å‘¼ã³å‡ºã™
**Then**: LIFF SDKãŒåˆæœŸåŒ–ã•ã‚Œã€ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ãŒç¢ºèªã§ãã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: PKCEèªè¨¼ãƒ•ãƒ­ãƒ¼æ­£å¸¸ç³» ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*
**Given**: æœªèªè¨¼çŠ¶æ…‹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: login()ã‚’å‘¼ã³å‡ºã™
**Then**: Keycloakèªè¨¼ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: èªè¨¼ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç† ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**Given**: Keycloakã‹ã‚‰èªè¨¼ã‚³ãƒ¼ãƒ‰ã‚’å—ã‘å–ã£ãŸçŠ¶æ…‹
**When**: handleCallback()ã‚’å‘¼ã³å‡ºã™
**Then**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹4: ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œæ™‚ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *dataflow.mdã‚ˆã‚Š*
**Given**: ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œé–“è¿‘
**When**: è‡ªå‹•ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã‚‹
**Then**: æ–°ã—ã„ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã•ã‚Œã€ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒç¶™ç¶šã™ã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹5: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³å¤±æ•—æ™‚ã®å‡¦ç† ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *è¦ä»¶ã‹ã‚‰å¦¥å½“ãªæ¨æ¸¬*
**Given**: ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹
**When**: refreshToken()ã‚’å‘¼ã³å‡ºã™
**Then**: ã‚¨ãƒ©ãƒ¼ãŒè¨­å®šã•ã‚Œã€å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ãªçŠ¶æ…‹ã«ãªã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹6: èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**Given**: èªè¨¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ
**When**: ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ãŒæ¤œå‡ºã•ã‚Œã‚‹
**Then**: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã€å†ãƒ­ã‚°ã‚¤ãƒ³ãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã‚‹

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹7: ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç† ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *architecture.mdã‚ˆã‚Š*
**Given**: èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
**When**: logout()ã‚’å‘¼ã³å‡ºã™
**Then**: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚¯ãƒªã‚¢ã•ã‚Œã€ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†ç”»é¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

---

## UI/UXè¦ä»¶

### ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©ã‚ˆã‚Š*
- èªè¨¼å‡¦ç†ä¸­ã¯ã‚¹ãƒ”ãƒŠãƒ¼ã‚’ä¸­å¤®ã«è¡¨ç¤º
- ã€Œèªè¨¼ä¸­...ã€ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ä½µè¨˜
- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ä¸­ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã‚’ãƒ–ãƒ­ãƒƒã‚¯

### ã‚¨ãƒ©ãƒ¼è¡¨ç¤º ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *è¦ä»¶å®šç¾©ã‚ˆã‚Š*
- èªè¨¼ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ˜ç¢ºãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
- ã€Œå†ãƒ­ã‚°ã‚¤ãƒ³ã€ãƒœã‚¿ãƒ³ã‚’é…ç½®
- ã‚¨ãƒ©ãƒ¼è©³ç´°ã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ãƒ­ã‚°å‡ºåŠ›

### ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ ğŸ”µ
**ä¿¡é ¼æ€§**: ğŸ”µ *NFR-201ã‚ˆã‚Š*
- LINE WebViewå†…ã§ã®å‹•ä½œã‚’æœ€é©åŒ–
- ã‚¿ãƒƒãƒæ“ä½œã«å¯¾å¿œã—ãŸãƒœã‚¿ãƒ³ã‚µã‚¤ã‚ºï¼ˆ44pxä»¥ä¸Šï¼‰
- ç¸¦å‘ãç”»é¢ã§ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæœ€é©åŒ–

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0012` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …
- LIFF SDKã¯LINE WebViewå†…ã§ã®ã¿å‹•ä½œã™ã‚‹ç‚¹ã«æ³¨æ„
- é–‹ç™ºæ™‚ã¯LIFF Inspectorã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒãƒƒã‚°
- ãƒˆãƒ¼ã‚¯ãƒ³ã¯localStorageã«ä¿å­˜ã•ã‚Œã‚‹ãŸã‚ã€XSSå¯¾ç­–ã‚’å¾¹åº•ã™ã‚‹
- Keycloakã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šã§PKCEã‚’æœ‰åŠ¹åŒ–ã™ã‚‹ã“ã¨
- ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURIã¯Keycloakå´ã«ã‚‚ç™»éŒ²ãŒå¿…è¦

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼
- ğŸ”µ **é’ä¿¡å·**: 12é …ç›®
- ğŸŸ¡ **é»„ä¿¡å·**: 1é …ç›®
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›®

**å“è³ªè©•ä¾¡**: é«˜å“è³ª
