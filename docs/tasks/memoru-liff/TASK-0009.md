# TASK-0009: AIカード生成API実装

**タスクID**: TASK-0009
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 2 - バックエンド実装
**信頼性レベル**: 🔵 *api-endpoints.md・requirements.mdより*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-021, REQ-022, REQ-023, REQ-024, REQ-111
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)
- **API仕様**: [api-endpoints.md](../../design/memoru-liff/api-endpoints.md)

## タスク概要
ユーザーが入力したテキストからAmazon Bedrock（Claude）を使用してフラッシュカードを自動生成するAPIを実装する。入力テキストの分析、適切な問題・解答の生成、エラーハンドリングを含む。

## 依存タスク
- **前提タスク**: TASK-0007（カード管理API実装）
- **後続タスク**: なし（Phase 3で使用）

## 完了条件
- [ ] POST /cards/generate 実装
- [ ] Bedrock API連携実装
- [ ] 入力テキスト制限（2,000文字）実装
- [ ] エラーハンドリング実装
- [ ] プロンプトテンプレート作成
- [ ] 単体テストカバレッジ80%以上

---

## 実装詳細

### 1. POST /cards/generate エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

入力テキストからフラッシュカードを生成するエンドポイントを実装する。

**リクエスト**:
```json
{
  "input_text": "学習したいテキスト内容...",
  "card_count": 5,
  "difficulty": "medium",
  "language": "ja"
}
```

**レスポンス**:
```json
{
  "generated_cards": [
    {
      "front": "生成された問題文1",
      "back": "生成された解答1",
      "suggested_tags": ["AI生成", "学習"]
    }
  ],
  "generation_info": {
    "input_length": 500,
    "model_used": "anthropic.claude-3-haiku-20240307-v1:0",
    "processing_time_ms": 1500
  }
}
```

**パラメータ**:
- `input_text`: 必須、1-2,000文字
- `card_count`: オプション、1-10枚（デフォルト: 5）
- `difficulty`: オプション、easy/medium/hard（デフォルト: medium）
- `language`: オプション、ja/en（デフォルト: ja）

**実装ファイル**: `backend/functions/api_main/handlers/generate.py`

### 2. Bedrock API連携サービス実装 🔵
**信頼性**: 🔵 *architecture.mdより*

Amazon BedrockのClaude APIを呼び出すサービス層を実装する。

**設定**:
```python
BEDROCK_CONFIG = {
    "model_id": "anthropic.claude-3-haiku-20240307-v1:0",
    "max_tokens": 4096,
    "temperature": 0.7,
    "timeout": 30  # 秒
}
```

**実装内容**:
```python
import boto3
from botocore.config import Config

class BedrockService:
    def __init__(self):
        config = Config(
            read_timeout=30,
            connect_timeout=5,
            retries={'max_attempts': 2}
        )
        self.client = boto3.client('bedrock-runtime', config=config)

    def invoke_claude(self, prompt: str) -> dict:
        """Claude APIを呼び出してレスポンスを取得"""
        pass

    def generate_cards(self, input_text: str, count: int, difficulty: str) -> list:
        """プロンプトを構築してカードを生成"""
        pass
```

**実装ファイル**: `backend/functions/api_main/services/bedrock.py`

### 3. プロンプトテンプレート設計 🔵
**信頼性**: 🔵 *requirements.mdより*

効果的なフラッシュカード生成のためのプロンプトを設計する。

**プロンプト構造**:
```
あなたはフラッシュカード作成の専門家です。
以下のテキストから学習効果の高いフラッシュカードを{count}枚作成してください。

## 入力テキスト
{input_text}

## 要件
- 難易度: {difficulty}
- 言語: {language}
- 問題文（front）は簡潔で明確に
- 解答（back）は必要十分な情報を含める
- 重要な概念を優先的にカード化

## 出力形式（JSON）
{
  "cards": [
    {"front": "問題文", "back": "解答", "tags": ["タグ1"]}
  ]
}
```

**難易度別ガイドライン**:
- **easy**: 基本的な用語定義、単純な事実
- **medium**: 概念の説明、関係性の理解
- **hard**: 応用問題、複合的な理解

**実装ファイル**: `backend/functions/api_main/services/prompts.py`

### 4. 入力テキスト制限実装 🔵
**信頼性**: 🔵 *requirements.mdより*

入力テキストの文字数制限（2,000文字）を実装する。

**バリデーション**:
- 最小: 10文字（意味のあるカード生成に必要）
- 最大: 2,000文字（コスト・レスポンス時間考慮）
- 空白のみは不可

**実装ファイル**: `backend/functions/api_main/handlers/generate.py`

### 5. エラーハンドリング実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

Bedrock API呼び出し時の各種エラーを適切に処理する。

**エラーケース**:
| エラー | HTTPステータス | メッセージ |
|--------|---------------|----------|
| 入力文字数超過 | 400 | Input text exceeds 2000 characters |
| Bedrockタイムアウト | 504 | AI generation timed out |
| Bedrockレート制限 | 429 | Too many requests, please retry later |
| Bedrock内部エラー | 502 | AI service temporarily unavailable |
| JSON解析失敗 | 500 | Failed to parse AI response |

**リトライ戦略**:
- タイムアウト: リトライなし
- レート制限: 指数バックオフで最大2回リトライ
- 内部エラー: 最大2回リトライ

**実装ファイル**: `backend/functions/api_main/services/bedrock.py`

### 6. レスポンスパース処理 🔵
**信頼性**: 🔵 *architecture.mdより*

Claude APIからのレスポンスをパースしてカード形式に変換する。

**処理内容**:
1. JSONレスポンスの抽出（```json...```ブロックから）
2. JSON解析
3. カード形式のバリデーション
4. 不正なカードのフィルタリング
5. 正常なカードのみ返却

**実装ファイル**: `backend/functions/api_main/services/bedrock.py`

---

## 単体テスト要件

### テストケース1: カード生成成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、有効な入力テキスト（500文字）
**When**: POST /cards/generate を呼び出す
**Then**: 200 OK、指定枚数のカードが生成される

### テストケース2: 入力文字数境界値（2,000文字） 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、2,000文字の入力テキスト
**When**: POST /cards/generate を呼び出す
**Then**: 200 OK、正常にカード生成

### テストケース3: 入力文字数超過（2,001文字） 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、2,001文字の入力テキスト
**When**: POST /cards/generate を呼び出す
**Then**: 400 Bad Request、文字数超過エラー

### テストケース4: 入力文字数不足（9文字） 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、9文字の入力テキスト
**When**: POST /cards/generate を呼び出す
**Then**: 400 Bad Request、文字数不足エラー

### テストケース5: カード枚数指定（10枚） 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、card_count=10
**When**: POST /cards/generate を呼び出す
**Then**: 200 OK、10枚のカードが生成される

### テストケース6: カード枚数超過（11枚） 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、card_count=11
**When**: POST /cards/generate を呼び出す
**Then**: 400 Bad Request、枚数超過エラー

### テストケース7: Bedrockタイムアウト 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: Bedrock APIが30秒以上応答しない
**When**: POST /cards/generate を呼び出す
**Then**: 504 Gateway Timeout

### テストケース8: Bedrockレート制限 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: Bedrock APIがThrottlingExceptionを返す
**When**: POST /cards/generate を呼び出す
**Then**: 429 Too Many Requests（リトライ後も失敗時）

### テストケース9: Bedrock内部エラー 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: Bedrock APIがInternalServerErrorを返す
**When**: POST /cards/generate を呼び出す
**Then**: 502 Bad Gateway（リトライ後も失敗時）

### テストケース10: 不正なJSON応答 🔵
**信頼性**: 🔵 *architecture.mdより*
**Given**: Bedrock APIが不正なJSONを返す
**When**: POST /cards/generate を呼び出す
**Then**: 500 Internal Server Error、パースエラー

### テストケース11: 難易度easy指定 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、difficulty="easy"
**When**: POST /cards/generate を呼び出す
**Then**: 200 OK、プロンプトにeasy指示が含まれる

### テストケース12: 言語英語指定 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、language="en"
**When**: POST /cards/generate を呼び出す
**Then**: 200 OK、英語でカードが生成される

### テストケース13: 空白のみの入力 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、空白のみの入力テキスト
**When**: POST /cards/generate を呼び出す
**Then**: 400 Bad Request、入力不正エラー

---

## 統合テスト要件

### 統合テスト1: 生成→保存フロー 🔵
**信頼性**: 🔵 *dataflow.mdより*
**テスト内容**: POST /cards/generate でカード生成後、POST /cards でそのまま保存できることを確認

### 統合テスト2: Bedrock実接続テスト 🟡
**信頼性**: 🟡 *実環境依存*
**テスト内容**: 実際のBedrock APIに接続してカードが生成されることを確認（コスト発生のため手動実行）

### 統合テスト3: 処理時間計測 🔵
**信頼性**: 🔵 *requirements.mdより*
**テスト内容**: 2,000文字入力時のレスポンス時間が30秒以内であることを確認

---

## 実装手順

### TDDタスクの場合
1. `/tsumiki:tdd-requirements TASK-0009` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項
- Bedrock APIの料金に注意（テスト時はモック使用を推奨）
- プロンプトインジェクション対策として、ユーザー入力はサニタイズする
- 生成されたカードは自動保存せず、ユーザーの確認後に保存する設計
- タイムアウト30秒はAPI Gateway + Lambda実行時間を考慮した値
- Claude 3 Haikuを使用（コスト最適化）、品質問題があればSonnetに変更検討
- レート制限対策として、ユーザーあたりの生成回数制限を将来的に検討

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 18項目
- 🟡 **黄信号**: 1項目（Bedrock実接続テスト）
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
