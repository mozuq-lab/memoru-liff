# TASK-0005: API Gateway + Lambda 基盤構築

**タスクID**: TASK-0005
**タスクタイプ**: DIRECT
**推定工数**: 8時間
**フェーズ**: Phase 1 - 基盤構築
**信頼性レベル**: 🔵 *architecture.md・api-endpoints.mdより*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-004, REQ-401, REQ-411
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)
- **API設計**: [api-endpoints.md](../../design/memoru-liff/api-endpoints.md)

## タスク概要
memoruアプリケーションのバックエンドAPIを構築するための基盤を作成する。AWS SAMを使用してAPI Gateway REST APIとLambda関数の基本構成を定義し、JWT認証によるセキュアなAPI保護、レート制限による過負荷防止、共通レイヤーによるコード再利用を実現する。

## 依存タスク
- **前提タスク**: TASK-0001（Keycloak ECS/Fargate インフラ構築）, TASK-0003（DynamoDB テーブル作成）
- **後続タスク**: Phase 2のAPI実装タスク

## 完了条件
- [x] SAMテンプレート基本構成作成
- [x] API Gateway REST API定義
- [x] Lambda Authorizer（JWT検証）実装
- [ ] レート制限（Usage Plan）設定
- [x] 共通レイヤー（common layer）作成

---

## 実装詳細

### 1. SAMテンプレート基本構成作成 🔵
**信頼性**: 🔵 *architecture.mdより*

AWS SAMを使用したサーバーレスアプリケーションの基本構成を定義する。

- **テンプレートファイル**: backend/template.yaml
- **グローバル設定**:
  - Runtime: python3.11
  - Timeout: 30秒
  - MemorySize: 256 MB
  - Tracing: Active（X-Ray）
  - 環境変数: ENVIRONMENT, LOG_LEVEL
- **パラメータ**:
  - Environment: dev/prod
  - KeycloakIssuer: Keycloakの発行者URL
  - KeycloakJwksUri: JWKSエンドポイント
- **出力**:
  - ApiEndpoint
  - AuthorizerFunctionArn

**実装ファイル**: `backend/template.yaml`

### 2. API Gateway REST API定義 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

RESTful APIのエンドポイント構成を定義する。

- **API名**: memoru-api-${Environment}
- **エンドポイントタイプ**: REGIONAL
- **ステージ**: dev, prod
- **ベースパス**: /v1
- **リソース構成**:
  ```
  /v1
    /auth
      /callback    POST - 認証コールバック
      /refresh     POST - トークンリフレッシュ
      /logout      POST - ログアウト
    /users
      /me          GET - ユーザー情報取得
                   PUT - ユーザー情報更新
    /cards
                   GET - カード一覧取得
                   POST - カード作成
      /{card_id}   GET - カード詳細取得
                   PUT - カード更新
                   DELETE - カード削除
    /reviews
      /due         GET - 復習対象カード取得
      /{card_id}   POST - 復習結果登録
  ```
- **バイナリメディアタイプ**: なし
- **ペイロードフォーマット**: JSON

**実装ファイル**: `backend/template.yaml`

### 3. Lambda Authorizer（JWT検証）実装 🔵
**信頼性**: 🔵 *architecture.mdより*

KeycloakのJWTトークンを検証するカスタムオーソライザーを実装する。

- **関数名**: memoru-authorizer-${Environment}
- **ハンドラー**: authorizer.handler
- **認証タイプ**: TOKEN
- **トークンソース**: Authorization ヘッダー
- **キャッシュ**: 300秒（5分）
- **検証項目**:
  - 署名検証（RS256）
  - 発行者（iss）検証
  - 有効期限（exp）検証
  - オーディエンス（aud）検証
- **出力**:
  - principalId: ユーザーID
  - context: line_user_id等の追加情報
- **依存ライブラリ**:
  - python-jose
  - requests（JWKS取得用）

**実装ファイル**: `backend/functions/authorizer/authorizer.py`

### 4. レート制限（Usage Plan）設定 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

API過負荷防止のためのレート制限を設定する。

- **Usage Plan名**: memoru-usage-plan-${Environment}
- **スロットリング**:
  - レートリミット: 100 requests/second
  - バーストリミット: 200 requests
- **クォータ**: なし（無制限）
- **API Key**: 不要（JWT認証のため）
- **メソッド単位の制限**:
  - POST /cards: 10 requests/second
  - POST /reviews/{card_id}: 30 requests/second
- **WAF統合**: オプション（将来対応）

**実装ファイル**: `backend/template.yaml`

### 5. 共通レイヤー（common layer）作成 🔵
**信頼性**: 🔵 *architecture.mdより*

Lambda関数間で共有するコードとライブラリをレイヤー化する。

- **レイヤー名**: memoru-common-layer
- **互換ランタイム**: python3.11
- **含有モジュール**:
  - utils/: 共通ユーティリティ
    - response.py: APIレスポンスヘルパー
    - exceptions.py: カスタム例外クラス
    - validators.py: 入力バリデーション
  - models/: データモデル
    - user.py: ユーザーモデル
    - card.py: カードモデル
    - review.py: レビューモデル
  - services/: 共通サービス
    - dynamodb.py: DynamoDBアクセスヘルパー
- **外部ライブラリ**:
  - boto3（Lambda標準）
  - pydantic
  - python-dateutil

**実装ファイル**: `backend/layers/common/`

### 6. CORS設定 🔵
**信頼性**: 🔵 *architecture.mdより*

クロスオリジンリクエストを許可するCORS設定を行う。

- **許可オリジン**:
  - https://liff.example.com
  - https://liff.line.me
  - http://localhost:3000（開発用）
- **許可メソッド**: GET, POST, PUT, DELETE, OPTIONS
- **許可ヘッダー**: Content-Type, Authorization, X-Amz-Date, X-Api-Key
- **公開ヘッダー**: X-Request-Id
- **認証情報**: true
- **プリフライトキャッシュ**: 86400秒（1日）

**実装ファイル**: `backend/template.yaml`

### 7. ステージ変数・環境設定 🔵
**信頼性**: 🔵 *architecture.mdより*

開発環境と本番環境の切り替えを容易にする設定を行う。

- **ステージ変数**:
  - environment: dev/prod
  - keycloak_issuer: 環境別発行者URL
  - log_level: DEBUG/INFO
- **Lambda環境変数**:
  - ENVIRONMENT: ${stageVariables.environment}
  - KEYCLOAK_ISSUER: ${stageVariables.keycloak_issuer}
  - USERS_TABLE: memoru-users-${Environment}
  - CARDS_TABLE: memoru-cards-${Environment}
  - REVIEWS_TABLE: memoru-reviews-${Environment}
- **デプロイ設定**:
  - dev: 自動デプロイ
  - prod: 手動承認デプロイ

**実装ファイル**: `backend/template.yaml`, `backend/samconfig.toml`

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
   - SAMテンプレート作成
   - Lambda Authorizer実装
   - 共通レイヤー作成
   - CORS設定
   - ローカルテスト（sam local）
2. `/tsumiki:direct-verify` - 動作確認・品質確認
   - SAMビルド確認
   - ローカルAPI起動テスト
   - Authorizer単体テスト
   - デプロイテスト（dev環境）

---

## ディレクトリ構成

```
backend/
├── template.yaml           # SAMテンプレート
├── samconfig.toml          # SAM設定ファイル
├── functions/
│   └── authorizer/
│       ├── authorizer.py   # Authorizerハンドラー
│       └── requirements.txt
├── layers/
│   └── common/
│       └── python/
│           ├── utils/
│           │   ├── __init__.py
│           │   ├── response.py
│           │   ├── exceptions.py
│           │   └── validators.py
│           ├── models/
│           │   ├── __init__.py
│           │   ├── user.py
│           │   ├── card.py
│           │   └── review.py
│           └── services/
│               ├── __init__.py
│               └── dynamodb.py
└── tests/
    └── unit/
        └── test_authorizer.py
```

---

## 注意事項
- Lambda AuthorizerのJWKSはキャッシュして毎回取得しないようにすること
- CORSのOPTIONSメソッドはAuthorizerを通さない設定にすること
- ステージ変数の値は機密情報を含めないこと（Secrets Manager使用）
- 共通レイヤーの更新時は全Lambda関数の再デプロイが必要
- SAM CLI v1.x以上を使用すること
- Pythonの依存関係はrequirements.txtで管理し、sam buildでインストール
- X-Rayトレーシングは本番環境ではサンプリングレートを調整すること

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 7項目
- 🟡 **黄信号**: 0項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
