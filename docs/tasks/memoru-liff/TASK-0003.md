# TASK-0003: DynamoDB テーブル作成

**タスクID**: TASK-0003
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 1 - 基盤構築
**信頼性レベル**: 🔵 *database-schema.mdより*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-402
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)
- **データベース設計**: [database-schema.md](../../design/memoru-liff/database-schema.md)

## タスク概要
memoruアプリケーションのデータ永続化層としてDynamoDBテーブルを作成する。ユーザー情報、暗記カード、復習履歴を管理する3つのテーブルを設計・構築し、効率的なクエリを実現するためのGSIを設定する。SAMテンプレートで定義し、ローカル開発環境でもテスト可能にする。

## 依存タスク
- **前提タスク**: なし
- **後続タスク**: TASK-0005（API Gateway + Lambda 基盤構築）

## 完了条件
- [ ] memoru-users テーブル作成
- [ ] memoru-cards テーブル作成
- [ ] memoru-reviews テーブル作成
- [ ] GSI作成（line_user_id-index, user_id-due-index）
- [ ] PITRバックアップ有効化

---

## 実装詳細

### 1. memoru-users テーブル作成 🔵
**信頼性**: 🔵 *database-schema.mdより*

ユーザー情報を管理するテーブルを作成する。

- **テーブル名**: memoru-users-${Environment}
- **パーティションキー**: user_id (S)
- **ソートキー**: なし
- **属性**:
  - user_id: UUID形式のユーザーID
  - line_user_id: LINE User ID
  - display_name: 表示名
  - picture_url: プロフィール画像URL
  - created_at: 作成日時（ISO 8601）
  - updated_at: 更新日時（ISO 8601）
  - settings: ユーザー設定（Map型）
- **キャパシティモード**: オンデマンド
- **TTL**: なし

**実装ファイル**: `backend/template.yaml`

### 2. memoru-users GSI（line_user_id-index） 🔵
**信頼性**: 🔵 *database-schema.mdより*

LINE User IDからユーザーを検索するためのGSIを作成する。

- **インデックス名**: line_user_id-index
- **パーティションキー**: line_user_id (S)
- **ソートキー**: なし
- **射影タイプ**: ALL
- **用途**: LINE認証時のユーザー検索

**実装ファイル**: `backend/template.yaml`

### 3. memoru-cards テーブル作成 🔵
**信頼性**: 🔵 *database-schema.mdより*

暗記カード情報を管理するテーブルを作成する。

- **テーブル名**: memoru-cards-${Environment}
- **パーティションキー**: user_id (S)
- **ソートキー**: card_id (S)
- **属性**:
  - user_id: ユーザーID
  - card_id: UUID形式のカードID
  - front: 表面テキスト
  - back: 裏面テキスト
  - deck_id: デッキID（オプション）
  - tags: タグリスト（List型）
  - next_review_at: 次回復習日時（ISO 8601）
  - interval: 復習間隔（日数）
  - ease_factor: 難易度係数
  - repetitions: 復習回数
  - created_at: 作成日時
  - updated_at: 更新日時
- **キャパシティモード**: オンデマンド
- **TTL**: なし

**実装ファイル**: `backend/template.yaml`

### 4. memoru-cards GSI（user_id-due-index） 🔵
**信頼性**: 🔵 *database-schema.mdより*

復習期限でカードを検索するためのGSIを作成する。

- **インデックス名**: user_id-due-index
- **パーティションキー**: user_id (S)
- **ソートキー**: next_review_at (S)
- **射影タイプ**: ALL
- **用途**: 復習対象カードの効率的な取得

**実装ファイル**: `backend/template.yaml`

### 5. memoru-reviews テーブル作成 🔵
**信頼性**: 🔵 *database-schema.mdより*

復習履歴を管理するテーブルを作成する。

- **テーブル名**: memoru-reviews-${Environment}
- **パーティションキー**: card_id (S)
- **ソートキー**: reviewed_at (S)
- **属性**:
  - card_id: カードID
  - reviewed_at: 復習日時（ISO 8601）
  - user_id: ユーザーID
  - rating: 評価（1-4: Again, Hard, Good, Easy）
  - response_time_ms: 回答時間（ミリ秒）
  - previous_interval: 前回の間隔
  - new_interval: 新しい間隔
- **キャパシティモード**: オンデマンド
- **TTL属性**: expires_at（90日後に自動削除）

**実装ファイル**: `backend/template.yaml`

### 6. PITRバックアップ・暗号化設定 🔵
**信頼性**: 🔵 *database-schema.mdより*

データ保護のためのバックアップと暗号化を設定する。

- **PITR（Point-in-Time Recovery）**: 全テーブルで有効
- **暗号化**: AWS所有キー（デフォルト）
- **バックアップ保持期間**: 35日間（PITR最大）
- **削除保護**: 本番環境のみ有効

**実装ファイル**: `backend/template.yaml`

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
   - SAMテンプレートにDynamoDB定義追加
   - GSI定義追加
   - PITR・暗号化設定
   - ローカルDynamoDB設定（docker-compose.yaml）
2. `/tsumiki:direct-verify` - 動作確認・品質確認
   - テーブル作成確認
   - GSIクエリテスト
   - PITRステータス確認
   - ローカル環境テスト

---

## SAMテンプレート例

```yaml
Resources:
  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub memoru-users-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: user_id
          AttributeType: S
        - AttributeName: line_user_id
          AttributeType: S
      KeySchema:
        - AttributeName: user_id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: line_user_id-index
          KeySchema:
            - AttributeName: line_user_id
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      PointInTimeRecoverySpecification:
        PointInTimeRecoveryEnabled: true
```

---

## 注意事項
- テーブル名には環境名（dev/prod）を含めて環境分離を行うこと
- GSIの追加・削除は時間がかかるため、設計を慎重に行うこと
- オンデマンドキャパシティモードは初期コストが低いが、大量アクセス時は従量課金に注意
- PITRは追加コストが発生するが、データ保護のため本番では必須
- ローカル開発にはDynamoDB Localを使用し、本番と同じスキーマでテストすること
- TTL設定はreviews テーブルのみに適用し、不要データの自動削除を行う

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 6項目
- 🟡 **黄信号**: 0項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
