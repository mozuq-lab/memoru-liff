# TASK-0004: CloudFront + S3 LIFF ホスティング構築

**タスクID**: TASK-0004
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 1 - 基盤構築
**信頼性レベル**: 🔵 *architecture.mdより*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-404, NFR-101
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)

## タスク概要
LIFFアプリケーション（React SPA）をホスティングするためのAWSインフラストラクチャを構築する。S3バケットで静的ファイルをホスト、CloudFrontでCDN配信とHTTPS通信を実現する。OAC（Origin Access Control）によりS3への直接アクセスを防ぎ、セキュリティを確保する。

## 依存タスク
- **前提タスク**: なし
- **後続タスク**: Phase 2のフロントエンド開発タスク

## 完了条件
- [ ] S3バケット作成（静的ホスティング）
- [ ] CloudFront Distribution作成
- [ ] ACM証明書設定（HTTPS）
- [ ] OAC設定（S3アクセス制御）
- [ ] SPAリダイレクト設定（403/404→index.html）
- [x] CloudFormationテンプレート作成

---

## 実装詳細

### 1. S3バケット作成 🔵
**信頼性**: 🔵 *architecture.mdより*

LIFFアプリケーションの静的ファイルを格納するS3バケットを作成する。

- **バケット名**: memoru-liff-${Environment}-${AccountId}
- **リージョン**: ap-northeast-1
- **パブリックアクセス**: 完全ブロック
- **バージョニング**: 有効
- **暗号化**: SSE-S3（AES-256）
- **オブジェクトロック**: 無効
- **ライフサイクルルール**:
  - 非現行バージョン: 30日後削除
  - 不完全なマルチパートアップロード: 7日後削除

**実装ファイル**: `infrastructure/liff-hosting/s3.yaml`

### 2. CloudFront Distribution作成 🔵
**信頼性**: 🔵 *architecture.mdより*

グローバルCDN配信のためのCloudFront Distributionを作成する。

- **Distribution設定**:
  - オリジン: S3バケット（OAC経由）
  - プロトコルポリシー: HTTPS Only
  - 最小TTL: 0
  - デフォルトTTL: 86400（1日）
  - 最大TTL: 31536000（1年）
- **キャッシュ動作**:
  - デフォルト（*）: CachingOptimized
  - /static/*: CachingOptimized（長期キャッシュ）
  - /index.html: CachingDisabled（常に最新）
- **ビューワープロトコルポリシー**: redirect-to-https
- **HTTP/2**: 有効
- **HTTP/3**: 有効
- **価格クラス**: PriceClass_200（日本含む）

**実装ファイル**: `infrastructure/liff-hosting/cloudfront.yaml`

### 3. ACM証明書設定 🔵
**信頼性**: 🔵 *architecture.mdより*

HTTPS通信のためのSSL/TLS証明書を設定する。

- **証明書ドメイン**: liff.example.com
- **リージョン**: us-east-1（CloudFront用）
- **検証方法**: DNS検証
- **キーアルゴリズム**: RSA 2048
- **追加ドメイン名（SAN）**: なし
- **自動更新**: 有効

**実装ファイル**: `infrastructure/liff-hosting/acm.yaml`

### 4. OAC（Origin Access Control）設定 🔵
**信頼性**: 🔵 *architecture.mdより*

CloudFrontからS3への安全なアクセスを設定する。

- **OAC名**: memoru-liff-oac
- **署名動作**: Always
- **オリジンタイプ**: S3
- **S3バケットポリシー**:
  - Principal: cloudfront.amazonaws.com
  - Condition: SourceArn = CloudFront Distribution ARN
- **直接S3アクセス**: 拒否

**実装ファイル**: `infrastructure/liff-hosting/cloudfront.yaml`

### 5. SPAリダイレクト設定 🔵
**信頼性**: 🔵 *architecture.mdより*

React Router等のクライアントサイドルーティング対応を設定する。

- **カスタムエラーレスポンス**:
  - 403エラー → /index.html（200）
  - 404エラー → /index.html（200）
- **エラーキャッシュTTL**: 0秒
- **デフォルトルートオブジェクト**: index.html

**実装ファイル**: `infrastructure/liff-hosting/cloudfront.yaml`

### 6. Route53レコード設定 🔵
**信頼性**: 🔵 *architecture.mdより*

カスタムドメインでLIFFアプリにアクセスできるようにする。

- **レコード名**: liff.example.com
- **レコードタイプ**: A（エイリアス）
- **ターゲット**: CloudFront Distribution
- **ルーティングポリシー**: シンプル

**実装ファイル**: `infrastructure/liff-hosting/dns.yaml`

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
   - ACM証明書作成（us-east-1）
   - DNS検証レコード追加
   - S3バケット作成
   - CloudFront Distribution作成
   - OAC設定
   - Route53レコード追加
2. `/tsumiki:direct-verify` - 動作確認・品質確認
   - 証明書発行確認
   - S3アップロードテスト
   - CloudFrontアクセス確認
   - HTTPS確認
   - SPAルーティング確認

---

## CloudFormationテンプレート例

```yaml
Resources:
  LiffBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub memoru-liff-${Environment}-${AWS::AccountId}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      VersioningConfiguration:
        Status: Enabled

  LiffDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt LiffBucket.RegionalDomainName
            OriginAccessControlId: !Ref LiffOAC
            S3OriginConfig:
              OriginAccessIdentity: ''
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 200
            ResponsePagePath: /index.html
          - ErrorCode: 404
            ResponseCode: 200
            ResponsePagePath: /index.html
```

---

## 注意事項
- ACM証明書はus-east-1リージョンで作成する必要がある（CloudFront要件）
- DNS検証は証明書発行に最大30分程度かかる場合がある
- CloudFrontのデプロイは15-20分程度かかる
- OACはOAI（Origin Access Identity）の後継機能であり、新規作成時はOACを使用すること
- S3バケット名はグローバルで一意である必要がある
- SPAリダイレクト設定がないとReact Routerのパスでリロード時に404エラーになる
- キャッシュ無効化（Invalidation）のコストに注意（月1000パス無料）

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 6項目
- 🟡 **黄信号**: 0項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
