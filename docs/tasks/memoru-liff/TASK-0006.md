# TASK-0006: ユーザー管理API実装

**タスクID**: TASK-0006
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 2 - バックエンド実装
**信頼性レベル**: 🔵 *api-endpoints.mdより*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-001, REQ-003, REQ-043, REQ-202
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)
- **API仕様**: [api-endpoints.md](../../design/memoru-liff/api-endpoints.md)

## タスク概要
ユーザー管理に関するREST APIエンドポイントを実装する。LINE連携機能、ユーザー情報取得、通知時間設定などのユーザー関連機能を提供し、認証済みユーザーのみがアクセス可能とする。

## 依存タスク
- **前提タスク**: TASK-0005（Cognito・API Gateway認証設定）
- **後続タスク**: TASK-0007（カード管理API実装）

## 完了条件
- [x] POST /users/link-line 実装
- [x] GET /users/me 実装
- [x] PUT /users/me/settings 実装
- [x] LINE連携（line_user_id保存）機能実装
- [x] 通知時間設定機能実装
- [x] 単体テストカバレッジ80%以上

---

## 実装詳細

### 1. POST /users/link-line エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

LINE UserIDをCognitoユーザーと紐付けるエンドポイントを実装する。

**リクエスト**:
```json
{
  "line_user_id": "U1234567890abcdef..."
}
```

**レスポンス**:
```json
{
  "success": true,
  "message": "LINE account linked successfully"
}
```

**処理フロー**:
1. JWTトークンからuser_idを取得
2. line_user_idの形式バリデーション（U + 32文字の英数字）
3. 既存の連携チェック（重複防止）
4. DynamoDB Usersテーブルにline_user_id保存
5. 成功レスポンス返却

**実装ファイル**: `backend/functions/api_main/handlers/users.py`

### 2. GET /users/me エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

認証済みユーザーの自身の情報を取得するエンドポイントを実装する。

**レスポンス**:
```json
{
  "user_id": "uuid-string",
  "email": "user@example.com",
  "line_linked": true,
  "notification_time": "09:00",
  "timezone": "Asia/Tokyo",
  "created_at": "2024-01-01T00:00:00Z"
}
```

**処理フロー**:
1. JWTトークンからuser_idを取得
2. DynamoDB Usersテーブルからユーザー情報取得
3. ユーザーが存在しない場合は404エラー
4. レスポンス形式に整形して返却

**実装ファイル**: `backend/functions/api_main/handlers/users.py`

### 3. PUT /users/me/settings エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

ユーザー設定を更新するエンドポイントを実装する。

**リクエスト**:
```json
{
  "notification_time": "09:00",
  "timezone": "Asia/Tokyo"
}
```

**レスポンス**:
```json
{
  "success": true,
  "settings": {
    "notification_time": "09:00",
    "timezone": "Asia/Tokyo"
  }
}
```

**バリデーション**:
- notification_time: HH:MM形式（00:00-23:59）
- timezone: 有効なIANAタイムゾーン

**実装ファイル**: `backend/functions/api_main/handlers/users.py`

### 4. 認証ミドルウェア連携 🔵
**信頼性**: 🔵 *architecture.mdより*

API Gateway + Cognito Authorizerで認証されたリクエストからuser_idを抽出する共通処理を実装する。

**処理内容**:
- requestContext.authorizer.claimsからsub（user_id）を取得
- 未認証リクエストは401エラー返却

**実装ファイル**: `backend/functions/api_main/middleware/auth.py`

---

## 単体テスト要件

### テストケース1: LINE連携成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、有効なline_user_id
**When**: POST /users/link-line を呼び出す
**Then**: 200 OK、line_user_idがDBに保存される

### テストケース2: LINE連携 - 無効なline_user_id形式 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、不正な形式のline_user_id
**When**: POST /users/link-line を呼び出す
**Then**: 400 Bad Request、バリデーションエラーメッセージ

### テストケース3: LINE連携 - 既に連携済み 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 既にLINE連携済みのユーザー
**When**: 別のline_user_idでPOST /users/link-line を呼び出す
**Then**: 409 Conflict、既存連携の上書き防止

### テストケース4: ユーザー情報取得成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー（DBに存在）
**When**: GET /users/me を呼び出す
**Then**: 200 OK、ユーザー情報が返却される

### テストケース5: ユーザー情報取得 - ユーザー未登録 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みだがDBにユーザー未登録
**When**: GET /users/me を呼び出す
**Then**: 404 Not Found

### テストケース6: 設定更新成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、有効な設定値
**When**: PUT /users/me/settings を呼び出す
**Then**: 200 OK、設定が更新される

### テストケース7: 設定更新 - 無効な通知時間 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、不正な通知時間形式（例: "25:00"）
**When**: PUT /users/me/settings を呼び出す
**Then**: 400 Bad Request、バリデーションエラー

### テストケース8: 設定更新 - 無効なタイムゾーン 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、存在しないタイムゾーン
**When**: PUT /users/me/settings を呼び出す
**Then**: 400 Bad Request、バリデーションエラー

### テストケース9: 認証エラー - トークンなし 🔵
**信頼性**: 🔵 *architecture.mdより*
**Given**: 認証トークンなしのリクエスト
**When**: 任意のユーザーAPIを呼び出す
**Then**: 401 Unauthorized

### テストケース10: 認証エラー - 無効なトークン 🔵
**信頼性**: 🔵 *architecture.mdより*
**Given**: 無効/期限切れのJWTトークン
**When**: 任意のユーザーAPIを呼び出す
**Then**: 401 Unauthorized

---

## 統合テスト要件

### 統合テスト1: ユーザー登録からLINE連携までのフロー 🔵
**信頼性**: 🔵 *dataflow.mdより*
**テスト内容**: Cognitoでユーザー作成 → LINE連携 → ユーザー情報取得の一連のフローが正常に動作することを確認

### 統合テスト2: 設定変更の永続化確認 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**テスト内容**: 設定更新後、GET /users/meで変更が反映されていることを確認

---

## 実装手順

### TDDタスクの場合
1. `/tsumiki:tdd-requirements TASK-0006` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項
- line_user_idは機密情報として扱い、ログ出力時はマスキングする
- 通知時間はユーザーのローカルタイムゾーンで保存する
- DynamoDB更新時は楽観的ロック（version属性）を使用することを推奨
- LINE連携解除機能は本フェーズでは対象外（将来対応）

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 14項目
- 🟡 **黄信号**: 0項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
