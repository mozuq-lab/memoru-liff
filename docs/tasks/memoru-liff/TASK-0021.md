# TASK-0021: LINEçµ±åˆãƒ†ã‚¹ãƒˆ

**ã‚¿ã‚¹ã‚¯ID**: TASK-0021
**ã‚¿ã‚¹ã‚¯ã‚¿ã‚¤ãƒ—**: TDD
**æ¨å®šå·¥æ•°**: 8æ™‚é–“
**ãƒ•ã‚§ãƒ¼ã‚º**: Phase 4 - çµ±åˆãƒ†ã‚¹ãƒˆ
**ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«**: ğŸŸ¡ *acceptance-criteria.mdã‚ˆã‚Šå¦¥å½“ãªæ¨æ¸¬*

## é–¢é€£æ–‡æ›¸
- **æ¦‚è¦**: [overview.md](overview.md)
- **è¦ä»¶å®šç¾©**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-041, REQ-051, REQ-412
- **è¨­è¨ˆæ–‡æ›¸**: [architecture.md](../../design/memoru-liff/architecture.md)
- **å—ã‘å…¥ã‚ŒåŸºæº–**: [acceptance-criteria.md](../../spec/memoru-liff/acceptance-criteria.md)

## ã‚¿ã‚¹ã‚¯æ¦‚è¦
LINE Messaging APIã¨ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè£…ã™ã‚‹ã€‚Webhookå—ä¿¡å‡¦ç†ã€Flex Messageé€ä¿¡ã€Postbackå‡¦ç†ã€å®šæœŸå¾©ç¿’é€šçŸ¥ã®å„æ©Ÿèƒ½ã«ã¤ã„ã¦ã€ãƒ¢ãƒƒã‚¯ã‚’æ´»ç”¨ã—ãŸçµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’æ§‹ç¯‰ã™ã‚‹ã€‚

## ä¾å­˜ã‚¿ã‚¹ã‚¯
- **å‰æã‚¿ã‚¹ã‚¯**: TASK-0010ï¼ˆLINE Messaging APIçµ±åˆï¼‰, TASK-0011ï¼ˆWebhookå—ä¿¡ãƒãƒ³ãƒ‰ãƒ©ï¼‰
- **å¾Œç¶šã‚¿ã‚¹ã‚¯**: TASK-0022ï¼ˆæœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æº–å‚™ï¼‰

## å®Œäº†æ¡ä»¶
- [x] LINE Webhookçµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè£…
- [x] Flex Messageé€ä¿¡ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [x] Postbackå‡¦ç†ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [x] å®šæœŸé€šçŸ¥ãƒ†ã‚¹ãƒˆå®Ÿè£…
- [x] LINE APIãƒ¢ãƒƒã‚¯è¨­å®šå®Œäº†
- [x] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ‘ã‚¹

---

## å®Ÿè£…è©³ç´°

### 1. LINE APIãƒ¢ãƒƒã‚¯è¨­å®š ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *ä¸€èˆ¬çš„ãªãƒ¢ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰æ¨æ¸¬*

LINE Messaging APIã®ãƒ¢ãƒƒã‚¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹ã€‚

```python
# backend/tests/conftest.py
import pytest
from unittest.mock import MagicMock, patch

@pytest.fixture
def mock_line_client():
    """LINE Messaging APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã®ãƒ¢ãƒƒã‚¯"""
    with patch('linebot.v3.messaging.MessagingApi') as mock:
        client = MagicMock()
        mock.return_value = client

        # push_message ã®ãƒ¢ãƒƒã‚¯
        client.push_message.return_value = None

        # reply_message ã®ãƒ¢ãƒƒã‚¯
        client.reply_message.return_value = None

        yield client

@pytest.fixture
def webhook_signature():
    """Webhookç½²åç”Ÿæˆãƒ˜ãƒ«ãƒ‘ãƒ¼"""
    import hmac
    import hashlib
    import base64

    def generate(body: str, channel_secret: str) -> str:
        hash = hmac.new(
            channel_secret.encode('utf-8'),
            body.encode('utf-8'),
            hashlib.sha256
        ).digest()
        return base64.b64encode(hash).decode('utf-8')

    return generate
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/tests/conftest.py`

### 2. Webhookçµ±åˆãƒ†ã‚¹ãƒˆ ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *acceptance-criteria.mdã‚ˆã‚Šæ¨æ¸¬*

LINE Webhookã‚¤ãƒ™ãƒ³ãƒˆã®E2Eå‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚

```python
# backend/tests/integration/test_line_webhook.py
import pytest
import json
from fastapi.testclient import TestClient
from app.main import app

class TestLineWebhook:
    """LINE Webhookçµ±åˆãƒ†ã‚¹ãƒˆ"""

    def test_postback_grade_5_updates_card(
        self,
        client: TestClient,
        mock_line_client,
        webhook_signature,
        test_card
    ):
        """TC-032-01: grade=5ã§ã®Postbackå‡¦ç†ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        postback_data = f"action=grade&card_id={test_card.id}&grade=5"
        event = {
            "events": [{
                "type": "postback",
                "replyToken": "test_reply_token",
                "source": {"userId": "U1234567890", "type": "user"},
                "postback": {"data": postback_data}
            }]
        }
        body = json.dumps(event)
        signature = webhook_signature(body, "test_channel_secret")

        # Act
        response = client.post(
            "/webhook/line",
            content=body,
            headers={
                "X-Line-Signature": signature,
                "Content-Type": "application/json"
            }
        )

        # Assert
        assert response.status_code == 200

        # ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
        updated_card = get_card_by_id(test_card.id)
        assert updated_card.ease_factor > test_card.ease_factor
        assert updated_card.review_count == test_card.review_count + 1

        # è¿”ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€ä¿¡ã•ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        mock_line_client.reply_message.assert_called_once()

    def test_webhook_signature_validation(
        self,
        client: TestClient
    ):
        """ä¸æ­£ãªç½²åã®Webhookã¯æ‹’å¦ã•ã‚Œã‚‹"""
        event = {"events": []}
        body = json.dumps(event)

        response = client.post(
            "/webhook/line",
            content=body,
            headers={
                "X-Line-Signature": "invalid_signature",
                "Content-Type": "application/json"
            }
        )

        assert response.status_code == 400
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/tests/integration/test_line_webhook.py`

### 3. å®šæœŸé€šçŸ¥çµ±åˆãƒ†ã‚¹ãƒˆ ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *acceptance-criteria.mdã‚ˆã‚Šæ¨æ¸¬*

å¾©ç¿’é€šçŸ¥ã®ãƒ—ãƒƒã‚·ãƒ¥é€ä¿¡ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚

```python
# backend/tests/integration/test_due_push.py
import pytest
from datetime import datetime, timedelta
from unittest.mock import MagicMock, call

class TestDuePushNotification:
    """å®šæœŸå¾©ç¿’é€šçŸ¥çµ±åˆãƒ†ã‚¹ãƒˆ"""

    def test_tc_041_01_single_due_card_notification(
        self,
        mock_line_client,
        test_user,
        due_card
    ):
        """TC-041-01: å¾©ç¿’æœŸé™ã‚«ãƒ¼ãƒ‰ã®é€šçŸ¥é€ä¿¡"""
        # Arrange
        from app.services.notification import NotificationService
        service = NotificationService(line_client=mock_line_client)

        # Act
        result = service.send_due_notifications()

        # Assert
        mock_line_client.push_message.assert_called_once()
        call_args = mock_line_client.push_message.call_args

        # ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãŒæ­£ã—ã„ã“ã¨
        assert call_args.kwargs['to'] == test_user.line_user_id

        # Flex MessageãŒé€ä¿¡ã•ã‚Œã¦ã„ã‚‹ã“ã¨
        message = call_args.kwargs['messages'][0]
        assert message.type == 'flex'
        assert 'å¾©ç¿’ã‚«ãƒ¼ãƒ‰' in str(message.contents)

    def test_tc_041_02_multiple_due_cards_notification(
        self,
        mock_line_client,
        test_user,
        multiple_due_cards
    ):
        """TC-041-02: è¤‡æ•°ã‚«ãƒ¼ãƒ‰ã®é€šçŸ¥ãƒ†ã‚¹ãƒˆ"""
        # Arrange
        from app.services.notification import NotificationService
        service = NotificationService(line_client=mock_line_client)

        # Act
        result = service.send_due_notifications()

        # Assert
        mock_line_client.push_message.assert_called_once()
        call_args = mock_line_client.push_message.call_args

        # Flex Messageã«è¤‡æ•°ã‚«ãƒ¼ãƒ‰ãŒå«ã¾ã‚Œã‚‹ã“ã¨
        message = call_args.kwargs['messages'][0]
        assert message.type == 'flex'

        # Carouselå½¢å¼ã§è¤‡æ•°ã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨
        contents = message.contents
        assert contents.type == 'carousel'
        assert len(contents.contents) == len(multiple_due_cards)

    def test_no_due_cards_no_notification(
        self,
        mock_line_client,
        test_user
    ):
        """å¾©ç¿’æœŸé™ã‚«ãƒ¼ãƒ‰ãŒãªã„å ´åˆã¯é€šçŸ¥ã—ãªã„"""
        # Arrange
        from app.services.notification import NotificationService
        service = NotificationService(line_client=mock_line_client)

        # Act
        result = service.send_due_notifications()

        # Assert
        mock_line_client.push_message.assert_not_called()
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/tests/integration/test_due_push.py`

### 4. Flex Messageæ§‹ç¯‰ãƒ†ã‚¹ãƒˆ ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *LINE Messaging APIä»•æ§˜ã‹ã‚‰æ¨æ¸¬*

Flex Messageã®æ§‹é€ ã¨å†…å®¹ã‚’ãƒ†ã‚¹ãƒˆã™ã‚‹ã€‚

```python
# backend/tests/integration/test_flex_message.py
import pytest
from app.services.line_message import FlexMessageBuilder

class TestFlexMessageBuilder:
    """Flex Messageæ§‹ç¯‰ãƒ†ã‚¹ãƒˆ"""

    def test_build_review_card_message(self, test_card):
        """å¾©ç¿’ã‚«ãƒ¼ãƒ‰ã®Flex Messageæ§‹ç¯‰"""
        builder = FlexMessageBuilder()
        message = builder.build_review_card(test_card)

        assert message.type == 'flex'
        assert message.alt_text == 'å¾©ç¿’ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã™'

        # Bubbleæ§‹é€ ã®ç¢ºèª
        bubble = message.contents
        assert bubble.type == 'bubble'
        assert bubble.body is not None
        assert bubble.footer is not None

        # Postbackã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç¢ºèª
        footer = bubble.footer
        buttons = footer.contents
        assert len(buttons) == 5  # grade 1-5

        for i, button in enumerate(buttons, 1):
            assert button.action.type == 'postback'
            assert f'grade={i}' in button.action.data

    def test_build_carousel_message(self, multiple_cards):
        """è¤‡æ•°ã‚«ãƒ¼ãƒ‰ã®Carousel Messageæ§‹ç¯‰"""
        builder = FlexMessageBuilder()
        message = builder.build_review_carousel(multiple_cards)

        carousel = message.contents
        assert carousel.type == 'carousel'
        assert len(carousel.contents) == len(multiple_cards)
```

**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«**: `backend/tests/integration/test_flex_message.py`

---

## ãƒ†ã‚¹ãƒˆè¦ä»¶

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: å¾©ç¿’é€šçŸ¥é€ä¿¡ ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *acceptance-criteria.mdã‚ˆã‚Šæ¨æ¸¬*
**é–¢é€£TC**: TC-041-01
**ãƒ†ã‚¹ãƒˆå†…å®¹**: å¾©ç¿’æœŸé™ãŒåˆ°æ¥ã—ãŸã‚«ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€è©²å½“ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«LINEãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒé€ä¿¡ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: è¤‡æ•°ã‚«ãƒ¼ãƒ‰ã®é€šçŸ¥ ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *acceptance-criteria.mdã‚ˆã‚Šæ¨æ¸¬*
**é–¢é€£TC**: TC-041-02
**ãƒ†ã‚¹ãƒˆå†…å®¹**: è¤‡æ•°ã®å¾©ç¿’æœŸé™ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€Carouselå½¢å¼ã®Flex Messageã§ä¸€æ‹¬é€šçŸ¥ã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

### ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: grade=5ã§ã®æ¡ç‚¹å‡¦ç† ğŸŸ¡
**ä¿¡é ¼æ€§**: ğŸŸ¡ *acceptance-criteria.mdã‚ˆã‚Šæ¨æ¸¬*
**é–¢é€£TC**: TC-032-01
**ãƒ†ã‚¹ãƒˆå†…å®¹**: Postbackã‚¤ãƒ™ãƒ³ãƒˆã§Grade 5ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€SM-2ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«å¾“ã£ã¦ã‚«ãƒ¼ãƒ‰æƒ…å ±ãŒæ›´æ–°ã•ã‚Œã€æ¬¡å›å¾©ç¿’æ—¥ãŒè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèªã™ã‚‹ã€‚

---

## å®Ÿè£…æ‰‹é †

### TDDã‚¿ã‚¹ã‚¯ã®å ´åˆ
1. `/tsumiki:tdd-requirements TASK-0021` - è©³ç´°è¦ä»¶å®šç¾©
2. `/tsumiki:tdd-testcases` - ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ä½œæˆ
3. `/tsumiki:tdd-red` - ãƒ†ã‚¹ãƒˆå®Ÿè£…ï¼ˆå¤±æ•—ï¼‰
4. `/tsumiki:tdd-green` - æœ€å°å®Ÿè£…
5. `/tsumiki:tdd-refactor` - ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°
6. `/tsumiki:tdd-verify-complete` - å“è³ªç¢ºèª

---

## æ³¨æ„äº‹é …
- LINE Messaging APIã¸ã®å®Ÿéš›ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯è¡Œã‚ãšã€ã™ã¹ã¦ãƒ¢ãƒƒã‚¯ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨
- Webhookç½²åæ¤œè¨¼ã¯æœ¬ç•ªã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã€ãƒ†ã‚¹ãƒˆç”¨ã®ç½²åã‚’ç”Ÿæˆã™ã‚‹ã“ã¨
- å®šæœŸé€šçŸ¥ãƒ†ã‚¹ãƒˆã¯EventBridge Schedulerã®ãƒˆãƒªã‚¬ãƒ¼ã§ã¯ãªãã€ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ç›´æ¥å‘¼ã³å‡ºã—ã§ãƒ†ã‚¹ãƒˆã™ã‚‹
- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯fixtureã‚’æ´»ç”¨ã—ã€ãƒ†ã‚¹ãƒˆé–“ã®ç‹¬ç«‹æ€§ã‚’ä¿ã¤

---

## ä¿¡é ¼æ€§ãƒ¬ãƒ™ãƒ«ã‚µãƒãƒªãƒ¼
- ğŸ”µ **é’ä¿¡å·**: 0é …ç›®
- ğŸŸ¡ **é»„ä¿¡å·**: 7é …ç›®ï¼ˆAPIãƒ¢ãƒƒã‚¯ã€Webhookãƒ†ã‚¹ãƒˆã€å®šæœŸé€šçŸ¥ãƒ†ã‚¹ãƒˆã€Flex Messageãƒ†ã‚¹ãƒˆã€TC-041-01ã€œ02ã€TC-032-01ï¼‰
- ğŸ”´ **èµ¤ä¿¡å·**: 0é …ç›®

**å“è³ªè©•ä¾¡**: è¦æ”¹å–„ - acceptance-criteria.mdã«åŸºã¥ãæ¨æ¸¬ãŒä¸»ã§ã‚ã‚Šã€LINE APIä»•æ§˜ã¨ã®æ•´åˆæ€§ç¢ºèªãŒå¿…è¦
