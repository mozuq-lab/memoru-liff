# TASK-0007: カード管理API実装

**タスクID**: TASK-0007
**タスクタイプ**: TDD
**推定工数**: 8時間
**フェーズ**: Phase 2 - バックエンド実装
**信頼性レベル**: 🔵 *api-endpoints.mdより*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-011, REQ-012, REQ-013, REQ-014
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)
- **API仕様**: [api-endpoints.md](../../design/memoru-liff/api-endpoints.md)

## タスク概要
フラッシュカードのCRUD操作を提供するREST APIエンドポイントを実装する。複数カードの一括保存、ページネーション対応の一覧取得、カード数上限チェック（2,000枚）などの機能を含む。

## 依存タスク
- **前提タスク**: TASK-0006（ユーザー管理API実装）
- **後続タスク**: TASK-0008（SM-2アルゴリズム・復習API実装）、TASK-0009（AIカード生成API実装）

## 完了条件
- [ ] POST /cards 実装（複数カード保存）
- [ ] GET /cards 実装（ページネーション）
- [ ] GET /cards/:card_id 実装
- [ ] PUT /cards/:card_id 実装
- [ ] DELETE /cards/:card_id 実装
- [ ] カード数制限（2,000枚）チェック実装
- [ ] 単体テストカバレッジ80%以上

---

## 実装詳細

### 1. POST /cards エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

複数のフラッシュカードを一括で作成するエンドポイントを実装する。

**リクエスト**:
```json
{
  "cards": [
    {
      "front": "問題文1",
      "back": "解答1",
      "tags": ["英語", "文法"]
    },
    {
      "front": "問題文2",
      "back": "解答2",
      "tags": ["英語", "単語"]
    }
  ]
}
```

**レスポンス**:
```json
{
  "created_cards": [
    {
      "card_id": "uuid-1",
      "front": "問題文1",
      "back": "解答1",
      "tags": ["英語", "文法"],
      "created_at": "2024-01-01T00:00:00Z"
    }
  ],
  "total_count": 2
}
```

**処理フロー**:
1. JWTからuser_id取得
2. 現在のカード数を取得
3. カード数上限チェック（現在数 + 追加数 <= 2,000）
4. DynamoDB TransactWriteItemsで一括保存
5. SM-2初期値設定（ease_factor: 2.5, interval: 0, repetitions: 0）
6. 成功レスポンス返却

**バリデーション**:
- front: 1-500文字
- back: 1-2000文字
- tags: 最大10個、各50文字以内
- 一度に保存可能: 最大25枚（TransactWriteItems制限）

**実装ファイル**: `backend/functions/api_main/handlers/cards.py`

### 2. GET /cards エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

ユーザーのカード一覧をページネーション付きで取得するエンドポイントを実装する。

**クエリパラメータ**:
- `limit`: 取得件数（デフォルト: 20、最大: 100）
- `cursor`: ページネーションカーソル（LastEvaluatedKey）
- `tag`: タグでフィルタリング（オプション）

**レスポンス**:
```json
{
  "cards": [
    {
      "card_id": "uuid-1",
      "front": "問題文1",
      "back": "解答1",
      "tags": ["英語"],
      "due_date": "2024-01-02",
      "ease_factor": 2.5,
      "interval": 1,
      "repetitions": 1,
      "created_at": "2024-01-01T00:00:00Z",
      "updated_at": "2024-01-01T12:00:00Z"
    }
  ],
  "next_cursor": "encoded-cursor-string",
  "total_count": 150
}
```

**実装ファイル**: `backend/functions/api_main/handlers/cards.py`

### 3. GET /cards/:card_id エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

特定のカード詳細を取得するエンドポイントを実装する。

**レスポンス**:
```json
{
  "card_id": "uuid-1",
  "front": "問題文1",
  "back": "解答1",
  "tags": ["英語", "文法"],
  "due_date": "2024-01-02",
  "ease_factor": 2.5,
  "interval": 1,
  "repetitions": 1,
  "review_history": [
    {
      "reviewed_at": "2024-01-01T12:00:00Z",
      "grade": 4
    }
  ],
  "created_at": "2024-01-01T00:00:00Z",
  "updated_at": "2024-01-01T12:00:00Z"
}
```

**認可チェック**:
- カードのuser_idとリクエストuser_idの一致確認
- 不一致の場合は404 Not Found（存在を隠蔽）

**実装ファイル**: `backend/functions/api_main/handlers/cards.py`

### 4. PUT /cards/:card_id エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

カードの内容を更新するエンドポイントを実装する。

**リクエスト**:
```json
{
  "front": "更新後の問題文",
  "back": "更新後の解答",
  "tags": ["英語", "更新タグ"]
}
```

**レスポンス**:
```json
{
  "card_id": "uuid-1",
  "front": "更新後の問題文",
  "back": "更新後の解答",
  "tags": ["英語", "更新タグ"],
  "updated_at": "2024-01-02T00:00:00Z"
}
```

**注意**: SM-2パラメータ（ease_factor, interval, repetitions）は復習APIでのみ更新可能

**実装ファイル**: `backend/functions/api_main/handlers/cards.py`

### 5. DELETE /cards/:card_id エンドポイント実装 🔵
**信頼性**: 🔵 *api-endpoints.mdより*

カードを削除するエンドポイントを実装する（論理削除ではなく物理削除）。

**レスポンス**:
```json
{
  "success": true,
  "message": "Card deleted successfully"
}
```

**実装ファイル**: `backend/functions/api_main/handlers/cards.py`

### 6. カード数上限チェック機能 🔵
**信頼性**: 🔵 *requirements.mdより*

ユーザーあたりのカード数を2,000枚に制限する機能を実装する。

**処理内容**:
- Usersテーブルにcard_count属性を持つ
- カード作成時にTransactWriteItemsでアトミックにインクリメント
- カード削除時にアトミックにデクリメント
- 上限超過時は429 Too Many Requests返却

**実装ファイル**: `backend/functions/api_main/services/card_service.py`

---

## 単体テスト要件

### テストケース1: カード作成成功（単一） 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、有効なカードデータ1件
**When**: POST /cards を呼び出す
**Then**: 201 Created、カードがDBに保存される

### テストケース2: カード作成成功（複数） 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、有効なカードデータ5件
**When**: POST /cards を呼び出す
**Then**: 201 Created、5件すべてがDBに保存される

### テストケース3: カード作成 - 上限到達（境界値: 2,000枚） 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、既存カード1,999枚
**When**: カード1件をPOST /cards で作成
**Then**: 201 Created、総数2,000枚となる

### テストケース4: カード作成 - 上限超過（境界値: 2,001枚） 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、既存カード2,000枚
**When**: カード1件をPOST /cards で作成
**Then**: 429 Too Many Requests、エラーメッセージ

### テストケース5: カード作成 - バリデーションエラー（front空） 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、frontが空のカードデータ
**When**: POST /cards を呼び出す
**Then**: 400 Bad Request

### テストケース6: カード一覧取得成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、カード50枚保有
**When**: GET /cards?limit=20 を呼び出す
**Then**: 200 OK、20件のカードとnext_cursorが返却

### テストケース7: カード一覧取得 - ページネーション 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、next_cursor保持
**When**: GET /cards?cursor={next_cursor} を呼び出す
**Then**: 200 OK、次ページのカードが返却

### テストケース8: カード詳細取得成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、自身のカードID
**When**: GET /cards/:card_id を呼び出す
**Then**: 200 OK、カード詳細が返却

### テストケース9: カード詳細取得 - 他ユーザーのカード 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、他ユーザーのカードID
**When**: GET /cards/:card_id を呼び出す
**Then**: 404 Not Found（セキュリティ上、存在を隠蔽）

### テストケース10: カード詳細取得 - 存在しないID 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、存在しないカードID
**When**: GET /cards/:card_id を呼び出す
**Then**: 404 Not Found

### テストケース11: カード更新成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、自身のカードID、有効な更新データ
**When**: PUT /cards/:card_id を呼び出す
**Then**: 200 OK、カードが更新される

### テストケース12: カード削除成功 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**Given**: 認証済みユーザー、自身のカードID
**When**: DELETE /cards/:card_id を呼び出す
**Then**: 200 OK、カードが削除、card_countがデクリメント

### テストケース13: カード削除 - 他ユーザーのカード 🔵
**信頼性**: 🔵 *requirements.mdより*
**Given**: 認証済みユーザー、他ユーザーのカードID
**When**: DELETE /cards/:card_id を呼び出す
**Then**: 404 Not Found

---

## 統合テスト要件

### 統合テスト1: カードCRUD一連フロー 🔵
**信頼性**: 🔵 *api-endpoints.mdより*
**テスト内容**: カード作成 → 一覧取得 → 詳細取得 → 更新 → 削除の一連フローが正常に動作することを確認

### 統合テスト2: TransactWriteItemsのアトミック性確認 🔵
**信頼性**: 🔵 *architecture.mdより*
**テスト内容**: 複数カード作成時にエラーが発生した場合、すべてロールバックされることを確認

### 統合テスト3: card_countの整合性確認 🔵
**信頼性**: 🔵 *requirements.mdより*
**テスト内容**: カード作成・削除後のcard_count値が実際のカード数と一致することを確認

---

## 実装手順

### TDDタスクの場合
1. `/tsumiki:tdd-requirements TASK-0007` - 詳細要件定義
2. `/tsumiki:tdd-testcases` - テストケース作成
3. `/tsumiki:tdd-red` - テスト実装（失敗）
4. `/tsumiki:tdd-green` - 最小実装
5. `/tsumiki:tdd-refactor` - リファクタリング
6. `/tsumiki:tdd-verify-complete` - 品質確認

---

## 注意事項
- TransactWriteItemsは最大25アイテムの制限があるため、大量カード作成時は分割処理が必要
- カードIDはUUID v4を使用し、予測不可能にする
- due_dateはUTC日付で保存し、表示時にユーザーのタイムゾーンに変換
- 削除は物理削除のため、誤削除時の復旧は不可能（将来的にソフトデリート検討）
- タグ検索はGSIを使用する設計だが、初期リリースでは単純なフィルタリングで対応可能

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 19項目
- 🟡 **黄信号**: 0項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
