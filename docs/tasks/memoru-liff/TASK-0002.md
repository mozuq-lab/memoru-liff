# TASK-0002: Keycloak Realm/Client 設定

**タスクID**: TASK-0002
**タスクタイプ**: DIRECT
**推定工数**: 4時間
**フェーズ**: Phase 1 - 基盤構築
**信頼性レベル**: 🔵 *PRD第3章より*

## 関連文書
- **概要**: [overview.md](overview.md)
- **要件定義**: [requirements.md](../../spec/memoru-liff/requirements.md) - REQ-001, REQ-002, REQ-003
- **設計文書**: [architecture.md](../../design/memoru-liff/architecture.md)

## タスク概要
Keycloakにおいてmemoruアプリケーション用のRealm、Client、Identity Providerを設定する。LINE連携を可能にするIdentity Provider設定を行い、PKCEによるセキュアな認証フローを実現する。設定はエクスポート可能なJSON形式で管理し、環境間の移行を容易にする。

## 依存タスク
- **前提タスク**: TASK-0001（Keycloak ECS/Fargate インフラ構築）
- **後続タスク**: TASK-0005（API Gateway + Lambda 基盤構築）

## 完了条件
- [ ] memoru Realm作成
- [ ] liff-client（public client）作成
- [ ] PKCE設定有効化
- [ ] LINE Identity Provider設定
- [ ] ユーザー作成・テスト

---

## 実装詳細

### 1. memoru Realm作成 🔵
**信頼性**: 🔵 *PRD第3章より*

memoruアプリケーション専用のRealmを作成する。

- **Realm名**: memoru
- **表示名**: Memoru - 暗記カードアプリ
- **有効化**: true
- **ユーザー登録**: 無効（LINE経由のみ）
- **パスワードリセット**: 無効
- **メール検証**: 無効
- **ログインテーマ**: keycloak（カスタム可）
- **デフォルトロール**: user
- **トークン設定**:
  - アクセストークン有効期間: 5分
  - リフレッシュトークン有効期間: 30日
  - SSO Session Idle: 30分
  - SSO Session Max: 10時間

**実装ファイル**: `infrastructure/keycloak/realm-export.json`

### 2. liff-client（Public Client）作成 🔵
**信頼性**: 🔵 *PRD第3章より*

LIFFアプリケーション用のOAuth2クライアントを作成する。

- **クライアントID**: liff-client
- **クライアントタイプ**: public
- **標準フロー有効**: true
- **ダイレクトアクセスグラント**: false
- **サービスアカウント有効**: false
- **有効なリダイレクトURI**:
  - https://liff.example.com/*
  - https://liff.line.me/{LIFF_ID}/*
  - http://localhost:3000/* （開発用）
- **Web Origins**:
  - https://liff.example.com
  - https://liff.line.me
  - http://localhost:3000
- **クライアントスコープ**: openid, profile, email

**実装ファイル**: `infrastructure/keycloak/realm-export.json`

### 3. PKCE設定有効化 🔵
**信頼性**: 🔵 *PRD第3章より*

Public Clientのセキュリティ強化のためPKCEを有効化する。

- **Proof Key for Code Exchange**: S256
- **クライアント認証**: なし（Public Client）
- **認証フロー**:
  - Authorization Code Flow with PKCE
  - code_challenge_method: S256
- **Advanced Settings**:
  - Proof Key for Code Exchange Code Challenge Method: S256

**実装ファイル**: `infrastructure/keycloak/realm-export.json`

### 4. LINE Identity Provider設定 🔵
**信頼性**: 🔵 *PRD第3章より*

LINE Loginを使用したソーシャルログインを設定する。

- **プロバイダー名**: line
- **プロバイダータイプ**: OpenID Connect v1.0
- **Authorization URL**: https://access.line.me/oauth2/v2.1/authorize
- **Token URL**: https://api.line.me/oauth2/v2.1/token
- **User Info URL**: https://api.line.me/v2/profile
- **Client ID**: ${LINE_CHANNEL_ID}（環境変数）
- **Client Secret**: ${LINE_CHANNEL_SECRET}（環境変数）
- **スコープ**: profile openid
- **User ID属性**: sub
- **ユーザー名属性**: displayName
- **First Broker Login**: first broker login
- **同期モード**: import
- **属性マッピング**:
  - sub → line_user_id（カスタム属性）
  - displayName → firstName
  - pictureUrl → picture

**実装ファイル**: `infrastructure/keycloak/realm-export.json`

### 5. ユーザー属性・マッパー設定 🔵
**信頼性**: 🔵 *PRD第3章より*

トークンに含める属性とマッパーを設定する。

- **ユーザー属性**:
  - line_user_id: LINE User ID
  - picture: プロフィール画像URL
- **プロトコルマッパー**:
  - line_user_id → line_user_id（トークンクレーム）
  - picture → picture（トークンクレーム）
- **クライアントスコープ**:
  - memoru-scope: カスタムスコープ（line_user_id含む）

**実装ファイル**: `infrastructure/keycloak/realm-export.json`

### 6. テストユーザー作成・検証 🔵
**信頼性**: 🔵 *PRD第3章より*

開発・テスト用のユーザーを作成し、認証フローを検証する。

- **テストユーザー**:
  - ユーザー名: test-user
  - メール: test@example.com
  - 属性: line_user_id=U1234567890abcdef
  - ロール: user
- **検証項目**:
  - 認証コード取得
  - トークン交換（PKCE）
  - ユーザー情報取得
  - トークンリフレッシュ
  - ログアウト

**実装ファイル**: `infrastructure/keycloak/test-users.json`

---

## 実装手順

### DIRECTタスクの場合
1. `/tsumiki:direct-setup` - 直接実装・設定
   - Keycloak管理コンソールにログイン
   - Realm作成
   - Client作成・設定
   - Identity Provider設定
   - マッパー設定
   - Realm設定エクスポート
2. `/tsumiki:direct-verify` - 動作確認・品質確認
   - テストユーザーでログイン
   - PKCE認証フロー確認
   - トークン内容確認
   - LINE IdP連携確認（可能な場合）

---

## 注意事項
- LINE Channel IDとSecretは環境変数またはSecrets Managerで管理すること
- Realm設定のエクスポートにはSecretが含まれないため、別途管理が必要
- PKCEのcode_verifierは43〜128文字のランダム文字列を使用すること
- LINE IdPの設定にはLINE Developersコンソールでの事前設定が必要
- リダイレクトURIはLINE Developers側とKeycloak側で完全一致させること
- 本番環境ではテストユーザーを削除または無効化すること

---

## 信頼性レベルサマリー
- 🔵 **青信号**: 6項目
- 🟡 **黄信号**: 0項目
- 🔴 **赤信号**: 0項目

**品質評価**: 高品質
