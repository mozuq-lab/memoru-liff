import { describe, it, expect, vi, beforeEach } from 'vitest';

// ã€ãƒ†ã‚¹ãƒˆç›®çš„ã€‘: OIDCè¨­å®šãŒç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ­£ã—ãç”Ÿæˆã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
// ã€ãƒ†ã‚¹ãƒˆå†…å®¹ã€‘: oidcConfigã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒæœŸå¾…é€šã‚Šã«è¨­å®šã•ã‚Œã‚‹ã“ã¨
// ã€æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œã€‘: Keycloak OIDCæŽ¥ç¶šã«å¿…è¦ãªè¨­å®šãŒæ­£ã—ãæ§‹æˆã•ã‚Œã‚‹
// ðŸ”µ é’ä¿¡å·: è¦ä»¶å®šç¾©2.1å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«åŸºã¥ã

describe('oidcConfig', () => {
  // ã€ãƒ†ã‚¹ãƒˆå‰æº–å‚™ã€‘: å„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰ã«ç’°å¢ƒã‚’ãƒªã‚»ãƒƒãƒˆ
  // ã€ç’°å¢ƒåˆæœŸåŒ–ã€‘: ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ã‚¯ãƒªã‚¢ã—ã¦ç‹¬ç«‹ã—ãŸãƒ†ã‚¹ãƒˆã‚’ä¿è¨¼
  beforeEach(() => {
    vi.resetModules();
  });

  describe('TC-001: OIDCè¨­å®šæ­£å¸¸ç”Ÿæˆ', () => {
    it('ç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ­£ã—ã„OIDCè¨­å®šãŒç”Ÿæˆã•ã‚Œã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç’°å¢ƒå¤‰æ•°ã‚’ãƒ¢ãƒƒã‚¯è¨­å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: KeycloakæŽ¥ç¶šã«å¿…è¦ãªç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹
      vi.stubEnv('VITE_KEYCLOAK_URL', 'https://keycloak.example.com');
      vi.stubEnv('VITE_KEYCLOAK_REALM', 'memoru');
      vi.stubEnv('VITE_KEYCLOAK_CLIENT_ID', 'memoru-liff');

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: oidcConfigã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦è¨­å®šã‚’å–å¾—
      // ã€å‡¦ç†å†…å®¹ã€‘: ç’°å¢ƒå¤‰æ•°ã‹ã‚‰OIDCè¨­å®šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’æ§‹ç¯‰
      const { oidcConfig } = await import('@/config/oidc');

      // ã€çµæžœæ¤œè¨¼ã€‘: å„è¨­å®šå€¤ãŒæœŸå¾…é€šã‚Šã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€æœŸå¾…å€¤ç¢ºèªã€‘: PKCEèªè¨¼ã«å¿…è¦ãªã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒå«ã¾ã‚Œã¦ã„ã‚‹

      // ã€æ¤œè¨¼é …ç›®ã€‘: authority URLãŒæ­£ã—ãæ§‹æˆã•ã‚Œã¦ã„ã‚‹
      // ðŸ”µ é’ä¿¡å·: Keycloak OIDCæ¨™æº–ã®URLå½¢å¼
      expect(oidcConfig.authority).toBe('https://keycloak.example.com/realms/memoru');

      // ã€æ¤œè¨¼é …ç›®ã€‘: client_idãŒç’°å¢ƒå¤‰æ•°ã‹ã‚‰æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
      // ðŸ”µ é’ä¿¡å·: è¦ä»¶å®šç¾©ã®å…¥åŠ›ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ä»•æ§˜
      expect(oidcConfig.client_id).toBe('memoru-liff');

      // ã€æ¤œè¨¼é …ç›®ã€‘: redirect_uriãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹
      // ðŸ”µ é’ä¿¡å·: OIDCèªè¨¼ãƒ•ãƒ­ãƒ¼ã®æ¨™æº–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
      expect(oidcConfig.redirect_uri).toBe('http://localhost:3000/callback');

      // ã€æ¤œè¨¼é …ç›®ã€‘: response_typeãŒcodeã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ï¼ˆPKCEç”¨ï¼‰
      // ðŸ”µ é’ä¿¡å·: Authorization Code + PKCE ãƒ•ãƒ­ãƒ¼ã®ä»•æ§˜
      expect(oidcConfig.response_type).toBe('code');

      // ã€æ¤œè¨¼é …ç›®ã€‘: scopeãŒå¿…è¦ãªã‚¹ã‚³ãƒ¼ãƒ—ã‚’å«ã‚“ã§ã„ã‚‹
      // ðŸ”µ é’ä¿¡å·: OpenID Connectæ¨™æº–ã‚¹ã‚³ãƒ¼ãƒ—
      expect(oidcConfig.scope).toBe('openid profile email');

      // ã€æ¤œè¨¼é …ç›®ã€‘: è‡ªå‹•ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãŒæœ‰åŠ¹
      // ðŸ”µ é’ä¿¡å·: è¦ä»¶å®šç¾©3.1ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è¦ä»¶
      expect(oidcConfig.automaticSilentRenew).toBe(true);
    });
  });

  describe('TC-023: ç’°å¢ƒå¤‰æ•°æœªè¨­å®šã‚¨ãƒ©ãƒ¼', () => {
    it('å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒæœªè¨­å®šã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç’°å¢ƒå¤‰æ•°ã‚’undefinedã«è¨­å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: å¿…é ˆç’°å¢ƒå¤‰æ•°ãŒå­˜åœ¨ã—ãªã„çŠ¶æ…‹
      vi.stubEnv('VITE_KEYCLOAK_URL', '');

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: oidcConfigã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€å‡¦ç†å†…å®¹ã€‘: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ãŒæœªè¨­å®šã‚’æ¤œå‡º
      // ðŸŸ¡ é»„ä¿¡å·: è¦ä»¶å®šç¾©ã‹ã‚‰æŽ¨æ¸¬ã—ãŸãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³è¦ä»¶
      await expect(async () => {
        const { validateOidcConfig } = await import('@/config/oidc');
        validateOidcConfig();
      }).rejects.toThrow();
    });
  });

  describe('TC-024: ç’°å¢ƒå¤‰æ•°ç©ºæ–‡å­—åˆ—ã‚¨ãƒ©ãƒ¼', () => {
    it('ç’°å¢ƒå¤‰æ•°ãŒç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼ã‚’ã‚¹ãƒ­ãƒ¼ã™ã‚‹', async () => {
      // ã€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã€‘: ç’°å¢ƒå¤‰æ•°ã‚’ç©ºæ–‡å­—åˆ—ã«è¨­å®š
      // ã€åˆæœŸæ¡ä»¶è¨­å®šã€‘: è¨­å®šã¯ã‚ã‚‹ãŒå€¤ãŒç©ºã®çŠ¶æ…‹
      vi.stubEnv('VITE_KEYCLOAK_CLIENT_ID', '');

      // ã€å®Ÿéš›ã®å‡¦ç†å®Ÿè¡Œã€‘: ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã“ã¨ã‚’ç¢ºèª
      // ã€å‡¦ç†å†…å®¹ã€‘: ç©ºæ–‡å­—åˆ—ã‚’ä¸æ­£å€¤ã¨ã—ã¦æ¤œå‡º
      // ðŸŸ¡ é»„ä¿¡å·: å…¥åŠ›ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
      await expect(async () => {
        const { validateOidcConfig } = await import('@/config/oidc');
        validateOidcConfig();
      }).rejects.toThrow();
    });
  });
});
